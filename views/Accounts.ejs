<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account Dashboard</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
      color: white;
      padding: 0;
      box-shadow: 0 0 25px rgba(44, 62, 80, 0.2);
      position: fixed;
      top: 0;
      left: -100vw;
      height: 100vh;
      overflow-y: auto;
      z-index: 10;
      flex-shrink: 0;
      transition: left 0.3s ease;
    }
    tr{
      border-left:1px solid #c7d2fe;
      border-right: 1px solid #c7d2fe;
    }
    th {
  white-space: nowrap;
  border-right: 1px solid #ddd;
  padding-right: 10px;
}

td{
  font-style: "Times New Roman", Times, serif;
  font-weight: bold;
 
}
    .sidebar.show {
      left: 0;
    }
    .sidebar::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      z-index: -1;
    }
    .logo {
      padding: 20px 10px 20px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      background: rgba(44, 62, 80, 0.3);
      position: relative;
    }
    .sidebar-close {
      display: block;
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .logo img {
      max-width: 180px;
      height: auto;
      border-radius: 8px;
    }
    .menu {
      list-style: none;
      padding: 0 15px;
    }
    .menu-heading {
      padding: 16px 20px 8px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 15px;
    }
    .menu-item {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 12px;
      margin-bottom: 8px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
      color: #bdc3c7;
    }
    .menu-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: all 0.5s ease;
    }
    .menu-item:hover::before {
      left: 100%;
    }
    .menu-item:hover, .menu-item.active {
      background-color: rgba(52, 152, 219, 0.6);
      color: white;
      transform: translateX(5px);
    }
    .menu-item i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }
    body {
    font-family: 'Inter', sans-serif;
    background: #f8fafc;
    color: #1e293b;
    margin: 0;
    padding: 0;
    }

/* Navbar */
.navbar {
  background: rgba(30, 64, 175, 0.9);
  backdrop-filter: blur(12px);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 28px;
  border-bottom: 2px solid rgba(255,255,255,0.2);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.navbar img {
  width: 150px;
  height: 150px;
  
  
}
.navbar h2 {
  font-size: 22px;
  font-weight: 600;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 35px;
  padding-bottom: 20px;
  border-bottom: 1px solid #e2e8f0;
}
.header-logo {
  height: 60px;
  width: auto;
  margin-right: 15px;
}
.header h2 {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(90deg, #0e1829, #1d4ed8);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  color: transparent;
}
.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  background: white;
  padding: 8px 16px;
  border-radius: 50px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}
.logout-btn {
  background: none;
  border: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
  font-weight: bolder;
  padding: 5px;
  border-radius: 5px;
  transition: background 0.3s;
}
.logout-btn:hover {
  background: rgba(231, 76, 60, 0.1);
}
.user-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
}
.project-entry-details {
  margin: 20px;
}
.project-table {
  width: 100%;
  border-collapse: collapse;
}
.project-table th, .project-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

/* Main Container */
.main-container {
  max-width:1700px;
  margin: 50px auto;
  padding: 25px;
  background: rgba(255,255,255,0.8);
  border-radius: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #1e40af;
  font-size: 28px;
  margin-bottom: 35px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* Search Input & Buttons */
#poSearch {
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  padding: 8px 12px;
  outline: none;
  transition: all 0.2s ease;
}
#poSearch:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 6px rgba(59,130,246,0.4);
}
button {
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  margin-right: 5px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
}
button:hover {
  transform: translateY(-2px);
}

/* Table */
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 10px;
  overflow: hidden;
}
thead {
  background: linear-gradient(135deg, #2563eb, #3b82f6);
  color: white;
}

th, td {
  padding: 10px 15px;
  text-align: center;
  border-bottom: 1px solid #c7d2fe; /* light indigo */
  border-right: 1px solid #c7d2fe;
}
th {
  background-color: rgb(46, 46, 240);
  font-weight: 600;
}

th:last-child,
td:last-child {
  border-right: none;
}

tbody tr:hover {
  background-color: #f9fafb;
}

/* Container */
.container {
  display: flex;
  flex-wrap: wrap;
  
  min-width: 100vw;
  
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  min-height: 100vh;
  overflow-x: hidden;


  
}

/* Main Content */
.main-content {
  flex: 1;
  padding: 30px;
  margin-left: 0;
  overflow-y: auto;
  background: #f8fafc;
}

/* Hamburger */
.hamburger {
  display: block;
  background: none;
  border: none;
  font-size: 30px;
  color: #2c3e50;
  cursor: pointer;
  padding: 10px;
  
}

/* Buttons */
.logout-btn {
  background: none;
  border: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
  font-weight: bolder;
  padding: 5px;
  border-radius: 5px;
  transition: background 0.3s;
}
.logout-btn:hover {
  background: rgba(231, 76, 60, 0.1);
}

.pay-btn { background: #22c55e; color: white; }
.pay-btn:hover { background: #16a34a; }

.paid-btn { background: #3b82f6; color: white; }
.paid-btn:hover { background: #2563eb; }

.download-btn { background: #14b8a6; color: white; }
.download-btn:hover { background: #0d9488; }

.email-btn { background: #fbbf24; color: black; }
.email-btn:hover { background: #f59e0b; }
.email-sent { background: #22c55e; color: white; }

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(18px);
  padding: 30px;
  border-radius: 18px;
  width: 450px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  text-align: center;
  animation: slideIn 0.4s ease;
}
.modal-content h2 {
  color: #1e40af;
  font-size: 22px;
  margin-bottom: 20px;
  font-weight: 600;
}
.close-btn {
  background: #ef4444;
  color: white;
  margin-top: 15px;
}
.close-btn:hover { background: #dc2626; }

/* Popups */
.done-popup, .error-popup {
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  animation: fadeInOut 3s ease forwards;
}
.done-popup { background: #16a34a; color: white; }
.error-popup { background: #dc2626; color: white; }

@keyframes slideIn {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(-10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; }
  100% { opacity: 0; transform: translateY(-10px); }
}
input,
select {
  width: 100%;
  max-width: 100%;
}
*,
*::before,
*::after {
  box-sizing: border-box;
}
.form-col {
  width: 100%;
  min-width: 0; /* CRITICAL for grid */
  display: flex;
  flex-direction: column;
}



/* Form Styles */
.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 20px;
  width: 100%;
  margin-bottom: 25px;
}


.form-section {
  margin-bottom: 35px;
  border: 1px solid #e2e2e2;
  border-radius: 10px;
  padding: 22px;
  background: #fafafa;
}
.section-title {
  margin-bottom: 20px;
  font-size: 20px;
  font-weight: 600;
  color: #333;
  border-left: 5px solid #007bff;
  padding-left: 12px;
}
label {
  font-size: 14px;
  font-weight: 500;
  color: #333;
  margin-bottom: 6px;
  display: block;
}
input, select {
  width: 100%;
  padding: 10px 12px;
  font-size: 15px;
  border: 1px solid #c9c9c9;
  border-radius: 6px;
  outline: none;
  transition: 0.25s;
  background: #fff;
}
input:focus, select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}
.btn {
  cursor: pointer;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 12px;
  border: none;
  transition: 0.25s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.btn-primary {
  background: #007bff;
  color: white;
}
.btn-primary:hover {
  background: #0069d9;
  transform: translateY(-1px);
}
.btn-secondary {
  background: #6c757d;
  color: white;
}
.btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-1px);
}
.btn-lg {
  padding: 12px 24px;
  font-size: 16px;
}
.form-actions {
  margin-top: 30px;
  text-align: center;
}


  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <button class="sidebar-close">&times;</button>
        <img src="images/page_logo.jpg" alt="Company Logo">
      </div>
      <ul class="menu">
        <li class="menu-heading">Accounts</li>
        <li class="menu-item active" onclick="switchTab('accounts')">
          <i class="fas fa-calculator"></i> Account Dashboard
        </li>
        <li class="menu-item" onclick="switchTab('project_details')"><i class="fas fa-cogs"></i> Project Details</li>
        <li class="menu-item" onclick="switchTab('view_projects')"><i class="fas fa-eye"></i> View Projects</li>
        <li class="menu-item logout">
          <form action="/logout" method="post">
            <i class="fas fa-sign-out-alt"></i>
            <button type="submit" style="background:none;border:none;color:inherit;cursor:pointer;">
              Logout
            </button>
          </form>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="header">
    <div style="display: flex; align-items: center;">
        <button class="hamburger">
          <i class="fas fa-bars"></i>
        </button>
        <img src="images/page_logo.jpg" alt="Company Logo" class="header-logo">
        <h2>Account Dashboard</h2>
      </div>
    <div class="user-info">
      <div class="user-avatar">AC</div>
      <span id="username">accounts@kietsindia.com</span>
      <button onclick="logout()" class="logout-btn" title="Logout">Logout
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>

      <!-- Main Container -->
      <div class="main-container" id="accountsTab">
        <h1>Account Dashboard</h1>
        <!-- <div style="margin-bottom: 20px;">
          <label for="poSearch">Search by PO Number:</label>
          <input type="text" id="poSearch" placeholder="Enter PO Number" style="margin-left: 10px; padding: 5px;">
          <button onclick="searchByPO()" style="margin-left: 10px; padding: 5px 10px;">Search</button>
          <button onclick="clearSearch()" style="margin-left: 10px; padding: 5px 10px;">Clear</button>
        </div> -->
        <table>
          <thead>
            <tr>
              <th>PO Number</th>
              <th>Supplier</th>
              <th>Amount to Pay</th>
              <th>Terms to Pay</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="accountTableBody">
            <!-- Data will be populated here -->
          </tbody>
        </table>
        <div id="noDataMessage" style="text-align: center; margin-top: 20px; display: none;">
          No payment details found.
        </div>
      </div>

  <!-- Modal -->
  <div class="modal" id="paymentModal">
    <div class="modal-content">
      <h2>Supplier Bank Details</h2>
      <div class="bank-details" id="bankDetails"></div>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Payment Done Popup -->
  <div class="done-popup" id="donePopup">
    ‚úÖ Payment Done Successfully!
  </div>

  <!-- Error Popup -->
  <div class="error-popup" id="errorPopup">
    ‚ùå Error processing payment
  </div>

  <!-- Project Details Tab Content -->
  <div id="project_detailsTab" class="tab-content" style="display: none;">
    <div class="main-container">
      <h1>Project Details Entry</h1>
      <form id="projectDetailsForm">
        <div class="form-section">
          <h2 class="section-title">üìã Project Information</h2>
          <div class="form-row">
            <div class="form-col">
              <label for="description">Description *</label>
              <input type="text" id="description" name="description" required placeholder="Enter project description">
            </div>
            <div class="form-col">
              <label for="projectCode">Project Code *</label>
              <input type="text" id="projectCode" name="projectCode" required placeholder="Enter project code">
            </div>
            <div class="form-col">
              <label for="quantity">Quantity *</label>
              <input type="number" id="quantity" name="quantity" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="form-col">
              <label for="customer">Customer *</label>
              <input type="text" id="customer" name="customer" required placeholder="Enter customer name">
            </div>
          </div>
          <div class="form-row">
            <div class="form-col">
              <label for="userName">User Name *</label>
              <input type="text" id="userName" name="userName" required placeholder="Enter user name">
            </div>
            <div class="form-col">
              <label for="currency">Currency *</label>
              <select id="currency" name="currency" required>
                <option value="">Select Currency</option>
                <option value="‚Çπ">INR (‚Çπ)</option>
                <option value="$">USD ($)</option>
                <option value="‚Ç¨">EUR (‚Ç¨)</option>
              </select>
            </div>

          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">üìÑ Purchase Order Information</h2>
          <div class="form-row">
            <div class="form-col">
              <label for="poNo">PO No *</label>
              <input type="text" id="poNo" name="poNo" required placeholder="Enter PO number">
            </div>
            <div class="form-col">
              <label for="poDate">PO Date *</label>
              <input type="date" id="poDate" name="poDate" required>
            </div>
            <div class="form-col">
              <label for="valuePerUnit">Value Per Unit (‚Çπ) *</label>
              <input type="number" id="valuePerUnit" name="valuePerUnit" step="0.01" min="0" required placeholder="0.00">
            </div>
            <div class="form-col">
              <label for="totalPoValuePending">Total PO Value Pending (‚Çπ)</label>
              <input type="number" id="totalPoValuePending" name="totalPoValuePending" step="0.01" readonly placeholder="Auto-calculated">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">üöö Delivery Information</h2>
          <div class="form-row">
            <div class="form-col">
              <label for="deliveryStatus">Delivery Status *</label>
              <select id="deliveryStatus" name="deliveryStatus" required>
                <option value="">Select Status</option>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Delayed">Delayed</option>
              </select>
            </div>
            <div class="form-col">
              <label for="deliveryDate">Delivery Date</label>
              <input type="date" id="deliveryDate" name="deliveryDate">
            </div>
            <div class="form-col">
              <label for="invType">INV Type</label>
              <input type="text" id="invType" name="invType" placeholder="Enter invoice type">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">üí∞ Invoice Information</h2>
          <div class="form-row">
            <div class="form-col">
              <label for="invoiceNo">Invoice No</label>
              <input type="text" id="invoiceNo" name="invoiceNo" placeholder="Enter invoice number">
            </div>
            <div class="form-col">
              <label for="invoiceDate">Invoice Date</label>
              <input type="date" id="invoiceDate" name="invoiceDate">
            </div>
            <div class="form-col">
              <label for="baseValue">Base Value (‚Çπ)</label>
              <input type="number" id="baseValue" name="baseValue" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-col">
              <label for="totalValue">Total Value (‚Çπ)</label>
              <input type="number" id="totalValue" name="totalValue" step="0.01" min="0" placeholder="0.00">
            </div>
          </div>
        </div>

        <div class="form-actions" style="display: flex; justify-content: center; gap: 15px; margin-top: 30px;">
          <button type="submit" class="btn btn-primary btn-lg">üíæ Submit Project Details</button>
          <button type="button" class="btn btn-secondary btn-lg" onclick="resetProjectForm()">üîÑ Reset Form</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Projects Tab Content -->
  <div id="view_projectsTab" class="tab-content" style="display: none;">
    <div class="main-container">
      <h1>View Projects</h1>
      <div style="overflow-x: auto; width: 100%;">
        <table id="view_prj" style="min-width: 1200px;border-collapse: collapse">
          <thead>
            <tr style="font-size: small;">
              <th >Sl.No</th>
              <th >Description</th>
              <th >Project Code</th>
              <th>Quantity</th>
              <th>Customer</th>
              <th>User Name</th>
              <th>PO No</th>
              <th>PO Date</th>
              <th>Value Per Unit</th>
              <th>Total PO Value Pending</th>
              <th>Delivery Status</th>
              <th>Delivery Date</th>
              <th>INV Type</th>
              <th>Invoice No</th>
              <th>Invoice Date</th>
              <th>Base Value</th>
              <th>Total Value</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="projectsTableBody">
            <!-- Data will be populated here -->
          </tbody>
        </table>
      </div>
      <div id="noProjectsMessage" style="text-align: center; margin-top: 20px; display: none;">
        No project details found.
      </div>
    </div>
  </div>
</div>
</div>

<script>
    let accountData = [];
    let currentOrderId = null;

    async function fetchAccountDetails(poNumber = '') {
      try {
        document.getElementById('noDataMessage').style.display = 'none';
        
        let url = '/api/account-details';
        if (poNumber) {
          url += `?po_number=${encodeURIComponent(poNumber)}`;
        }
        
        const response = await fetch(url, { credentials: 'include' });
        
        if (response.status === 401) {
          alert('You are not logged in. Redirecting to login page.');
          window.location.href = '/';
          return;
        }
        
        if (!response.ok) {
          throw new Error('Failed to fetch account details');
        }
        
        const data = await response.json();
        
        if (data.message) {
          document.getElementById('noDataMessage').style.display = 'block';
          accountData = [];
          populateTable();
          return;
        }
        
        accountData = data;
        populateTable();
      } catch (error) {
        console.error('Error fetching account details:', error);
        document.getElementById('noDataMessage').style.display = 'block';
        accountData = [];
        populateTable();
      }
    }

    function searchByPO() {
      const poNumber = document.getElementById('poSearch').value.trim();
      fetchAccountDetails(poNumber);
    }

    function clearSearch() {
      document.getElementById('poSearch').value = '';
      fetchAccountDetails();
    }

    function populateTable() {
      const tbody = document.getElementById('accountTableBody');
      tbody.innerHTML = '';
      
      if (accountData.length === 0) {
        document.getElementById('noDataMessage').style.display = 'block';
        return;
      }
      
      document.getElementById('noDataMessage').style.display = 'none';
      
      accountData.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'account-row';

        // PO Number
        const poNumberTd = document.createElement('td');
        poNumberTd.setAttribute('data-label', 'PO Number');
        poNumberTd.textContent = item.po_number || 'N/A';
        tr.appendChild(poNumberTd);

        // Supplier
        const supplierTd = document.createElement('td');
        supplierTd.setAttribute('data-label', 'Supplier');
        supplierTd.textContent = item.supplier_name || 'N/A';
        tr.appendChild(supplierTd);

        // Amount
        const amountTd = document.createElement('td');
        amountTd.setAttribute('data-label', 'Amount to Pay');
        amountTd.textContent = `‚Çπ${item.amount ? parseFloat(item.amount).toFixed(2) : '0.00'}`;
        tr.appendChild(amountTd);

        // Terms
        const termsTd = document.createElement('td');
        termsTd.setAttribute('data-label', 'Terms to Pay');
        termsTd.textContent = item.terms_of_payment || 'N/A';
        tr.appendChild(termsTd);

        // Action buttons
        const actionTd = document.createElement('td');
        actionTd.setAttribute('data-label', 'Action');

        // Pay button
        const payBtn = document.createElement('button');
        payBtn.className = 'pay-btn';
        payBtn.textContent = 'View Bank Details';
        payBtn.onclick = () => openModal(item);
        actionTd.appendChild(payBtn);

        // Paid button
        const paidBtn = document.createElement('button');
        paidBtn.className = 'paid-btn';
        paidBtn.textContent = 'Mark as Paid';
        paidBtn.onclick = () => {
          if (confirm('Are you sure you want to mark this as paid?')) {
            markAsPaid(item);
          }
        };
        actionTd.appendChild(paidBtn);

        // Download Invoice button
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'download-btn';
        downloadBtn.textContent = 'Download Invoice';
        downloadBtn.onclick = () => downloadInvoice(item.po_number);
        actionTd.appendChild(downloadBtn);

        // Send Email button
        const emailBtn = document.createElement('button');
        emailBtn.className = 'email-btn';
        emailBtn.textContent = 'Send Email';
        emailBtn.onclick = () => {
          if (confirm('Send email to requested by email?')) {
            sendEmailRequest(item, emailBtn);
          }
        };
        actionTd.appendChild(emailBtn);

        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
    }

    function openModal(item) {
      if (!item) return;
      const info = {
        account: item.supplier_account_number || 'N/A',
        ifsc: item.supplier_ifsc_code || 'N/A',
        bank: item.supplier_account_name || 'N/A'
      };
      document.getElementById('bankDetails').innerHTML = `
        <p><strong>Supplier:</strong> ${item.supplier_name || 'N/A'}</p>
        <p><strong>Account Number:</strong> ${info.account}</p>
        <p><strong>IFSC Code:</strong> ${info.ifsc}</p>
        <p><strong>Bank Name:</strong> ${info.bank}</p>
      `;
      document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('paymentModal').style.display = 'none';
    }

    async function markAsPaid(item) {
  if (!item.id) {
    showError('Order ID not found');
    return;
  }

  try {
    const response = await fetch(`/api/orders/${item.id}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include',
      body: JSON.stringify({ status: 'paid' })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to update status');
    }

    const result = await response.json();

    if (result.success) {
      showSuccess();

      // ‚úÖ Remove from local data
      accountData = accountData.filter(order => order.id !== item.id);

      // ‚úÖ Refresh the table
      populateTable();
    } else {
      throw new Error('Status update failed');
    }
  } catch (error) {
    console.error('Error updating status:', error);
    showError(error.message || 'Error processing payment');
  }
}

    function removeOrderFromTable(orderId) {
      // Find and remove the table row containing this order
      const tableBody = document.getElementById('accountTableBody');
      const rows = tableBody.querySelectorAll('tr');

      rows.forEach(row => {
        // Check if this row contains the order with the matching ID
        // We need to find the row that has the order data matching this ID
        const actionCell = row.querySelector('td:last-child');
        if (actionCell) {
          const paidBtn = actionCell.querySelector('.paid-btn');
          if (paidBtn && paidBtn.onclick) {
            // Extract the item from the onclick function to check the ID
            const onclickString = paidBtn.onclick.toString();
            if (onclickString.includes(`item.id`) && onclickString.includes(orderId)) {
              row.remove();
              return;
            }
          }
        }
      });

      // Update the accountData array to remove this item
      accountData = accountData.filter(item => item.id !== orderId);

      // Check if table is now empty and show "no data" message if needed
      if (accountData.length === 0) {
        document.getElementById('noDataMessage').style.display = 'block';
      }
    }

    function showSuccess() {
      const popup = document.getElementById('donePopup');
      popup.style.display = 'block';
      setTimeout(() => { 
        popup.style.display = 'none'; 
      }, 3000);
    }
    
    function showError(message) {
      const popup = document.getElementById('errorPopup');
      popup.innerHTML = `‚ùå ${message}`;
      popup.style.display = 'block';
      setTimeout(() => { 
        popup.style.display = 'none'; 
      }, 3000);
    }

    function logout() {
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      })
      .then(() => {
        window.location.href = '/';
      })
      .catch(err => {
        console.error('Logout error:', err);
        window.location.href = '/';
      });
    }

    async function fetchProjectDetails() {
      try {
        document.getElementById('noProjectsMessage').style.display = 'none';

        const response = await fetch('/api/project-details_info', { credentials: 'include' });

        if (response.status === 401) {
          alert('You are not logged in. Redirecting to login page.');
          window.location.href = '/';
          return;
        }

        if (!response.ok) {
          throw new Error('Failed to fetch project details');
        }

        const data = await response.json();

        if (data.message) {
          document.getElementById('noProjectsMessage').style.display = 'block';
          populateProjectsTable([]);
          return;
        }

        populateProjectsTable(data);
      } catch (error) {
        console.error('Error fetching project details:', error);
        document.getElementById('noProjectsMessage').style.display = 'block';
        populateProjectsTable([]);
      }
    }

    function populateProjectsTable(data) {
      const tbody = document.getElementById('projectsTableBody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        document.getElementById('noProjectsMessage').style.display = 'block';
        return;
      }

      document.getElementById('noProjectsMessage').style.display = 'none';

      data.forEach(item => {
        const tr = document.createElement('tr');

        // Determine row color based on status
let rowStyles;
switch ((item.delivery_status || '').toLowerCase()) {
  case 'pending':
    // Soft Amber: Warm but not alarming
    rowStyles = 'background-color: #fffbeb; color: #92400e; border-bottom: 1px solid #fde68a;';
    break;
  case 'in progress':
    // Soft Blue: Focused and active
    rowStyles = 'background-color: #f0f9ff; color: #075985; border-bottom: 1px solid #bae6fd;';
    break;
  case 'completed':
    // Soft Emerald: Positive but professional (Replaced the "pure green")
    rowStyles = 'background-color: #f0fdf4; color: #166534; border-bottom: 1px solid #bbf7d0;';
    break;
  case 'delayed':
    // Soft Rose: Noticeable but not "Error-red"
    rowStyles = 'background-color: #fff1f2; color: #9f1239; border-bottom: 1px solid #fecdd3;';
    break;
  default:
    rowStyles = 'background-color: #ffffff; color: #374151; border-bottom: 1px solid #e5e7eb;';
}

tr.style = rowStyles;


console.log('Populating row for item:', item);
// Use it in your table row
tr.innerHTML = `
  <td style="border-left: 1px solid #c7d2fe;">${item.id || 'N/A'}</td>
  <td>${item.description || 'N/A'}</td>
  <td>${item.project_code || 'N/A'}</td>
  <td>${item.quantity || 'N/A'}</td>
  <td>${item.customer || 'N/A'}</td>
  <td>${item.user_name || 'N/A'}</td>
  <td>${item.po_no || 'N/A'}</td>
  <td>${new Date(item.po_date).toLocaleDateString('en-IN') || 'N/A'}</td>
  <td>${item.currency}${item.value_per_unit ? parseFloat(item.value_per_unit).toFixed(2) : '0.00'}</td>
  <td>‚Çπ${item.total_po_value_pending ? parseFloat(item.total_po_value_pending).toFixed(2) : '0.00'}</td>
  <td>${item.delivery_status || 'N/A'}</td>
  <td>${new Date(item.delivery_date).toLocaleDateString('en-IN') || 'N/A'}</td>
  <td>${item.inv_type || 'N/A'}</td>
<!-- Invoice No (editable text) -->
  <td contenteditable="true"
      data-field="invoice_no"
      style="background:#eef2ff;">
    ${item.invoice_no || ''}
  </td>

  <!-- Invoice Date (editable date) -->
  <td>
    <input type="date"
           data-field="invoice_date"
           value="${item.invoice_date ? item.invoice_date.split('T')[0] : ''}"
           style="background:#eef2ff;border:1px solid #c7d2fe;">
  </td>  
   
  <td style="white-space:no-wrap;">${item.currency}${item.base_value ? parseFloat(item.base_value).toFixed(2) : '0.00'}</td>
  <td>${item.currency}${item.total_value ? parseFloat(item.total_value).toFixed(2) : '0.00'}</td>

<td>
    <button class="btn btn-primary save-btn">Save</button>
  </td>  `;



        tbody.appendChild(tr);
      });
    }

    // Switch tab function
    function switchTab(tab) {
      // Hide all tab contents
      document.getElementById('accountsTab').style.display = 'none';
      document.getElementById('project_detailsTab').style.display = 'none';
      document.getElementById('view_projectsTab').style.display = 'none';

      // Update menu active state
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      if (tab === 'accounts') {
        document.querySelector('.menu-item[onclick*="accounts"]').classList.add('active');
        document.getElementById('accountsTab').style.display = 'block';
      } else if (tab === 'project_details') {
        document.querySelector('.menu-item[onclick*="project_details"]').classList.add('active');
        document.getElementById('project_detailsTab').style.display = 'block';
      } else if (tab === 'view_projects') {
        document.querySelector('.menu-item[onclick*="view_projects"]').classList.add('active');
        document.getElementById('view_projectsTab').style.display = 'block';
        fetchProjectDetails();
      }
    }

    // Project Details Form Interactivity
    function calculateTotalPO() {
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      const valuePerUnit = parseFloat(document.getElementById('valuePerUnit').value) || 0;
      const total = quantity * valuePerUnit;
      document.getElementById('totalPoValuePending').value = total.toFixed(2);
    }

    function resetProjectForm() {
      document.getElementById('projectDetailsForm').reset();
      calculateTotalPO(); // Reset calculation
    }

    // Add event listeners for auto-calculation
    document.getElementById('quantity').addEventListener('input', calculateTotalPO);
    document.getElementById('valuePerUnit').addEventListener('input', calculateTotalPO);

    // Form validation and submit
    document.getElementById('projectDetailsForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Basic validation
      const requiredFields = ['description', 'projectCode', 'quantity', 'customer', 'userName', 'poNo', 'poDate', 'valuePerUnit', 'deliveryStatus'];
      let isValid = true;

      requiredFields.forEach(field => {
        const element = document.getElementById(field);
        if (!element.value.trim()) {
          element.style.borderColor = 'red';
          isValid = false;
        } else {
          element.style.borderColor = '#c9c9c9';
        }
      });

      if (!isValid) {
        showError('Please fill in all required fields.');
        return;
      }

      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      console.log('Project Details Submitted:', data);

      // Simulate submission
      showSuccess('Project details submitted successfully!');
      this.reset();
      calculateTotalPO();
      const responsive=fetch('/api/project-details',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
        },
        credentials:'include',
        body:JSON.stringify(data)
      });
      responsive.then((res)=>{
        if(!res.ok){
          throw new Error('Failed to submit project details');
        }
        return res.json();
      }).then((result)=>{
        if(result.success){
          showSuccess('Project details submitted successfully!');
          this.reset();
          calculateTotalPO();
        }else{
          throw new Error('Submission failed');
        }
      }).catch((error)=>{
        console.error('Error submitting project details:',error);
        showError(error.message ||'Error submitting project details');
      });
    });

    function showSuccess(message) {
      const popup = document.getElementById('donePopup');
      popup.innerHTML = `‚úÖ ${message}`;
      popup.style.display = 'block';
      setTimeout(() => { popup.style.display = 'none'; }, 3000);
    }

    function showError(message) {
      const popup = document.getElementById('errorPopup');
      popup.innerHTML = `‚ùå ${message}`;
      popup.style.display = 'block';
      setTimeout(() => { popup.style.display = 'none'; }, 3000);
    }

   function downloadInvoice(poNumber) {
  window.location.href = `/api/inventory-invoice/${poNumber}`;
}

    async function sendEmailRequest(item, button) {
      if (!item.id) {
        showError('Order ID not found');
        return;
      }

      try {
        const response = await fetch(`/api/send-email/${item.id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({}) // Add any necessary data
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to send email');
        }

        const result = await response.json();

        if (result.success) {
          button.className = 'email-sent';
          button.textContent = 'Email Sent';
          button.disabled = true;
          showSuccess();
        } else {
          throw new Error('Email sending failed');
        }
      } catch (error) {
        console.error('Error sending email:', error);
        showError(error.message || 'Error sending email');
      }
    }

    // Toggle sidebar visibility
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.classList.toggle('show');
      }
    }

    // Add event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const hamburger = document.querySelector('.hamburger');
      const sidebarClose = document.querySelector('.sidebar-close');
      if (hamburger) {
        hamburger.addEventListener('click', toggleSidebar);
      }
      if (sidebarClose) {
        sidebarClose.addEventListener('click', toggleSidebar);
      }

      // Close sidebar when clicking outside
      document.addEventListener('click', function(event) {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar.classList.contains('show') && !sidebar.contains(event.target) && !hamburger.contains(event.target)) {
          toggleSidebar();
        }
      });

      fetchAccountDetails();
    });

    async function saveRow(updatedData) {
  try {
    const res = await fetch('/api/update-order', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });

    if (!res.ok) {
      throw new Error('Failed to update');
    }

    const result = await res.json();
    console.log(result);

  } catch (error) {
    console.error('Save failed:', error);
    alert('Failed to save invoice details ‚ùå');
  }
}

  const tbody = document.getElementById('projectsTableBody');
tbody.addEventListener('click', function (e) {
  if (!e.target.classList.contains('save-btn')) return;

  const tr = e.target.closest('tr');

  // Sl.No / ID (make sure first column contains ID)
  const id = tr.children[0].innerText.trim();

  const updatedData = { id };

  tr.querySelectorAll('[data-field]').forEach(el => {
    const field = el.dataset.field;

    updatedData[field] =
      el.tagName === 'INPUT' || el.tagName === 'SELECT'
        ? el.value
        : el.innerText.trim();
  });

  saveRow(updatedData);
  alert('Invoice details saved successfully! ‚úÖ');
});

  


    
  </script>
</body>
</html>
