<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management Dashboard</title>
    <link href="../public/images/logo.png" rel="icon" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
     
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
            height: 100vh;
            
        }
        #previewFrame {
    pointer-events: auto;
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.modal-box {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
}


/* Container for all cards */
#assignedProjectsContainer {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 20px;
}
#incompleteProjectsModal {
  display: none; /* hidden by default */
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.task-box {
  background: #f10a0a;
  color:white;
  padding: 20px;
  border-radius: 8px;
  max-width: 400px;
  text-align: center;
}


/* Individual project card */
.project-card {
  border: 1px solid #ccc;       /* Simple border */
  border-radius: 8px;           /* Slightly rounded corners */
  padding: 12px;
  width: 280px;                 /* Fixed width for consistency */
  background-color: #f9f9f9;   /* Light background */
}

.project-card {
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}

.project-card:hover {
  transform: translateY(-2px);
}

/* üü¢ Completed */
.card-completed {
  background-color: #22c55e;
  color: #ffffff;
}

/* üü° Not completed */
.card-pending {
  background-color: #fde047;
  color: #000000;
}

/* Card headings */
.project-card h4 {
  font-size: 16px;
  margin: 0 0 6px 0;
  color: #333;
}

/* Card paragraphs */
.project-card p {
  margin: 4px 0;
  font-size: 14px;
  color: #555;
}

/* Status badge */
.project-card .status {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 12px;
  color: #fff;
}

/* Simple status colors */
.status.pending { background-color: #f39c12; }    /* Orange */
.status.completed { background-color: #27ae60; }  /* Green */
.status.inprogress { background-color: #2980b9; } /* Blue */
.status.overdue { background-color: #c0392b; }    /* Red */



#previewModal {
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
}

        
  .container {
    display: flex;
    flex-wrap: wrap; /* <-- allows sidebar & content to stack */
    min-height: 100vh;
    width: 100%;
    overflow-x: hidden; /* avoid horizontal scroll */
}
.download-btn:disabled {
  background-color: #d9534f !important; /* red */
  border-color: #d43f3a !important;
  cursor: not-allowed;
  color: white !important;
}

.download-btn:disabled:hover {
  background-color: #d9534f !important;
  border-color: #d43f3a !important;
}
  
.download-btn:not(:disabled) {
  background-color: #28a745 !important; /* green */
  border-color: #218838 !important;
  color: white !important;
}
        /* Sidebar Styles - Enhanced */
        .sidebar {
    width: 260px;
    height: 100vh;
    background: linear-gradient(180deg, #0b1e3d, #081833);
    border-right: 1px solid var(--sidebar-border);
    display: flex;
    flex-direction: column;
    position: fixed;
    
}

        
        .sidebar::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            z-index: -1;
        }
        
        .logo {
            padding: 25px 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            background: rgba(30, 58, 138, 0.3);
        }
        
        .logo img {
            max-width: 150px;
            height: auto;
            filter: brightness(0) invert(1);
        }
        
        .menu {
            list-style: none;
            padding: 0 15px;
        }
        .menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    margin: 4px 10px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    color: white;
    cursor: pointer;
    transition: background 0.25s ease, color 0.25s ease;
}

.menu-item i {
    width: 18px;
    text-align: center;
    font-size: 14px;
    color: white;
}

.menu-item:hover {
    background: var(--menu-hover);
}

 /* Submenu container */
.submenu {
    list-style: none;
    padding: 8px;
    margin: 6px 0 0;
    position: relative;
    left: 45px;
    background-color: rgb(20, 29, 54);
    border-radius: 10px;

    /* Smooth animation */
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-8px);
    transition:
        max-height 0.35s ease,
        opacity 0.25s ease,
        transform 0.25s ease;
}


/* Open state */
.submenu.open {
    max-height: 500px;
    opacity: 1;
    transform: translateY(0);
}

/* Submenu items */
.submenu-item {
    padding: 12px 20px;
    cursor: pointer;
    border-radius: 12px;
    margin-bottom: 4px;
    font-weight: 400;
    font-size: 14px;
    color: rgb(247, 245, 245);
    white-space: nowrap;
    transition: background 0.25s ease, transform 0.25s ease;
}
.submenu-item:hover {
    background-color: rgba(255, 255, 255, 0.15);
    transform: translateX(6px);
}

/* Arrow animation */
.arrow {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.arrow.rotate {
    transform: rotate(180deg);
}

        /* Main Content Styles - Enhanced */
        .main-content {

            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f8fafc;
            margin-left: 260px; /* Width of sidebar */
            
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .header h2 {
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        background-clip: text;           /* Standard */
        -webkit-background-clip: text;   /* Safari & Chrome */
        -webkit-text-fill-color: transparent; /* Makes text transparent */
        color: transparent;              /* Fallback for browsers without support */
    }

        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.3);
        }
        
        /* Tab Content Styles - Enhanced */
        .tab-content {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.04);
            margin-bottom: 30px;
            border: 1px solid #f1f5f9;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .tab-header h3 {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .tab-header p {
            color: #64748b;
            font-size: 14px;
        }
        
        /* Form Styles - Enhanced */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #334155;
            font-size: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8fafc;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.25);
        }
        
        /* Status Tab Styles - Enhanced */
        .status-filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
        }

        .sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .sub-tab {
            padding: 10px 20px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .sub-tab.active {
            background: #3b82f6;
            color: white;
        }

        .sub-tab:hover {
            background: #e2e8f0;
        }

        .sub-tab.active:hover {
            background: #2563eb;
        }
        
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            align-items: stretch;
        }

        .status-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            border-left: 5px solid #3b82f6;
            position: relative;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .status-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2));
            transform: translateY(-100%);
            transition: all 0.5s ease;
        }

        .status-card:hover::after {
            transform: translateY(0);
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
        }

        .status-card.active {
            background: linear-gradient(135deg, #e0f7fa, #ffffff);
            border: 2px solid #3b82f6;
        }
        
        .status-card.pending {
            border-left-color: #f59e0b;
        }
        
        .status-card.approved {
            border-left-color: #10b981;
        }
        
        .status-card.rejected {
            border-left-color: #ef4444;
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
        }
        
        .status-header h4 {
            font-size: 18px;
            color: #1e293b;
            font-weight: 600;
            margin-right: 15px;
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-pending {
            background-color: #fffbeb;
            color: #f59e0b;
        }
        
        .badge-approved {
            background-color: #ecfdf5;
            color: #10b981;
        }
        
        .badge-rejected {
            background-color: #fef2f2;
            color: #ef4444;
        }
        
        .status-body {
            flex-grow: 1;
        }
        
        .status-body p {
            margin-bottom: 12px;
            color: #475569;
            display: flex;
            flex-wrap: wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .status-body strong {
            color: #334155;
            min-width: 120px;
            display: inline-block;
        }
        
        .status-footer {
            border-top: 1px solid #f1f5f9;
            padding-top: 16px;
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #64748b;
            font-size: 14px;
        }
        
        /* Order Tracking Visualization - Enhanced */
       .tracking-wrapper {
    position: relative;
    width: 100%;
    max-width: 950px;
    margin: 40px auto;
    padding: 30px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    border: 1px solid #f1f5f9;
}

.tracking-wrapper::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 60px;
    right: 60px;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    z-index: 1;
    transform: translateY(-50%);
}

#progressBar {
    position: absolute;
    top: 50%;
    left: 60px;
    height: 8px;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    border-radius: 4px;
    z-index: 2;
    transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(-50%);
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    width: 0; /* Start with 0 width */
}

.tracking-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    z-index: 3;
    padding: 0 30px;
}

.tracking-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
}

.step-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
    color: #94a3b8;
    font-size: 18px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 4;
}

.step-label {
    font-size: 14px;
    text-align: center;
    color: #64748b;
    font-weight: 500;
    transition: all 0.4s ease;
    margin-top: 8px;
}

/* Active and completed states */
.step-icon.active {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-color: #bfdbfe;
    transform: scale(1.15);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    animation: pulse 2s infinite;
}

.step-icon.completed {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border-color: #a7f3d0;
    transform: scale(1.1);
}

.step-icon.completed::after {
    content: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 22px;
    color: white;
    animation: checkmark 0.8s ease-in-out;
}

.step-label.active {
    color: #2563eb;
    font-weight: 600;
    transform: translateY(-2px);
}

.step-label.completed {
    color: #059669;
    font-weight: 600;
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .tracking-wrapper::before {
        left: 40px;
        right: 40px;
    }
    
    #progressBar {
        left: 40px;
    }
    
    .tracking-steps {
        padding: 0 20px;
    }
    
    .step-icon {
        width: 50px;
        height: 50px;
        font-size: 16px;
    }
    
    .step-label {
        font-size: 12px;
    }
}

@media (max-width: 768px) {
    .tracking-wrapper {
        overflow-x: auto; /* Allow horizontal scrolling on small screens */
        margin: 20px auto; /* Reduce margin on small screens */
        padding: 15px; /* Reduce padding on small screens */
    }

    .tracking-steps {
        min-width: 700px; /* Ensure all steps are visible when scrolling */
    }
}

        .step-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            border: 3px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: #94a3b8;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 4;
        }

        .step-icon.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-color: #bfdbfe;
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
            animation: pulse 2s infinite;
        }

        .step-icon.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #a7f3d0;
            transform: scale(1.1);
        }

        .step-icon.completed::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 22px;
            color: white;
            animation: checkmark 0.8s ease-in-out;
        }

        .step-label {
            font-size: 14px;
            text-align: center;
            color: #64748b;
            font-weight: 500;
            transition: all 0.4s ease;
            margin-top: 8px;
        }

        .step-label.active {
            color: #2563eb;
            font-weight: 600;
            transform: translateY(-2px);
        }

        .step-label.completed {
            color: #059669;
            font-weight: 600;
        }

        /* Enhanced animations */
        @keyframes pulse {
            0% { transform: scale(1.15); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); }
            50% { transform: scale(1.2); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.6); }
            100% { transform: scale(1.15); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); }
        }

        @keyframes checkmark {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 1; }
        }

        @keyframes slideIn {
            0% { transform: translateX(-20px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .tracking-step {
            animation: slideIn 0.6s ease-out;
        }

        .tracking-step:nth-child(1) { animation-delay: 0.1s; }
        .tracking-step:nth-child(2) { animation-delay: 0.2s; }
        .tracking-step:nth-child(3) { animation-delay: 0.3s; }
        .tracking-step:nth-child(4) { animation-delay: 0.4s; }
        .tracking-step:nth-child(5) { animation-delay: 0.5s; }
        
        /* Product Table Styles - Enhanced */
        .product-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .product-table th {
            background: linear-gradient(135deg, #4f9eec, #28538b);
            padding: 16px 15px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .product-table td {
            padding: 14px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            background: white;
        }
        
        .product-table tr:last-child td {
            border-bottom: none;
        }
        
        .product-table input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .product-table input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        
        .product-table .actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: #f8fafc;
            cursor: pointer;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        
        .priority-badge {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .priority-high {
            background-color: #fef2f2;
            color: #ef4444;
        }
        
        .priority-medium {
            background-color: #fffbeb;
            color: #f59e0b;
        }
        
        .priority-low {
            background-color: #ecfdf5;
            color: #10b981;
        }
        
        /* Checkbox and phone styles */
        .checky {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .checky label {
            margin: 0;
            font-weight: 600;
            color: #334155;
        }
        
        .chk {
            width: 20px;
            height: 20px;
            accent-color: #3b82f6;
        }
        
        #phone {
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
        }
        
        #phone:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        
        /* Responsive Styles */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            
            .status-cards {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 0;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .status-cards {
                grid-template-columns: 1fr;
            }
            
            .product-table {
                display: block;
                overflow-x: auto;
            }
            
            .tracking-wrapper {
                padding: 20px;
            }
            
            .tracking-wrapper::before {
                left: 40px;
                right: 40px;
            }
            
            #progressBar {
                left: 40px;
            }
            
            .tracking-steps {
                padding: 0 20px;
            }
            
            .step-icon {
                width: 50px;
                height: 50px;
            }
            
            .step-label {
                font-size: 12px;
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 20px;
            }
        
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        
            .user-info {
                align-self: flex-end;
            }
        
            .tab-content {
                padding: 20px;
            }
        
            .tracking-wrapper::before {
                left: 30px;
                right: 30px;
            }
        
            #progressBar {
                left: 30px;
            }
        
            .tracking-steps {
                padding: 0 10px;
            }
        
            .step-icon {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
        
            .step-label {
                font-size: 10px;
            }
        
            .status-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        
            .status-badge {
                align-self: flex-start;
            }
        
            .status-cards {
                gap: 15px; /* Reduce gap between status cards on small screens */
            }
        
            .status-card {
                padding: 16px; /* Reduce padding in status cards */
            }
        }
        
        /* Animation for order tracking */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Item Description Modal Styles */
        .popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%;
            max-width: 672px;
            padding: 24px;
            position: relative;
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .closeBtn {
            position: absolute;
            top: 12px;
            right: 12px;
            color: #6b7280;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .closeBtn:hover {
            color: #374151;
        }

        #mainHeading {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 16px;
            margin-bottom: 16px;
        }

        #mainHeading:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .subpointBox {
            margin-bottom: 16px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }

        .subTitle {
            display: block;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .subTitle:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .bulletsContainer {
            margin-bottom: 8px;
        }

        .bullet {
            display: block;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .bullet:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .addBulletBtn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .addBulletBtn:hover {
            background: #2563eb;
        }

        #addSubpointBtn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
        }

        #addSubpointBtn:hover {
            background: #059669;
        }

        #saveBtn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        #saveBtn:hover {
            background: #059669;
        }
        /* ... (all other CSS remains exactly the same) ... */

        /* Trade & Service Form Styles */
        .form-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .items-table th {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .items-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .items-table input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .attachment-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .attachment-row .form-group {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .required::after {
            content: ' *';
            color: #ef4444;
        }

        /* Enhanced Form Control Styles */
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group input[type="file"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background-color: #ffffff;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        /* VK Table Styles */
        .kiet-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            background: white;
            border: 1px solid #e2e8f0;
        }

        .kiet-table th {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 16px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 2px solid #1e40af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kiet-table td {
            padding: 14px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            background: white;
            font-size: 14px;
            color: #334155;
        }

        .kiet-table tr:last-child td {
            border-bottom: none;
        }

        .kiet-table tr:hover {
            background-color: #f8fafc;
        }

        .kiet-table input[type="text"],
        .kiet-table input[type="number"],
        .kiet-table textarea,
        .kiet-table select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background-color: #ffffff;
            box-sizing: border-box;
        }

        .kiet-table input[type="text"]:focus,
        .kiet-table input[type="number"]:focus,
        .kiet-table textarea:focus,
        .kiet-table select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: #f8fafc;
        }

        .kiet-table textarea {
            resize: vertical;
            min-height: 60px;
        }

        .kiet-table select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 35px;
        }

        .kiet-table .total-row {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            font-weight: 600;
            border-top: 2px solid #cbd5e1;
        }

        .kiet-table .total-row td {
            color: #1e293b;
            font-size: 15px;
        }

        .kiet-table .value-display {
            font-weight: 600;
            color: #059669;
            font-size: 14px;
        }

        .kiet-table .currency-symbol {
            color: #059669;
            font-weight: 600;
            margin-right: 2px;
        }

        /* Responsive table styles */
        @media (max-width: 768px) {
            .kiet-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .kiet-table th,
            .kiet-table td {
                padding: 10px 8px;
                font-size: 12px;
            }
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="tel"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="file"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: #f8fafc;
        }

        .form-group input[type="file"] {
            padding: 8px;
            cursor: pointer;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
        }

        .form-group select:hover {
            border-color: #9ca3af;
        }

        .form-group input:disabled,
        .form-group input[readonly] {
            background-color: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
        }

        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-overlay p {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }
.task-modal {
  position: fixed;
  inset: 0;
  background: rgba(17, 24, 39, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.task-box {
  background: #ffffff;
  padding: 28px;
  width: 420px;
  border-radius: 14px;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.35);
  animation: popIn 0.35s ease;
}

.task-box h2 {
  font-size: 22px;
  color: #111827;
  margin-bottom: 5px;
}

.task-box p {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 20px;
}

.form-group {
  text-align: left;
  margin-bottom: 14px;
}

.form-group label {
  display: block;
  font-size: 13px;
  color: #374151;
  margin-bottom: 4px;
  font-weight: 600;
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 9px 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 14px;
}

.form-group textarea {
  resize: none;
}

.task-box button {
  width: 100%;
  padding: 11px;
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

.task-box button:hover {
  opacity: 0.95;
}

@keyframes popIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
.creative-loader {
  position: fixed;
  inset: 0;
  backdrop-filter: blur(10px);
  background: rgba(15, 23, 42, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.hidden {
  display: none;
}

/* Card */
.loader-card {
  background: rgba(255, 255, 255, 0.15);
  padding: 40px 60px;
  border-radius: 20px;
  text-align: center;
  color: #fff;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

/* Ring */
.progress-ring {
  width: 70px;
  height: 70px;
  border: 6px solid rgba(255,255,255,0.2);
  border-top: 6px solid #38bdf8;
  border-radius: 50%;
  margin: 0 auto 20px;
  animation: spin 1.2s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Text animation */
.dots::after {
  content: '';
  animation: dots 1.5s steps(3, end) infinite;
}

@keyframes dots {
  0% { content: ''; }
  33% { content: '.'; }
  66% { content: '..'; }
  100% { content: '...'; }
}



    </style>
</head>
<body>
  <div id="loaderOverlay" class="creative-loader hidden">
  <div class="loader-card">
    <div class="progress-ring"></div>
    <h3 id="loaderText">Processing</h3>
    <span class="dots">.</span>
  </div>
</div>


    <!-- Task Popup -->
<!-- Task Popup -->
<div id="taskModal" class="task-modal">
  <div class="task-box">
    <h2>üìù Work Declaration</h2>
    <p>Please enter what you are going to work on.</p>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="userEmail" value="<%= user.email %>" disabled />
    </div>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="taskDate" disabled />
    </div>

    <div class="form-group">
      <label>Task Description</label>
      <textarea
        id="taskDesc"
        rows="4"
        placeholder="Example: Vendor follow-up, PO verification, cost comparison"
      ></textarea>
    </div>

    <button onclick="submitTask()">Submit</button>
  </div>
  <div id="incompleteProjectsModal" class="task-modal">
  <div class="task-box" style="background: red; ">
    <h2 style="color:white;">‚ö†Ô∏è Incomplete Assigned Projects</h2>
    <p style="color:white;">You have assigned projects that are not yet completed. Please review and complete them.</p>
    <button onclick="closeIncompleteProjectsModal()">Close</button>
  </div>
</div>
</div>

<!-- Incomplete Projects Popup -->




    <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">

    <!-- Logo -->
    <div class="logo">
        <img src="images/wt_img.png" alt="Company Logo" />
    </div>

    <!-- Section title -->
    

    <ul class="menu">

        <!-- Raise Order -->
        <li class="menu-item active" data-tab="raise-order">
            <i class="fas fa-plus-circle"></i>
            <span>Raise Order</span>
        </li>

        <!-- Quotation -->
        <li class="menu-item has-submenu">
            <i class="fas fa-file-alt"></i>
            <span>Quotation</span>
            <i class="fas fa-chevron-down arrow"></i>
        </li>
        <ul class="submenu">
            <li class="submenu-item" data-tab="trade-service">
                <i class="fas fa-handshake"></i>
                <span>Trade & Service</span>
            </li>
            <li class="submenu-item" data-tab="vk">
                <i class="fas fa-building"></i>
                <span>VK</span>
            </li>
            <li class="submenu-item" data-tab="mae">
                <i class="fas fa-cogs"></i>
                <span>MAE</span>
            </li>
        </ul>

        <!-- Delivery Challan -->
        <li class="menu-item" data-tab="delivery-challan">
            <i class="fas fa-truck"></i>
            <span>Delivery Challan</span>
        </li>

        <!-- Assigned Project -->
        <li class="menu-item" data-tab="assigned-project">
            <i class="fas fa-project-diagram"></i>
            <span>Assigned Project</span>
        </li>

        <!-- Approved & Status -->
        <li class="menu-item has-submenu">
            <i class="fas fa-check-circle"></i>
            <span>Approved & Status</span>
            <i class="fas fa-chevron-down arrow"></i>
        </li>
        <ul class="submenu">
            <li class="submenu-item" data-tab="statusContent">
                <i class="fas fa-tasks"></i>
                <span>Status(Purchase Order)</span>
            </li>
            <li class="submenu-item" data-tab="approved-quotation">
                <i class="fas fa-clipboard-check"></i>
                <span>Approved Quotation</span>
            </li>
        </ul>

        <!-- Logout -->
        <li class="menu-item" id="logout-btn" onclick="window.location.href='/'">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </li>

    </ul>
</div>
<script>
document.querySelectorAll(".has-submenu").forEach(menu => {
    menu.addEventListener("click", () => {
        const submenu = menu.nextElementSibling;
        const arrow = menu.querySelector(".arrow");

        if (!submenu || !submenu.classList.contains("submenu")) return;

        submenu.classList.toggle("open");
        arrow.classList.toggle("rotate");
    });
});
</script>


        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Order Management Dashboard</h2>
                <div class="user-info">
                    <div class="user-avatar"><% const out_fl1 = out_fl.slice(0, 2); %>
                        <%= out_fl1.toUpperCase() %></div>
                    
                    
                    <span><%= out_fl  %></span>
                </div>
            </div>
            
            <!-- Raise Order Tab -->
            <div class="tab-content active" id="raise-order">
                <div class="tab-header">
                    <h3>Raise New Order</h3>
                    <p>Fill in the details below to create a new order request</p>
                </div>
                

    <!-- Changed form to use FormData instead of JSON -->
    <form action="/order_raise" method="POST" id="orderForm" enctype="multipart/form-data">
  <div class="form-row">
    <div class="form-group">
      <label for="projectName">Project Name *</label>
      <input type="text" class="form-control" id="projectName" name="projectName" required placeholder="Enter Project Name">
    </div>
    <div class="form-group">
      <label for="projectCodeNumber">Project Code *</label>
      <input type="text" class="form-control" id="projectCodeNumber" name="projectCodeNumber" required placeholder="Enter Project Code">
    </div>
   
<div class="form-group d-flex align-items-center justify-content-start gap-2">
  <label for="projectBudget" class="mr-2 font-weight-bold">Project Budget:</label>
  
  <button id="budget_btn" type="button" class="btn btn-sm btn-primary">
    Know Budget
  </button>
  
  <span id="prjBudget" class="ml-3 text-info font-weight-bolder" style="color: black;"></span>
</div>


  </div>
  <div class="form-row">
     <div class="form-group">
                                        <label for="currency" class="required">Currency</label>
                                        <select id="currency" name="currency" required>
                                            <option value="">Select Currency</option>
                                            <option value="INR">INR</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                        <div class="error-message" id="currencyError">Please select a currency</div>
                                    </div>
  
    <div class="form-group">
      <label for="supplierName">Supplier Name </label>
      <input type="text" class="form-control" id="supplierName" name="supplierName" placeholder="Enter Supplier Name" >
    </div>
   
    <div class="form-group">
      <label for="supplierGst">Supplier GSTIN </label>
      <input type="text" class="form-control" id="supplierGst" name="supplierGst" placeholder="Enter Supplier GSTIN" >
    </div>
  </div>
  <div class="form-group">
    <label for="supplierAddress">Supplier Address </label>
    <textarea class="form-control" id="supplierAddress" name="supplierAddress" rows="2" placeholder="Enter Supplier Address" ></textarea>
  </div>

  <div class="form-group">
    <label for="shippingAddress">Shipping Address *</label>
    <textarea class="form-control" id="shippingAddress" name="shippingAddress" rows="2" required>KIET TECHNOLOGIES PVT.LTD ,51/33, Aaryan Techpark, 3rd cross, Bikasipura Main Rd, Vikram Nagar, Kumaraswamy Layout, Bengaluru - 560078</textarea>
  </div>
 <div class="form-row">
  <div class="form-group">
    <label for="reference_no">Ref number *</label>
    <input type="text" name="reference_no" id="referenceNumber" placeholder="Reference no." required>
  </div>

  <div class="form-group">
    <label for="termsOfPayment">Terms of Payment *</label>
    <input type="text" class="form-control" id="termsOfPayment" name="termsOfPayment" placeholder="e.g., 45 days net" required>
  </div>
  </div>
    <div class="checky">
      <label for="singleSupplier" style="font-weight: bold;">Single Supplier</label>
      <input type="checkbox" class="chk" id="singleSupplier" name="singleSupplier">
      <label for="contact" style="font-weight: bold;">Contact info</label>
      <input type="tel" id="phone" name="phone" placeholder="+91 -------------" pattern="[0-9]{10}">
    </div>
  

  <div class="form-row">
    <div class="form-group">
    <label for="quotation">Quotation*</label>
    <input type="file" name="quotation" id="quotation" required>
  </div>
    <div class="form-group">
      <label for="urgency">Urgency *</label>
      <select class="form-control" id="urgency" name="urgency" required>
        <option value="">Select Urgency</option>
        <option value="high">High - Immediate</option>
        <option value="medium">Medium - Soon</option>
        <option value="low">Low - Normal</option>
      </select>
    </div>
    <div class="form-group">
      <label for="dateRequired">Date Required *</label>
      <input type="date" class="form-control" id="dateRequired" name="dateRequired" required style="padding: 10px 15px;">
    </div>
  </div>

  <h4>Product Details</h4>
  <table class="product-table" id="productTable">
    <thead>
      <tr style="background-color: blue;">
        <th style="font-size:13px; padding: 11px; color:white;">Sl.</th>
        <th style="font-size:13px; padding: 11px; color:white;">Part No</th>
        <th style="font-size:13px; padding: 11px; color:white;">Description</th>
        <th style="font-size:13px; padding: 11px; color:white;">HSN Code</th>
        <th style="font-size:13px; padding: 11px; color:white;">Quantity</th>
        <th style="font-size:13px; padding: 11px; color:white;">Unit Price (‚Çπ)</th>
        <th style="font-size:13px; padding: 11px; color:white;">GST %</th>
        <th style="font-size:13px; padding: 11px; color:white;">Unit</th>
        <th style="font-size:13px; padding: 11px; color:white;">Discount(‚Çπ)</th>
        <th style="font-size:13px; padding: 11px; color:white;">Total (‚Çπ)</th>
        <th style="font-size:13px; padding: 11px; color:white;">Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr> <td>1</td>
          <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                <td><input type="text" class="form-control" name="description[]" placeholder="Product Description" required></td>
                <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code" ></td>
                <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                <td><input type="number" class="form-control unit-price" name="unitPrice[]" min="0" step="0.01" value="0" required></td>
                <td><input type="number" class="form-control gst-rate" name="gst[]" min="0" step="0.01" value="18" required></td>
                <td><input type='text' class="form-control unit" name="unit[]" placeholder='Unit' ></td>
                <td><input type="number" class="form-control discount" name="discount[]" min="0" step="1" value="0" required></td>
                <td class="total">0.00</td>  
   
        <td>
          <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="8" style="text-align:right; font-weight:bold;">Grand Total (‚Çπ):</td>
        <td id="grandTotal" style="font-weight:bold;">0.00</td>
        <td>
          <button type="button" class="btn" id="addProductRow"><i class="fas fa-plus"></i> Add</button>
        </td>
      </tr>
    </tfoot>
  </table>

  <div class="form-group">
    <label for="notes">Additional Notes</label>
    <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
  </div>

  <button type="submit" class="btn">
    <i class="fas fa-paper-plane"></i> Submit Order
  </button>
</form>
 <!-- Loader Overlay -->
    <div id="loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <p>Submitting Order...</p>
    </div>





            </div>

    <script>
document.getElementById("supplierName").addEventListener("blur", async function () {
      const supplier_name = this.value.trim();
      if (!supplier_name) return;

      try {
        const response = await fetch(`/supplier/${encodeURIComponent(supplier_name)}`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById("supplierAddress").value = data.supplier_address || "";
          document.getElementById("supplierGst").value = data.supplier_gst || "";
          document.getElementById("phone").value=data.contact|| "";
          alert("We found the Supplierü§© ")
        } else {
          alert("Supplier not found");
        }
      } catch (error) {
        console.error("Error fetching supplier:", error);
      }
    });

    document.getElementById("budget_btn").addEventListener("click", async function () {
      
      const project_code = document.getElementById("projectCodeNumber").value.trim();
      if ( !project_code) {
        alert("Please enter both Project Name and Project Code to know the budget.");
        return;
      }

      try {
        const response = await fetch(`/api/know_budget/${encodeURIComponent(project_code)}`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById("prjBudget").textContent = `Budget:‚Çπ ${data.budget || "Not Available"}`;
        } else {
          alert("Project not found");
        }
      } catch (error) {
        console.error("Error fetching project budget:", error);
      }
    });
    </script>  
     <div class="tab-content" id="delivery-challan">
                <div class="tab-header">
                    <h3>Create Delivery Challan</h3>
                    <p>Fill in the details below to create a delivery challan</p>
                </div>

                <form id="deliveryChallanForm" method="POST" action="/submit-delivery-challan">
                    <!-- Challan Information Section -->
                    <div class="form-section">
                        <h2 class="section-title">Delivery Challan Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="challanNumber" class="required">Challan Number</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="challanNumber" name="challanNumber" required readonly style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                    <button type="button" id="generateChallanNumber" class="btn btn-secondary">Generate</button>
                                </div>
                            </div>
                            <div class="form-group">
    <label for="dcType" class="required">DC Type</label>
    <select class="form-control" id="dcType" name="dcType" required>
        <option value="normal">Non ReturnableDC</option>
        <option value="returnable">Returnable DC</option>
    </select>
</div>

<div class="form-group" id="expiryContainer" style="display:none;">
    <label for="expiryDate" class="required">Expiry Date (For Returnable DC)</label>
    <input type="date" class="form-control" id="expiryDate" name="expiryDate">
</div>



                            
                            <div class="form-group">
                                <label for="deliveryDate" class="required">Delivery Date</label>
                                <input type="date" class="form-control" id="deliveryDate" name="deliveryDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                           
                            <div class="form-group">
                                <label for="vehicleNumber">Vehicle Number</label>
                                <input type="text" class="form-control" id="vehicleNumber" name="vehicleNumber" placeholder="Vehicle registration number">
                            </div>
                            <div class="form-group">
                                <label for="challanDate" class="required">Challan Date</label>
                                <input type="date" class="form-control" id="challanDate" name="challanDate" required>
                            </div>
                            <div class="form-group">
    <label for="managerEmail" class="required">Approver Email</label>
    <select class="form-control selectpicker" data-live-search="true" id="managerEmail" name="managerEmail" required>
  <option value="rajesh.km@kietsindia.com">rajesh.km@kietsindia.com</option>
  <option value="kumar.p@kietsindia.com">kumar.p@kietsindia.com</option>
  <option value="chandrashekaraiah.r@kietsindia.com">chandrashekaraiah.r@kietsindia.com</option>
  <option value="shashank@kietsindia.com">test</option>
</select>

</div>
                        </div>
                    </div>

                    <!-- Consignor Information Section -->
                    <div class="form-section">
                        <h2 class="section-title">Consignor Information (From)</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consignorName" class="required">Company Name</label>
                                <input type="text" class="form-control" id="consignorName" name="consignorName" required value="KIET TECHNOLOGIES PVT.LTD">
                            </div>
                            <div class="form-group">
                                <label for="consignorGST">GST Number</label>
                                <input type="text" class="form-control" id="consignorGST" name="consignorGST" placeholder="GST Number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="consignorAddress" class="required">Address</label>
                            <textarea class="form-control textarea-control" id="consignorAddress" name="consignorAddress" rows="3" required>51/33, Aaryan Techpark, 3rd cross, Bikasipura Main Rd, Vikram Nagar, Kumaraswamy Layout, Bengaluru - 560078</textarea>
                        </div>
                    </div>

                    <!-- Consignee Information Section -->
                    <div class="form-section">
                        <h2 class="section-title">Consignee Information (To)</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consigneeName" class="required">Company Name</label>
                                <input type="text" class="form-control" id="consigneeName" name="consigneeName" required placeholder="Customer company name">
                            </div>
                            <div class="form-group">
                                <label for="consigneeGST">GST Number</label>
                                <input type="text" class="form-control" id="consigneeGST" name="consigneeGST" placeholder="GST Number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="consigneeAddress" class="required">Delivery Address</label>
                            <textarea class="form-control textarea-control" id="consigneeAddress" name="consigneeAddress" rows="3" required placeholder="Complete delivery address"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="consigneeContact">Contact Person</label>
                                <input type="text" class="form-control" id="consigneeContact" name="consigneeContact" placeholder="Contact person name">
                            </div>
                            <div class="form-group">
                                <label for="consigneePhone">Phone Number</label>
                                <input type="tel" class="form-control" id="consigneePhone" name="consigneePhone" placeholder="+91 9876543210">
                            </div>
                        </div>
                    </div>

                    <!-- Item Details Section -->
                    <div class="form-section">
                        <h2 class="section-title">Item Details</h2>
                        <table class="product-table" id="itemTable">
                            <thead>
                                <tr>
                                    <th>SL No</th>
                                    <th>Part No</th>
                                    <th>Description</th>
                                    <th>HSN Code</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                                    <td><textarea type="text" class="form-control" name="description[]" placeholder="Item Description" required></textarea></td>
                                    <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code"></td>
                                    <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                                    <td><input type="text" class="form-control" name="unit[]" placeholder="Unit" value="Nos"></td>
                                    <td><input type="text" class="form-control" name="remarks[]" placeholder="Remarks/Approx amt"></td>
                                    <td>
                                        <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary" id="addItemRow"><i class="fas fa-plus"></i> Add Item</button>
                    </div>

                    <!-- Terms & Conditions Section -->
                    <div class="form-section">
                        <h2 class="section-title">Reason</h2>
                       
                        <div class="form-group">
                            
                            <textarea class="form-control textarea-control" id="notes" name="reason" rows="2" placeholder="Reason(if any ) : "></textarea>
                        </div>
                    </div>

                    <!-- Submit Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn" id="generate_challan">Generate Delivery Challan</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
                    </div>
                </form>
            </div>
            <script>
            let loaderStart = 0;
const MIN_TIME = 2000;

function startLoader(text = "Processing") {
  loaderStart = Date.now();
  document.getElementById("loaderText").innerText = text;
  document.getElementById("loaderOverlay").classList.remove("hidden");
}

function stopLoader() {
  const elapsed = Date.now() - loaderStart;
  const delay = Math.max(0, MIN_TIME - elapsed);

  setTimeout(() => {
    document.getElementById("loaderOverlay").classList.add("hidden");
  }, delay);
}

const dcType = document.getElementById("dcType");
const expiryContainer = document.getElementById("expiryContainer");
const expiryDate = document.getElementById("expiryDate");
const escalationContainer = document.getElementById("escalationContainer");
const escalationStatus = document.getElementById("escalationStatus");

            // Add event listener for adding new rows
            document.getElementById('addItemRow').addEventListener('click', addItemRow);

            // Add initial event listeners to first row
            addRowEventListeners(document.querySelectorAll('#itemTable tbody tr')[0]);
        

        // Add a new row to the item table
        function addItemRow() {
            const tbody = document.querySelector('#itemTable tbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                <td><input type="text" class="form-control" name="description[]" placeholder="Item Description" required></td>
                <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code"></td>
                <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                <td><input type="text" class="form-control" name="unit[]" placeholder="Unit" value="Nos"></td>
                <td><input type="text" class="form-control" name="remarks[]" placeholder="Remarks/Approx Cost"></td>
                <td>
                    <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tbody.appendChild(newRow);
            addRowEventListeners(newRow);
            updateRowNumbers();
        }

        // Add event listeners to a table row
        function addRowEventListeners(row) {
            // Delete row
            row.querySelector('.delete-row').addEventListener('click', function() {
                if (document.querySelectorAll('#itemTable tbody tr').length > 1) {
                    row.remove();
                    updateRowNumbers();
                } else {
                    alert('You must have at least one item in your delivery challan.');
                }
            });
        }

        // Update row numbers in the table
        function updateRowNumbers() {
            document.querySelectorAll('#itemTable tbody tr').forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }

        // Reset form function
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                document.getElementById('deliveryChallanForm').reset();
                // Reset item table to initial state
                resetItemTable();
                // Reset challan date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('challanDate').value = today;
            }
        }

        // Reset item table to initial state
        function resetItemTable() {
            const tbody = document.querySelector('#itemTable tbody');
            tbody.innerHTML = '';

            // Add initial row
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>1</td>
                <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                <td><input type="text" class="form-control" name="description[]" placeholder="Item Description" required></td>
                <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code"></td>
                <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                <td><input type="text" class="form-control" name="unit[]" placeholder="Unit" value="Nos"></td>
                <td><input type="text" class="form-control" name="remarks[]" placeholder="Remarks/Approx Cost"></td>
                <td>
                    <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tbody.appendChild(newRow);
            addRowEventListeners(newRow);
        }

// SHOW/HIDE expiry for returnable DC
dcType.addEventListener("change", () => {
    if (dcType.value === "returnable") {
        expiryContainer.style.display = "block";
        escalationContainer.style.display = "block";
    } else {
        expiryContainer.style.display = "none";
        escalationContainer.style.display = "none";
        expiryDate.value = "";
        escalationStatus.value = "";
    }
});

// SET escalation status
expiryDate.addEventListener("change", () => {
    const today = new Date();
    const exp = new Date(expiryDate.value);
    const diff = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));

    if (diff < 0) {
        escalationStatus.value = `EXPIRED (${Math.abs(diff)} days ago)`;
        escalationStatus.style.color = "red";
    } else if (diff <= 5) {
        escalationStatus.value = `DUE SOON (Expires in ${diff} days)`;
        escalationStatus.style.color = "orange";
    } else {
        escalationStatus.value = "NORMAL";
        escalationStatus.style.color = "green";
    }
});

// GENERATE CHALLAN NUMBER
document.getElementById("generateChallanNumber").addEventListener("click", async () => {
    const res = await fetch("/generate-challan-no");
    const data = await res.json();
    if (data.success) {
        document.getElementById("challanNumber").value = data.challan_no;
    }
});

// SUBMIT FORM
document.getElementById("deliveryChallanForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const json = Object.fromEntries(formData.entries());

    // Collect item table rows (arrays)
    json.partNo = formData.getAll("partNo[]");
    json.description = formData.getAll("description[]");
    json.hsn = formData.getAll("hsn[]");
    json.quantity = formData.getAll("quantity[]");
    json.unit = formData.getAll("unit[]");
    json.remarks = formData.getAll("remarks[]");

    const res = await fetch("/submit-delivery-challan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
    });

    const data = await res.json();
    if (data.success) {
        alert("Delivery Challan Created: " + data.challan_no);
    } else {
        alert("Error: " + data.message);
    }
});


                
            </script>         

            <!-- Trade & Service Tab -->
            <div class="tab-content" id="trade-service">
                <div class="tab-header">
                    <h3>Trade & Services Quotation</h3>
                    <p>Create professional quotations for Trade & Services</p>
                </div>
                <div class="form-container">
                    <form id="TradeQuotationForm" method="POST" action="/api/send-quotation-approval" enctype="multipart/form-data">
                        <!-- Quotation Information Section -->
                        <div class="form-section">
                            <h2 class="section-title">Quotation Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quotationType">Quotation Type</label>
                                        <select id="quotationType" name="quotationType">
                                            <option value="Trade & Services">Trade & Services</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quotationNumber" class="required">Quotation Number</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="quotationNumber" name="quotationNumber" required style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="generateQuotationNumber" class="btn btn-secondary btn-small">Generate</button>
                                        </div>
                                        <div class="error-message" id="quotationNumberError">Please enter a valid quotation number</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="quotationDate" class="required">Quotation Date</label>
                                        <input type="date" id="quotationDate" name="quotationDate" required>
                                        <div class="error-message" id="quotationDateError">Please select a valid date</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="referenceNo">Reference Number</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="referenceNo" name="referenceNo" readonly style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="generateReferenceNumber" class="btn btn-secondary btn-small">Generate</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <!-- Empty column for balance -->
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="validUntil" class="required">Valid Until</label>
                                        <input type="date" id="validuntil" name="validUntil" required>
                                        <div class="error-message" id="validUntilError">Please select a valid date</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="currency" class="required">Currency</label>
                                        <select id="currency" name="currency" required>
                                            <option value="">Select Currency</option>
                                            <option value="INR">INR</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                        <div class="error-message" id="currencyError">Please select a currency</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="paymentTerms">Payment Terms</label>
                                        <input type="text" id="paymentTerms" name="paymentTerms" placeholder="e.g., 50% advance, 50% on delivery">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="deliveryDuration">Delivery Duration</label>
                                        <input type="text" id="deliveryDuration" name="deliveryDuration" placeholder="e.g., 2-4 weeks">
                                    </div>
                                </div>
                   
                            </div>
                            
               <div class="form-row">
                 <div class="form-col">
                   <div class="form-group">
                     <label for="gst">GST</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="gst" name="gstterms" placeholder="GST">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="packaging">Packaging</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="packaging" name="packaging" placeholder="Packaging">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="insurance">Insurance</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="insurance" name="insurance" placeholder="Insurance">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="deliveryTerms">Delivery Terms</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="deliveryTerms" name="deliveryTerms" placeholder="Delivery Terms">
                   </div>
                 </div>
               </div>
                            
                        </div>

                        <!-- Client Information Section -->
                        <div class="form-section">
                            <h2 class="section-title">Client Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <h3 style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px;">Company Details</h3>
                                    <div class="form-group">
                                        <label for="companyName">Company Name</label>
                                        <input type="text" id="companyName" name="companyName" placeholder="Your company name">
                                    </div>
                                    <div class="form-group">
                                        <label for="companyEmail">Company Email</label>
                                        <input type="email" id="companyEmail" name="companyEmail" placeholder="company@example.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="companyGST">Company GST</label>
                                        <input type="text" id="companyGST" name="companyGST" placeholder="GST number">
                                    </div>
                                    <div class="form-group">
                                        <label for="companyAddress">Company Address</label>
                                        <textarea id="companyAddress" name="companyAddress" rows="3" placeholder="Full company address"></textarea>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <h3 style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px;">Client Info</h3>
                                    <div class="form-group">
                                        <label for="clientName" class="required">Client Name</label>
                                        <input type="text" id="clientName" name="clientName" required placeholder="Full name of the client">
                                        <div class="error-message" id="clientNameError">Please enter client name</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="clientEmail" class="required">Client Email</label>
                                        <input type="email" id="clientEmail" name="clientEmail" required placeholder="client@example.com">
                                        <div class="error-message" id="clientEmailError">Please enter a valid email address</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="clientPhone">Client Phone</label>
                                        <input type="tel" id="clientPhone" name="clientPhone" placeholder="+91 9876543210">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items Section -->
                        <div class="form-section">
                            <h2 class="section-title">Items & Services</h2>
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Part No</th>
                                        <th>Description</th>
                                        <th>HSN Code</th>

                                        <th>Qty</th>
                                        <th>Unit</th>
                                        <th>Unit Price</th>

                                        <th>Total Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody">
                                    <tr class="item-row">
                                        <td><input type="text" name="itemPartNo[]" placeholder="Part No"></td>
                                        <td> <textarea class="item-descriptin" 
              name="itemDescription[]" 
              placeholder="Item or service description" 
              rows="4" 
              style="
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;
    resize: vertical;
"></textarea></td>
                                        <td><input type="text" name="itemHSN[]" placeholder="HSN Code"></td>

                                        <td><input type="number" step="0.01" name="itemQuantity[]" placeholder="Qty" required></td>
                                        <td><input type="text" name="itemUnit[]" placeholder="Unit" value="Nos"></td>
                                        <td><input type="number" step="0.01" name="itemPrice[]" placeholder="Price" required></td>

                                        <td><input type="number" step="0.01" name="itemTotal[]" placeholder="Total" readonly style="background-color: #f0f0f0;"></td>
                                        <td><button type="button" class="btn btn-danger btn-small remove-item">Remove</button></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="6" style="text-align: right; font-weight: bold; padding-right: 10px;">Grand Total:</td>
                                        <td><input type="number" step="0.01" id="tradeGrandTotal" readonly style="background-color: #f0f0f0; font-weight: bold; width: 100%;"></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <button type="button" id="addItem" class="btn btn-secondary">Add Item</button>
                        </div>

                        <!-- Summary Section -->
                        <div class="form-section">
                            <h2 class="section-title">Summary</h2>
                            
                            <div class="form-group">
                                <label for="notes">Additional Notes</label>
                                <textarea id="notes" name="notes" rows="4" placeholder="Any additional notes or terms"></textarea>
                            </div>
                        </div>

                        <!-- Attachments Section -->
                        <div class="form-section">
                            <h2 class="section-title">Attachments</h2>
                            <div id="attachmentsContainer">
                                <div class="attachment-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Upload File</label>
                                        <input type="file" name="attachments[]" accept=".pdf,.doc,.docx,.jpg,.png,.txt">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Note</label>
                                        <textarea name="attachmentNotes[]" rows="2" placeholder="Add a note for this attachment"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-small remove-attachment" style="margin-top: 25px;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="addAttachment" class="btn btn-secondary">Add Attachment</button>
                        </div>
                        <!-- FULLSCREEN OVERLAY -->
<div id="popupModal" class="popup-modal">

   <!-- POPUP CARD -->
   <div class="popup-card">

       <!-- CLOSE BUTTON -->
       <button type="button" class="closeBtn">
           &times;
       </button>

       <h2 style="font-size: 24px; font-weight: 600; color: #1f2937; margin-bottom: 16px; border-bottom: 1px solid #e5e7eb; padding-bottom: 12px;">
           Add Item Description
       </h2>

       <!-- MAIN HEADING -->
       <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 4px;">Main Heading:</label>
       <input
           type="text"
           id="mainHeading"
           placeholder="Enter main heading">

       <div id="subpointsContainer"></div>

       <button
           type="button"
           id="addSubpointBtn">
           + Add Subpoint
       </button>

       <div style="margin-top: 24px; text-align: right;">
           <button
               type="button"
               id="saveBtn">
               Save Description
           </button>
       </div>
   </div>
</div>



                        <!-- Submit Buttons -->
                        <div class="form-actions">
                            
                            
<button type="submit" id="sendApprovalRequest" class="btn btn-primary">Send Approval Request</button>
                            
                        </div>

                    </form>
                </div>
            </div>
            
                  
            
                

            <!-- MAE Tab -->
            <div class="tab-content" id="mae">
                <div class="tab-header">
                    <h3>MAE Quotation</h3>
                    <p>Create professional MAE quotations with enhanced client and company information</p>
                </div>
                <div id="previewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9999;">
    <button onclick="document.getElementById('previewModal').style.display='none'"
        style="position:absolute; top:10px; right:10px; font-size:20px;">‚ùå</button>

    <iframe id="previewFrame" style="width:90%; height:90%; margin:3% auto; display:block; border:none;"
            oncontextmenu="return false;"></iframe>
</div>

                <input type="hidden" name="createdBy" id="maeCreatedBy">

                <div class="form-container">
                    <form id="maeQuotationForm">
                        <!-- Enhanced Quotation Header -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-col">
                                    <h3 style="font-size: 1.2rem; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                                        <i class="fas fa-file-contract" style="margin-right: 10px; color: #3b82f6;"></i>
                                        Quotation Details-MAE TYPE
                                    </h3>
                                    
                                    <div class="form-group">
                                        <label for="maeQuotationNumber" class="required">Quotation Number</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="maeQuotationNumber" name="quotationNumber" required readonly style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="maeGenerateQuotationNumber" class="btn btn-primary btn-small" onclick= generate_mae()>Generate</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="maeQuotationDate" class="required">Quotation Date</label>
                                        <input type="date" id="maeQuotationDate" name="quotationDate" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <h3 style="font-size: 1.2rem; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center;">
                                        <i class="fas fa-clock" style="margin-right: 10px; color: #10b981;"></i>
                                        Validity & Terms
                                    </h3>
                                    <div class="form-group">
                                        <label for="maeValidUntil" class="required">Valid Until</label>
                                        <input type="date" id="maeValidUntil" name="validUntil" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="maeCurrency" class="required">Currency</label>
                                        <select id="maeCurrency" name="currency" required>
                                            <option value="">Select Currency</option>
                                            <option value="INR">INR</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                    </div>
                                    <!-- <div class="form-group">
                                        <label for="maeReferenceNo">Reference Number</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="maeReferenceNo" name="referenceNo" readonly style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="maeGenerateReferenceNumber" class="btn btn-secondary btn-small">Generate</button>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Client & Company Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Client & Company Information
                            </h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
                                            <i class="fas fa-industry" style="margin-right: 8px; color: #3b82f6;"></i>
                                            Company Profile
                                        </h3>
                                        <div class="form-group">
                                            <label for="maeCompanyName" class="required">Company Name</label>
                                            <input type="text" id="maeCompanyName" name="companyName" required placeholder="Enter company name">
                                        </div>
                                        <!-- <div class="form-group">
                                            <label for="maeCompanyEmail" class="required">Company Email</label>
                                            <input type="email" id="maeCompanyEmail" name="companyEmail" required placeholder="company@example.com">
                                        </div>
                                        <div class="form-group">
                                            <label for="maeCompanyGST" class="required">Company GST Number</label>
                                            <input type="text" id="maeCompanyGST" name="companyGST" required placeholder="GST number">
                                        </div> /-->
                               
                                        <div class="form-group">
                                            <label for="maeCompanyAddress" class="required">Company Address</label>
                                            <textarea id="maeCompanyAddress" name="companyAddress" rows="4" required placeholder="Full company address with PIN code"></textarea>
                                        </div>
                                        
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;">
                                            <i class="fas fa-user-tie" style="margin-right: 8px; color: #10b981;"></i>
                                            Client Details
                                        </h3>
                                        <div class="form-group">
                                            <label for="maeClientName" class="required">Client Name</label>
                                            <input type="text" id="maeClientName" name="clientName" required placeholder="Full name of the client">
                                        </div>
                                        <div class="form-group">
                                            <label for="maeClientEmail" class="required">Client Email</label>
                                            <input type="email" id="maeClientEmail" name="clientEmail" required placeholder="client@example.com">
                                        </div>
                                        <div class="form-group">
                                            <label for="maeClientPhone" class="required">Client Phone</label>
                                            <input type="tel" id="maeClientPhone" name="clientPhone" required placeholder="+91 9876543210">
                                        </div>
                                        <!-- <div class="form-group">
                                            <label for="maeClientCompany">Client Company</label>
                                            <input type="text" id="maeClientCompany" name="clientCompany" placeholder="Client's company name">
                                        </div>
                                        <div class="form-group">
                                            <label for="maeClientDesignation">Client Designation</label>
                                            <input type="text" id="maeClientDesignation" name="clientDesignation" placeholder="CEO, Manager, etc.">
                                        </div>
                                        <div class="form-group">
                                            <label for="maeClientAddress" class="required">Client Address</label>
                                            <textarea id="maeClientAddress" name="clientAddress" rows="4" required placeholder="Client's full address"></textarea>
                                        </div> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h3>MACHINE INFORMATION</h3>
                         <div class="form-group">
                                            <label for="maeSubject" class="required">Subject(Machine name)</label>
                                            <input  style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" id="maeSubject" name="subject" rows="1" required placeholder="eg .. CRI Body AOI">
                                        </div>

<textarea id="editor" name="textarea_details"></textarea>
                        <!-- MAE Technical Specifications -->
                        <!-- <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-cogs" style="margin-right: 10px;"></i>
                                MAE Technical Specifications
                            </h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="maeType">MAE Type</label>
                                        <select id="maeType" name="maeType">
                                            <option value="">Select Type</option>
                                            <option value="Standard">Standard</option>
                                            <option value="Custom">Custom</option>
                                            <option value="Special">Special</option>
                                            <option value="Industrial">Industrial</option>
                                            <option value="Commercial">Commercial</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="maeModel">Model Number</label>
                                        <input type="text" id="maeModel" name="maeModel" placeholder="MAE model number">
                                    </div>
                                    <div class="form-group">
                                        <label for="maeCapacity">Capacity/Specifications</label>
                                        <input type="text" id="maeCapacity" name="maeCapacity" placeholder="e.g., 100KW, 3-Phase">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="maeMaterial">Material Type</label>
                                        <input type="text" id="maeMaterial" name="maeMaterial" placeholder="Material specifications">
                                    </div>
                                    <div class="form-group">
                                        <label for="maeStandards">Compliance Standards</label>
                                        <input type="text" id="maeStandards" name="maeStandards" placeholder="ISO, CE, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label for="maeWarranty">Warranty Period</label>
                                        <input type="text" id="maeWarranty" name="maeWarranty" placeholder="e.g., 2 years">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="maeTechnicalDetails">Technical Details & Features</label>
                                <textarea id="maeTechnicalDetails" name="maeTechnicalDetails" rows="4" placeholder="Describe technical specifications, features, and capabilities"></textarea>
                            </div>
                        </div> -->

                        <!-- Enhanced Items & Pricing -->
                        

                        <!-- Terms & Conditions -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-handshake" style="margin-right: 10px;"></i>
                                Terms & Conditions
                            </h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="maePaymentTerms">Payment Terms</label>
                                        <input type="text" id="maePaymentTerms" name="maePaymentTerms" placeholder="e.g., 50% advance, 30% on delivery, 20% post-installation">
                                    </div>
                                    <div class="form-group">
                                        <label for="maeGstTerms">Gst Terms</label>
                                        <input type="text" name="maeGstTerms" placeholder="e.g., 18% Extra">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="maePackaging">Packagig & Forwarding</label>
                                        <input type="text" id="maePackaging" name="maePackaging" placeholder="e.g., Exworks ,DAP">
                                    </div>
                                    <div class="form-group">
                                        <label for="maeInsurance">Insurance</label>
                                        <input type="text" id="maeInsurance" name="maeInsurance" placeholder=" Insurance if any">
                                    </div>
                                    
                                    
                                </div>
                                <div class="form-group">
                                        <label for="maeWarranty">Warranty</label>
                                        <input type="text" id="maeWarranty" name="maeWarranty" placeholder=" 6 months">
                                    </div>
                             
                            </div>
                            
                        </div>

                        <!-- Attachments Section -->
                        <!-- <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-paperclip" style="margin-right: 10px;"></i>
                                Attachments & Documentation
                            </h2>
                            <div id="maeAttachmentsContainer">
                                <div class="attachment-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                    <div class="form-group" style="flex: 1;">
                                        <label>Upload File</label>
                                        <input type="file" name="attachments[]" accept=".pdf,.doc,.docx,.jpg,.png,.txt,.dwg,.xls,.xlsx">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Note</label>
                                        <textarea name="attachmentNotes[]" rows="2" placeholder="Description of the attachment"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-small mae-remove-attachment" style="margin-top: 25px;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="maeAddAttachment" class="btn btn-secondary">Add Attachment</button>
                        </div> -->

                        <!-- Submit Actions -->
                        <div class="form-actions">
                            
                            <button type="button"  id="maeSendApprovalRequest" style="background-color: #29a802; color:white;padding:8px 10px;border-radius:5px;border:1px solid rgba(171, 202, 136, 0.884); font-size:medium;font-weight:bold">Send Approval Request</button>
                             <button type="button" onclick=saveDraft() style="background-color: #eff160; color:white;padding:8px 10px;border-radius:5px;border:1px solid rgba(113, 117, 108, 0.884); font-size:medium;font-weight:bold">Save(Draft)</button>
                            <button type="button" onclick=previewmae() style="background-color: #1d8cd6; color:white;padding:8px 10px;border-radius:5px;border:1px solid rgba(171, 202, 136, 0.884); font-size:medium;font-weight:bold">Preview</button>
                        </div>
                    </form>
                </div>
            </div>
                     <script>
document.addEventListener("DOMContentLoaded", function() {
    

    const form = document.getElementById("maeQuotationForm");
    const submitBtn = document.getElementById("maeSendApprovalRequest");
    const userEmail = document.querySelector(".user-info span")?.textContent.trim() || "";

    // Set createdBy
    document.getElementById("maeCreatedBy").value = userEmail;

    /* ---------------------------------------------------
       1Ô∏è‚É£ RESTORE SAVED DRAFT WHEN PAGE LOADS
    ---------------------------------------------------- */
     

    function restoreDraft() {
      const saved = localStorage.getItem("maeForm");
      if (!saved) return;
      const data = JSON.parse(saved);

      Object.keys(data).forEach(key => {
          const field = document.querySelector(`[name="${key}"]`);
          if (field) field.value = data[key];
      });

      if (data.textarea_details && typeof tinymce !== "undefined" && tinymce.get("editor")) {
          tinymce.get("editor").setContent(data.textarea_details);
      }

      console.log("Draft Fully Restored");
    }

    /* ‚¨ÖÔ∏è You forgot this */
    restoreDraft();



    /* üîπ Restore TinyMCE content after init (if exists) */
    setTimeout(() => {
        const savedDraft = localStorage.getItem("maeForm");
        if (!savedDraft) return;
        const data = JSON.parse(savedDraft);
        if (data.textarea_details && typeof tinymce !== "undefined" && tinymce.get("editor")) {
            tinymce.get("editor").setContent(data.textarea_details);
        }
    }, 800);

    /* ---------------------------------------------------
       3Ô∏è‚É£ SAVE DRAFT FUNCTION (button calls this)
    ---------------------------------------------------- */
    window.saveDraft = function () {
    // Save TinyMCE value into its textarea
    if (typeof tinymce !== "undefined" && tinymce.get("editor")) {
        tinymce.triggerSave();
    }

    const form = document.getElementById("maeQuotationForm");
    let data = {};

    // Save ALL fields - company, quotation, client, terms, everything
    form.querySelectorAll("input, select, textarea").forEach(field => {
        if (field.name) data[field.name] = field.value;
    });
    console.log("maeform ", JSON.stringify(data));

    localStorage.setItem("maeForm", JSON.stringify(data));
    alert("Draft Saved!");
};

    /* ---------------------------------------------------
       3Ô∏è‚É£ FINAL SUBMIT BUTTON LOGIC
    ---------------------------------------------------- */
    if(submitBtn) {
        submitBtn.addEventListener("click", async function (e) {
            e.preventDefault();
            console.log("Submit button clicked");

            // force HTML required validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // TinyMCE save
            if (typeof tinymce !== "undefined" && tinymce.get('editor')) {
                tinymce.triggerSave();
            }

            const formData = new FormData(form);
            formData.append("status", "pending");
            formData.append("createdBy", document.getElementById("maeCreatedBy").value);

            console.log("--- Sending Form Data ---");
            for (let pair of formData.entries()) console.log(pair[0] + ": ", pair[1]);

            try {
                const response = await fetch('/api/sendApproval/mae', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // üßπ Clear draft after successful submit
                    localStorage.removeItem("maeForm");
                    alert("Approval Request Sent Successfully!");
                    window.location.href = "/success-page";
                } else {
                    alert("Server Error!");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to send request!");
            }
        });

    } else {
        console.error("Submit button not found: #maeSendApprovalRequest");
    }

});

tinymce.init({
  selector: '#editor',
  height: 430,
  plugins: 'table lists image code',
  menubar: false,
  statusbar: false,
  toolbar: `
    undo redo |
    bold italic underline |
    forecolor backcolor |
    fontsize myLineHeight |
    alignleft aligncenter alignright |
    bullist numlist |
    table image code
  `,
  
  // IMAGE UPLOAD
  images_upload_url: "/upload_image",
images_upload_handler: function (blobInfo) {
  let formData = new FormData();
  formData.append("image", blobInfo.blob(), blobInfo.filename());

  return fetch("/upload_image", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (!data.location) {
        // TinyMCE will show this message automatically
        throw new Error("Invalid upload response ‚Äî `location` missing");
      }
      return data.location;   // <-- TinyMCE inserts this into editor
    })
    .catch(err => {
      console.error("Upload failed", err);
      throw err; // TinyMCE will display it
    });
}

,

  // FONT SIZE DROPDOWN
  fontsize_formats: '10px 12px 14px 16px 18px 20px 24px 28px 32px',

  // CUSTOM LINE HEIGHT MENU
  setup: function (editor) {
    editor.ui.registry.addMenuButton('myLineHeight', {
      text: 'Line Height',
      fetch: function (callback) {
        callback([
          { type: 'menuitem', text: '1', onAction: () => editor.execCommand('mceApplyLineHeight', false, '1') },
          { type: 'menuitem', text: '1.15', onAction: () => editor.execCommand('mceApplyLineHeight', false, '1.15') },
          { type: 'menuitem', text: '1.5', onAction: () => editor.execCommand('mceApplyLineHeight', false, '1.5') },
          { type: 'menuitem', text: '1.75', onAction: () => editor.execCommand('mceApplyLineHeight', false, '1.75') },
          { type: 'menuitem', text: '2', onAction: () => editor.execCommand('mceApplyLineHeight', false, '2') },
          { type: 'menuitem', text: '3', onAction: () => editor.execCommand('mceApplyLineHeight', false, '3') }
        ]);
      }
    });

    // Apply custom line height
    editor.addCommand('mceApplyLineHeight', function (_, value) {
      editor.formatter.register('lineheight', {
        inline: 'span',
        styles: { 'line-height': '%value' }
      });
      editor.formatter.apply('lineheight', { value }, editor.selection.getNode());
    });
  }
});

</script>

            <!-- VK Tab -->
            <div class="tab-content" id="vk">
                <div class="tab-header">
                    <h3>VK Quotation</h3>
                    <p>Create professional VK quotations for your clients</p>
                </div>
                <div class="form-container">
                    <form id="vkQuotationForm" method="POST" action="/api/send-vk-quotation-approval" enctype="multipart/form-data">
                        <!-- Quotation Information Section -->
                        <div class="form-section">
                            <h2 class="section-title">Quotation Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkQuotationType">Quotation Type</label>
                                        <select id="vkQuotationType" name="quotationType">
                                            <option value="VK" selected>VK</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkQuotationNumber" class="required">Quotation Number</label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="vkQuotationNumber" name="quotationNumber" required style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="vkGenerateQuotationNumber" class="btn btn-secondary btn-small">Generate</button>
                                        </div>
                                        <div class="error-message" id="vkQuotationNumberError">Please enter a valid quotation number</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkQuotationDate" class="required">Quotation Date</label>
                                        <input type="date" id="vkQuotationDate" name="quotationDate" required>
                                        <div class="error-message" id="vkQuotationDateError">Please select a valid date</div>
                                    </div>
                                </div>
                            </div>
                             <div class="form-row">
                
                <div class="form-col">
               <div class="form-row">
                 <div class="form-col">
                   <div class="form-group">
                     <label for="gst">GST</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="gst" name="vkgst" placeholder="GST">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="packaging">Packaging</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="packaging" name="vkpackaging" placeholder="Packaging">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="insurance">Insurance</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="insurance" name="vkinsurance" placeholder="Insurance">
                   </div>
                 </div>
                 <div class="form-col">
                   <div class="form-group">
                     <label for="deliveryTerms">Delivery Terms</label>
                     <input style="width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border 0.3s;" type="text" id="deliveryTerms" name="vkdeliveryTerms" placeholder="Delivery Terms">
                   </div>
                 </div>
               </div>
                  <!-- Empty column for balance -->
                </div>
              </div>
                            <!-- <div class="form-row">
                                <div class="form-col">
                                     <div class="form-group">
                                        <label for="vkReferenceNo">Reference Number <span style="color: red;">*</span></label>
                                        <div style="display: flex; gap: 10px;">
                                            <input type="text" id="vkReferenceNo" name="referenceNo" required style="flex: 1; cursor: not-allowed; background-color: #f0f0f0;">
                                            <button type="button" id="vkGenerateReferenceNumber" class="btn btn-secondary btn-small">Generate</button>
                                        </div>
                                    </div> 
                                </div>
                                <div class="form-col">
                                   
                                </div>
                            </div> -->
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkValidUntil" class="required">Valid Until</label>
                                        <input type="date" id="vkValidUntil" name="validUntil" required>
                                        <div class="error-message" id="vkValidUntilError">Please select a valid date</div>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkCurrency" class="required">Currency</label>
                                        <select id="vkCurrency" name="currency" required>
                                            <option value="">Select Currency</option>
                                            <option value="INR">INR</option>
                                            <option value="USD">USD</option>
                                            <option value="EUR">EUR</option>
                                        </select>
                                        <div class="error-message" id="vkCurrencyError">Please select a currency</div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkPaymentTerms">Payment Terms <span style="color: red;">*</span></label>
                                        <input type="text" id="vkPaymentTerms" name="paymentTerms" required placeholder="e.g., 50% advance, 50% on delivery">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="vkDeliveryDuration">Delivery Duration <span style="color: red;">*</span></label>
                                        <input type="text" id="vkDeliveryDuration" name="deliveryDuration" required placeholder="e.g., 2-4 weeks">
                                    </div>
                                </div>
                            </div>
   
                            <!-- PV Family Modal -->
                            <div id="pvFamilyModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
                                <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
                                    <span class="close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                                    <h3 style="margin-top: 0;">PV Wiring Adaptor Family Details</h3>
                                    <div class="form-group">
                                        <label for="modalFamilyName">Family Name</label>
                                        <input type="text" id="modalFamilyName" placeholder="Enter family name">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalCode">Code</label>
                                        <input type="text" id="modalCode" placeholder="Enter code">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalRevType">Rev Type</label>
                                        <input type="text" id="modalRevType" placeholder="Enter rev type">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalConfig">Config</label>
                                        <input type="text" id="modalConfig" placeholder="Enter config">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalSokCard">SOK Card</label>
                                        <input type="text" id="modalSokCard" placeholder="Enter SOK card">
                                    </div>
                                    <div class="form-group">
                                        <label for="modalpart_no">PART NO.</label>
                                        <input type="text" id="modalpart_no" placeholder="Enter PART NO.">
                                    </div>
   
                                    <button type="button" id="savePvFamily" class="btn btn-primary" style="margin-top: 10px;">Save</button>
                                </div>
                            </div>
                        </div>

                        <!-- Client Information Section -->
                        <div class="form-section">
                            <h2 class="section-title">Client Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <h3 style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px;">Company Details</h3>
                                    <div class="form-group">
                                        <label for="vkCompanyName">Company Name <span style="color: red;">*</span></label>
                                        <input type="text" id="vkCompanyName" name="companyName" required placeholder="Your company name">
                                    </div>
                                    <div class="form-group">
                                        <label for="vkCompanyEmail">Company Email <span style="color: red;">*</span></label>
                                        <input type="email" id="vkCompanyEmail" name="companyEmail" required placeholder="company@example.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="vkCompanyGST">Company GST <span style="color: red;">*</span></label>
                                        <input type="text" id="vkCompanyGST" name="companyGST" required placeholder="GST number">
                                    </div>
                                    <div class="form-group">
                                        <label for="vkCompanyAddress">Company Address <span style="color: red;">*</span></label>
                                        <textarea id="vkCompanyAddress" name="companyAddress" rows="3" placeholder="Full company address"></textarea>
                                    </div>
                                  
                                   
                                </div>
                                <div class="form-col">
                                    <h3 style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 15px;">Client Info</h3>
                                    <div class="form-group">
                                        <label for="vkClientName" class="required">Client Name</label>
                                        <input type="text" id="vkClientName" name="clientName" required placeholder="Full name of the client">
                                        <div class="error-message" id="vkClientNameError">Please enter client name</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="vkClientEmail" class="required">Client Email</label>
                                        <input type="email" id="vkClientEmail" name="clientEmail" required placeholder="client@example.com">
                                        <div class="error-message" id="vkClientEmailError">Please enter a valid email address</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="vkClientPhone">Client Phone <span style="color: red;">*</span></label>
                                        <input type="tel" id="vkClientPhone" name="clientPhone" required placeholder="+91 9876543210">
                                    </div>
                                    
                                </div>
                            </div>
                        </div>

                        <!-- VK Specific Section -->
                        <div class="form-section">
                            <h2>KIET Cost Calculations</h2>
                            <p>As per Price Agreement - Document No: <strong>con_GPAG_PU14_54808</strong></p>

                            <table class="kiet-table">
                                <thead>
                                    <tr>
                                        <th>Item Description</th>
                                        <th>Price Agreement Costs</th>
                                        <th>Total Qty</th>
                                        <th id="vkTotalValueHeader">Total Value in INR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% const vkItems = [
                                        { description: "Standard Housing", cost: 135459.00, qty: 1, value: 135459.52 },
                                        { description: "Hypertek parts and pins (Wiring class-2)", cost: 17.14, qty: 350, value: 6000.00, hasClass: true },
                                        { description: "SOK 10150", cost: 10600, qty: 1, value: 10600 },
                                        { description: "Koaxial-Stift-Radial", cost:4770, qty: 1, value: 4770.00 },
                                    ]; %>

                                    <% vkItems.forEach((item, index) => { %>
                                        <tr>
                                           <td>
    <% 
    // ‚úÖ Always include itemDescription[] even for editable rows
    if (item.description.toLowerCase().includes('sok'))
 { 
    %>
        <input type="text" name="itemDescription[]" 
               value="<%= item.description%>" 
               class="item-description-input" 
               id="vk-sok-description-input" 
               placeholder="Enter SOK description">
    <% 
    } else if (item.description.includes('Hypertek')) { 
    %>
        <input type="text" name="itemDescription[]" 
               value="<%= item.description %>" 
               class="item-description-input" 
               id="vk-hypertek-description-input" 
               placeholder="Enter Hypertek details">
    <% 
    } else { 
    %>
        <%= item.description %>
        <input type="hidden" name="itemDescription[]" value="<%= item.description %>">
    <% } %>
    <%  %>
</td>

                                            <td>
                                                <% if (item.hasClass) { %>
                                                    <select class="class-select" data-index="<%= index %>">
                                                        <option value="1" data-cost="280.11">Class 1 - ‚Çπ 280.11</option>
                                                        <option value="2" data-cost="213.33" selected>Class 2 - ‚Çπ 213.33</option>
                                                        <option value="3" data-cost="199.02">Class 3 - ‚Çπ 199.02</option>
                                                        <option value="4" data-cost="190.01">Class 4 - ‚Çπ 190.01</option>
                                                        <option value="5" data-cost="181.53">Class 5 - ‚Çπ 181.53</option>
                                                        <option value="6" data-cost="175.17">Class 6 - ‚Çπ 175.17</option>
                                                        <option value="7" data-cost="164.57">Class 7 - ‚Çπ 164.57</option>
                                                        <option value="8" data-cost="161.39">Class 8 - ‚Çπ 161.39</option>
                                                        <option value="9" data-cost="157.15">Class 9 - ‚Çπ 157.15</option>
                                                        <option value="10" data-cost="157.15">Class 10 - ‚Çπ 157.15</option>
                                                        <option value="11" data-cost="155.03">Class 11 - ‚Çπ 155.03</option>
                                                        <option value="12" data-cost="153.00">Class 12 - ‚Çπ 153.00</option>
                                                    </select>
                                                    <input type="hidden" name="priceInput[]" value="<%= item.cost.toFixed(2) %>" class="price-input-hidden" data-index="<%= index %>">
                                                <% } else { %>
                                                    <div style="display: flex; align-items: center;"><span class="currency-symbol">‚Çπ</span><input type="number" step="1" name="priceInput[]" value="<%= item.cost.toFixed(2) %>" class="price-input" data-index="<%= index %>"></div>
                                                <% } %>
                                            </td>
                                            <td><input id="vk-numb" type="number" step="1" value="<%= item.qty %>" data-cost="<%= item.cost %>" data-index="<%= index %>" class="qty-input" name="qtyInput[]"></td>
                                            <td><span class="currency-symbol">‚Çπ</span> <span class="value-display"><%= item.value.toFixed(2) %></span></td>
                                        </tr>
                                    <% }); %>

                                    <tr class="total-row">
                                        <td colspan="3"><strong>Total costs in INR (qty of 1 No.)</strong></td>
                                        <td><span class="currency-symbol">‚Çπ</span> <span id="vk-total-costs">15900.00</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Export packaging charges included</strong></td>
                                        <td><div style="display: flex; align-items: center;"><span class="currency-symbol">‚Çπ</span> <input type="number" step="0.01" value="2650.00" class="price-input" data-index="export" name="priceInput[]"></div></td>
                                        <td></td>
                                        <td><span class="currency-symbol">‚Çπ</span> <span class="value-display">2650.00</span></td>
                                    </tr>
                                    <tr>
                                        <td>Bigger box setup</td>
                                        <td><div style="display: flex; align-items: center;"><span class="currency-symbol">‚Çπ</span> <input type="number" step="0.01" value="13250.00" class="price-input" data-index="box" name="priceInput[]"></div></td>
                                        <td></td>
                                        <td><span class="currency-symbol">‚Çπ</span> <span class="value-display">13250.00</span></td>
                                    </tr>
                                </tbody>
                            </table>

                            <h3 style="font-size: 1.2rem; color: #2c3e50; margin-top: 30px; margin-bottom: 15px;">PV Wiring Adaptor Details</h3>
                            <table class="kiet-table">
                                <thead>
                                    <tr>
                                        <th>Sl No</th>
                                        <th>Qty.</th>
                                        <th>PV Wiring Adaptor Family Name</th>
                                        <th>Rev NO.</th>
                                        <th>Coaxial Pin</th>
                                        <th>SOK Card</th>
                                        <th>SOK Qty.</th>
                                        <th>Rate/Unit in INR</th>
                                        <th>Total Amount INR</th>
                                    </tr>
                                </thead>
                                <tbody id="vkPvTableBody">
                                    <tr class="pv-row">
                                        <td>1</td>
                                        <td><input type="number" step="0.01" name="pvQty[]" placeholder="Qty" class="pv-adaptor-qty-input" value="1"></td>
                                       <td><textarea name="pvFamilyName[]" placeholder="Family Name" class="pv-family-input" readonly rows="2"></textarea></td>
                                        <td><input type="text" name="pvRevNo[]" placeholder="Rev NO."></td>
                                        <td><input type="text" name="pvCoaxialPin[]" placeholder="Coaxial Pin"></td>
                                        <td><input type="text" name="pvSokCard[]" placeholder="SOK Card" class="pv-sok-card-input"></td>
                                        <td><input type="number" step="0.01" name="pvSokQty[]" placeholder="Qty" class="pv-qty-input" value="0"></td>
                                        <td><div style="display: flex; align-items: center;"><span class="currency-symbol">‚Çπ</span> <input type="number" step="0.01" name="pvRate[]" placeholder="Rate" class="pv-rate-input" value="0" readonly></div></td>
                                        <td><span class="currency-symbol">‚Çπ</span> <span class="pv-value-display">0.00</span></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="margin: 10px 50px 0 0; text-align: right;">
                                <strong>Total PV Amount INR: </strong><span class="currency-symbol">‚Çπ</span> <span id="vk-pv-total-amount">0.00</span>
                            </div>
                            <button type="button" id="vkAddPvRow" class="btn btn-secondary" style="margin-top: 10px;">Add Row</button>
                        </div>
                        </div>
                        <!-- Submit Buttons -->
                        <div class="form-actions">
                            <button type="submit" class="btn btn-warning" id="vkSendApprovalRequest" style="background-color: #ffc107; color: #212529;">Send Approval Request</button>
                        </div>
                        


                        
                        
                    </form>
                    </div>
                    <script>
document.getElementById("vkQuotationForm").addEventListener("submit", async function (e) {
  e.preventDefault(); // stop page reload
  startLoader(); // Start loader animation
  

  const form = this;
  const formData = new FormData(form);

  try {
    const res = await fetch(form.action, {
      method: form.method,
      body: formData
    });

    const data = await res.json();

    if (data.success) {
      // ‚úÖ ALERT
      alert("Quotation sent successfully ‚úÖ");
      stopLoader(); // Stop loader animation

      // ‚úÖ RESET FORM
      form.reset();

      // ‚úÖ OPTIONAL: clear quotation number
      document.getElementById("vkQuotationNumber").value = "";

    } else {
      alert("Failed to send quotation ‚ùå");
    }
  } catch (err) {
    console.error(err);
    alert("Server error ‚ùå");
  }
});
</script>






            
              
            <!-- Approved Quotation Tab -->
            <div class="tab-content" id="approved-quotation">
                <div class="tab-header">
                    <h3>Approved Quotations</h3>
                    <p>Download your approved quotations</p>
                </div>
                <div class="sub-tabs">
                    <button class="sub-tab active" data-filter="all">All Approved</button>
                    <button class="sub-tab" data-filter="mae">MAE Approved</button>
                </div>

                <div class="status-cards" id="approvedCardsContainer">
                    <!-- Approved quotations will be dynamically generated -->
                </div>
            </div>

            <!-- Assigned Project Tab -->
            <div class="tab-content" id="assigned-project">
                <div class="tab-header">
                    <h3>Assigned Projects</h3>
                    <p>View projects assigned to you for procurement</p>
                </div>
                <div class="status-cards" id="assignedProjectsContainer">
                    <!-- Assigned projects will be dynamically generated -->
                </div>
            </div><script>
document.addEventListener("DOMContentLoaded", loadAssignedProjects);
async function markProjectCompleted(projectId) {
    console.log(projectId);
  if (!confirm("Are you sure you want to mark this project as completed?")) {
    return;
  }

  try {
    const res = await fetch('/api/mark_project_completed', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ project_id: projectId })
    });

    const data = await res.json();

    
      alert("Project marked as completed ‚úÖ");
    //   loadProcessHistory(); // refresh table
   
  } catch (err) {
    console.error(err);
    alert("Server error ‚ùå");
  }
}

async function loadAssignedProjects() {
  const valu = document.querySelector(".user-info span")?.textContent.trim() || "";
  const userId = encodeURIComponent(valu);

  const container = document.querySelector("#assigned-project #assignedProjectsContainer");
  if (!container) return;

  try {
    

    const res = await fetch(`/assigned-projects/${userId}`);
    const data = await res.json();
    container.innerHTML = "";

    if (!data.length) {
      container.innerHTML = "<p>No assigned projects</p>";
      return;
    }

    // Flag to check for incomplete projects
    let hasIncomplete = false;

    data.forEach(p => {
      const card = document.createElement("div");

      const statusClass =
        p.project_status?.toLowerCase() === "completed"
          ? "card-completed"
          : "card-pending";

      // Check if this project is incomplete
      if (p.project_status?.toLowerCase() !== "completed") {
        hasIncomplete = true;
      }

      card.className = `project-card ${statusClass}`;
      card.innerHTML = `
        <h4>${p.description || '-'}</h4>
        <p><b>Project Code:</b> ${p.project_code || '-'}</p>
        <p><b>PO No:</b> ${p.po_no || '-'}</p>
        <p><b>Assigned To:</b> ${p.assigned_to || '-'}</p>
        <p><b>Assigned On:</b> ${p.assigned_on ? new Date(p.assigned_on).toLocaleDateString() : '-'}</p>
        <p><b>Budget:</b> ‚Çπ${Number(p.budget || 0).toLocaleString()}</p>
        <p><b>Quantity:</b> ${p.quantity}</p>
        <p><b>Remaining:</b> ‚Çπ${Number(p.remaining_budget|| 0).toLocaleString()}</p>
        <p><b>Target date:</b> ${p.target_date ? new Date(p.target_date).toLocaleDateString() : "Not set"}</p>
        <p><span class="status ${p.delivery_status?.toLowerCase() || ''}"> delivery_status: ${p.delivery_status || '-'}</span></p>
        <span class="status-text"> Project: ${p.project_status || "Not Completed"}</span>
        ${
          p.project_status?.toLowerCase() !== "completed"
            ? `<p><button class="btn btn-success btn-complete" onclick="markProjectCompleted('${p.project_code}')">Completed</button></p>`
            : ""
        }
        <button class="btn btn-danger" onclick="openProcessModal()">Process</button>
         <button class="btn btn-secondary" onclick="viewDocument('${p.documents}')">View Doc</button>    `;

      container.appendChild(card);
    });
    
    
    // ‚úÖ Show modal if there is at least one incomplete project
    if (hasIncomplete) {
      document.getElementById("incompleteProjectsModal").style.display = "block";
    }
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>Error loading projects.</p>";
  }
}
function viewDocument(filePath) {
  if (!filePath || filePath.trim() === "null") {
    alert("No document available");
    return;
  }

  window.open(`/${filePath}`, "_blank");
}

// Function to close the modal
function closeIncompleteProjectsModal() {
  document.getElementById("incompleteProjectsModal").style.display = "none";
}





</script>

<div class="modal fade" id="processModal" tabindex="-1" style="display: none;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‚öôÔ∏è Process Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="processForm">
        <div class="modal-body">

          <div class="mb-3">
            <label for="process" class="form-label">
              What are you going to do
            </label>
            <textarea
              class="form-control"
              name="process"
              id="process"
              rows="4"
              placeholder="What you're going to do"
              required></textarea>
          </div>

          <div class="mb-3">
            <label for="who" class="form-label" >Who is processing</label>
            <input
              type="text"
              class="form-control"
              id="who"
              name="who"
              placeholder="Enter your name"
              required>
               <input
              type="text"
              class="form-control"
              id="prj_cd"
              name="project_code"
              placeholder="Enter Project code"
              required>
              
          </div>

          <p class="text-muted">
            This process will verify data, generate reports, and update status.
          </p>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeProcessModal()">
            Close
          </button>
          <button type="submit" class="btn btn-danger">
            Confirm Process
          </button>
        </div>
      </form>

    </div>
  </div>
</div>


<script>
document.getElementById("processForm").addEventListener("submit", async function (e) {
  e.preventDefault(); // stop page reload

  const process = document.getElementById("process").value;
  const who = document.getElementById("who").value;
  const prj_code=document.getElementById("prj_cd").value;

  console.log(process, who,prj_code);

  try {
    const response = await fetch("/process/store", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ process, who,prj_code })
    });

    const result = await response.json();

    
      alert("Process stored successfully ‚úÖ");

    

      

     
  } catch (error) {
    console.error(error);
    alert("Server error ‚ùå");
  }
});



function openProcessModal() {
  document.getElementById("processModal").style.display = "flex";
}

function closeProcessModal() {
  document.getElementById("processModal").style.display = "none";
}
</script>















            <!-- Quotation Uploads Tab -->
            <div class="tab-content" id="quotation-uploads">
                <div class="tab-header">
                    <h3>Quotation File Uploads</h3>
                    <p>View all uploaded quotation files</p>
                </div>
                <div class="status-filters">
                    <div class="form-group">
                        <label for="uploadsFilter">Filter by Type:</label>
                        <select class="form-control" id="uploadsFilter">
                            <option value="all">All Files</option>
                            <option value="pdf">PDF Files</option>
                            <option value="image">Images</option>
                            <option value="other">Other Files</option>
                        </select>
                    </div>
                </div>

                <div class="status-cards" id="uploadsCardsContainer">
                    <!-- Uploaded files will be dynamically generated -->
                </div>
            </div>

            <!-- Status Tab -->
            <div class="tab-content" id="statusContent">
                <div class="tab-header">
                    <h3>Order Status</h3>
                    <p>Track the status of your orders</p>
                </div>
                <div class="status-filters">
                    <div class="form-group">
                        <label for="statusFilter">Filter by Status:</label>
                        <select class="form-control" id="statusFilter">
                            <option value="all">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="purchase">Purchase</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="sent">Sent</option>
                            <option value="received">Received</option>

                        </select>
                    </div>
                </div>

              <div class="tracking-wrapper" style="display: none;">
  <!-- Progress line -->
            <div id="progressBar"></div>

            <!-- Steps -->
            <div class="tracking-steps">
                <div class="tracking-step">
                <div class="step-icon">1</div>
                <span class="step-label">Pending</span>
                </div>
                <div class="tracking-step">
                <div class="step-icon">2</div>
                <span class="step-label">Purchase</span>
                </div>
                <div class="tracking-step">
                <div class="step-icon">3</div>
                <span class="step-label">Approved</span>
                </div>
                <div class="tracking-step">
                <div class="step-icon">4</div>

                <span class="step-label">Sent</span>
                </div>
                <div class="tracking-step">
                <div class="step-icon">5</div>
                <span class="step-label">Received</span>
                </div>
                   <div class="tracking-step">
      <div class="step-icon">6</div>
      <span class="step-label">Paid</span>
    </div>
                <div class="tracking-step">
                    <div class="step-icon">7</div>

                <span class="step-label">Rejected</span>
                </div>
            </div>
            </div>

                <!-- Order Details Section -->
                <div id="orderDetailsSection" style="display: none;">
                    <div class="tab-header">
                        <h3>Order Details</h3>
                        <p>Detailed information about the selected order</p>
                    </div>
                    <div class="form-container">
                        <div class="form-section">
                            <div id="orderDetailsContent">
                                <!-- Order details will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Cards Container -->
                <div class="status-cards" id="statustab">
                    <!-- Status cards will be dynamically generated -->
                </div>

                
               
            </div>
        </div>
    </div>
</div></div>
    <script>

     
     
    
        
        let orders = [];
        let approvedQuotations = [];
        let maeapprovedQuotations =[];

        async function fetchApprovedQuotations(filter = 'all') {
            try {
                let endpoint = "/approved-quotations";
                if (filter === 'mae') {
                    const creat=document.querySelector('#maeCreatedBy').value;



                    endpoint = `/api/mae-quotations/get/approved/${creat}`;
;
                }

                const res = await fetch(endpoint);
                if (!res.ok) throw new Error("Failed to fetch approved quotations");

                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response");
                }

                approvedQuotations = await res.json();
                console.log("‚úÖ Approved quotations fetched:", approvedQuotations);
                renderApprovedQuotations(filter);
            } catch (err) {
                console.error("‚ùå Error fetching approved quotations:", err);
                document.getElementById("approvedCardsContainer").innerHTML =
                "<p>Could not load your approved quotations.</p>";
            }
        }

        // async function fetchAssignedProjects() {
        //     try {
        //         const res = await fetch("/assigned-projects");
        //         if (!res.ok) throw new Error("Failed to fetch assigned projects");

        //         const contentType = res.headers.get("content-type");
        //         if (!contentType || !contentType.includes("application/json")) {
        //             throw new Error("Server returned non-JSON response");
        //         }

        //         const assignedProjects = await res.json();
        //         console.log("‚úÖ Assigned projects fetched:", assignedProjects);
        //         renderAssignedProjects(assignedProjects);
        //     } catch (err) {
        //         console.error("‚ùå Error fetching assigned projects:", err);
        //         document.getElementById("assignedProjectsContainer").innerHTML =
        //         "<p>Could not load your assigned projects.</p>";
        //     }
        // }

        async function fetchOrders() {
  try {
    const res = await fetch("/status");
    if (!res.ok) throw new Error("Failed to fetch orders");

    const contentType = res.headers.get("content-type") || "";
    if (!contentType.includes("application/json") && !contentType.includes("+json")) {
      throw new Error("Server returned non-JSON response");
    }

    const orders = await res.json();
    //renderStatusCards(orders) ;

    console.log("‚úÖ Orders fetched:", orders);
    renderStatusCards(orders);
  } catch (err) {
    console.error("‚ùå Error fetching orders:", err);

    const container = document.getElementById("statustab");
    if (container) {
      container.innerHTML = "<p>Could not load your orders.</p>";
    } else {
      console.warn("‚ö†Ô∏è statusCardsContainer not found; cannot show error message in UI.");
    }
  }
}


        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date as default for date requested
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateRequired').value = today;

            // Load orders from backend
            fetchOrders();

            // Setup product table functionality
            setupProductTable();

            // Setup order tracking visualization
            setupOrderTracking();

            // Setup filter handlers
            document.getElementById('statusFilter').addEventListener('change', renderStatusCards);

            // Setup sub-tab handlers for approved quotations
            document.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    fetchApprovedQuotations(this.dataset.filter);
                });
            });

            // Form submission handling - UPDATED FOR FILE UPLOAD
            const orderForm = document.getElementById("orderForm");
            const submitBtn = orderForm.querySelector('button[type="submit"]');
            const loader = document.getElementById("loader");

            orderForm.addEventListener("submit", async function(e) {
                e.preventDefault();
                
                // Show loader and disable button
                loader.style.display = "flex";
                submitBtn.disabled = true;
                submitBtn.textContent = "Submitting...";

                const formData = new FormData(orderForm);
                const products = getProductData();
                formData.append('products', JSON.stringify(products));

                try {
                    const res = await fetch("/order_raise", {
                        method: "POST",
                        body: formData
                    });

                    const contentType = res.headers.get("content-type");
                    if (!contentType || !contentType.includes("application/json")) {
                        throw new Error("Server returned non-JSON response");
                    }

                    const result = await res.json();

                    if (result.success) {
                        alert(result.message);

                        // üîπ Reset form fields
                        

                        // üîπ Reset product table
                        resetProductTable();

                        // üîπ Reset total
                        document.getElementById("grandTotal").textContent = "0.00";
                    } else {
                        alert("Order submission failed: " + (result.error || result.message || "Unknown error"));
                    }
                    const project_cde = document.getElementById("projectCodeNumber").value.trim();
                    const supplier_name = document.getElementById("supplierName").value;

                    console.log(project_cde);
                    console.log('supplier_name:',supplier_name);
                    
    // const orderId = ;
      if (result) {
    const statusRes = await fetch(`/getreq/${project_cde}/${supplier_name}`, {
          method: "GET",
          headers: { "Accept": "application/json",project_code:project_cde,supplier_name:supplier_name }
        });

        const statusContentType = statusRes.headers.get("content-type");
        if (!statusContentType || !statusContentType.includes("application/json")) {
            throw new Error("PROJECT CODE YOU SPECIFIED IS NOT DEFINED");
        }

        const statusData = await statusRes.json();
        console.log(statusData);

        if (!statusRes.ok) {
            throw new Error(statusData.error || "Failed to fetch order status");
        }


        // Use the status data however you need:
        console.log("Order status:", statusData.assigned_to);
        // Optionally update the UI:
        const statusEl = document.getElementById("orderStatus");
        if (statusEl) statusEl.textContent = statusData.status || "Unknown";
      } else {
        console.warn("No orderId in createResult; skipping status fetch.");
      }

                } catch (err) {
                    console.error("‚ùå Error submitting order:", err);
                    alert("Order submission failed! Server returned invalid response.");
                } finally {
                    // Hide loader and enable button
                    loader.style.display = "none";
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Order';
                    orderForm.reset();
                }
            });
        });
        


            // Logout button
      
        // Tab switching functionality
        // Tab switching functionality
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function() {
                console.log("Menu item clicked:", this.dataset.tab);
                if (this.id !== 'logout-btn') {
                    // Special handling for quotation - only toggle submenu, don't switch tabs
                    if (this.dataset.tab === 'quotation') {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('submenu')) {
                            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
                        }
                        return; // Don't proceed with normal tab switching
                    }

                    // Remove active class from all tabs and menu items
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });

                    // Add active class to current tab and menu item
                    document.getElementById(this.dataset.tab).classList.add('active');
                    this.classList.add('active');

                    // Scroll to top when switching tabs
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                    // üëâ When switching to Status tab, fetch fresh orders
                    if (this.dataset.tab === 'status') {
                        console.log("status is pressed")
                        
                        fetchOrders();
                        
                    }
                    if (this.dataset.tab === 'delivery-challan'){
                        console.log("delivery challan is pressed")
                    }

                    // üëâ When switching to Approved Quotation tab, fetch approved quotations
                    if (this.dataset.tab === 'approved-quotation') {
                        const activeFilter = document.querySelector('.sub-tab.active').dataset.filter || 'all';
                        fetchApprovedQuotations(activeFilter);
                    }
                    if (this.dataset.tab ==='assigned-project'){
                        loadAssignedProjects();
                    
                    }
                   
                }
            });
        });

        // Submenu item click functionality
        document.querySelectorAll('.submenu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent parent menu item click
                // Remove active class from all tabs and menu items
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.menu-item').forEach(menuItem => {
                    menuItem.classList.remove('active');
                });
                document.querySelectorAll('.submenu-item').forEach(subItem => {
                    subItem.classList.remove('active');
                });

                // Add active class to current submenu item
                this.classList.add('active');

                // Show the appropriate tab based on the submenu item clicked
                if (this.dataset.tab === 'trade-service') {
                    document.getElementById('trade-service').classList.add('active');
                    document.querySelector('[data-tab="quotation"]').classList.add('active');
                } else if (this.dataset.tab === 'vk') {
                    // Password prompt for VK tab
                    const password = prompt("Enter password to access VK:");
                    if (password === "vk123") { // Replace with your desired password
                        document.getElementById('vk').classList.add('active');
                        document.querySelector('[data-tab="quotation"]').classList.add('active');
                        // Initialize VK form immediately after tab activation
                        setTimeout(initializeVKForm, 50);
                    } else {
                        alert("Incorrect password. Access denied.");
                         document.getElementById('trade-service').classList.add('active');
                        
                        // Remove active class if password wrong
                        return;
                    }
                } else if (this.dataset.tab === 'mae') {
                    // Handle MAE tab if it exists
                    document.getElementById('mae').classList.add('active');
                    document.querySelector('[data-tab="quotation"]').classList.add('active');
                } else if (this.dataset.tab === 'quotation-uploads') {
                    document.getElementById('quotation-uploads').classList.add('active');
                    document.querySelector('[data-tab="quotation"]').classList.add('active');
                    loadQuotationUploads(); // Load uploads when tab is opened
                    
                }
                if (this.dataset.tab === 'statusContent') {
                        console.log("status is pressed")
                        fetchOrders();
                        document.getElementById('statusContent').classList.add('active');
                        
                        
                    }
                if(this.dataset.tab === 'approved-quotation') {
                        const activeFilter = document.querySelector('.sub-tab.active').dataset.filter || 'all';
                        fetchApprovedQuotations(activeFilter);
                        document.getElementById('approved-quotation').classList.add('active');
                    }
                    
               
            });
        });
        
            
       

        
        // Setup product table functionality
        function setupProductTable() {
            // Add event listener for adding new rows
            document.getElementById('addProductRow').addEventListener('click', addProductRow);
            
            // Add initial event listeners to first row
            addRowEventListeners(document.querySelectorAll('#productTable tbody tr')[0]);
            
            // Calculate initial totals
            calculateRowTotal(document.querySelectorAll('#productTable tbody tr')[0]);
            calculateGrandTotal();
        }
        
        // Add a new row to the product table
        function addProductRow() {
            const tbody = document.querySelector('#productTable tbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                <td><input type="text" class="form-control" name="description[]" placeholder="Product Description" required></td>
                <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code" ></td>
                <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                <td><input type="number" class="form-control unit-price" name="unitPrice[]" min="0" step="0.01" value="0" required></td>
                <td><input type="number" class="form-control gst-rate" name="gst[]" min="0" step="0.01" value="18" required></td>
                <td><input type='text' class="form-control unit" name="unit[]" placeholder='Unit' ></td>
                <td><input type="number" class="form-control discount" name="discount[]" min="0" step="1" value="0" required></td>
                <td class="total">0.00</td>
                <td class="actions">
                    <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
                </td>
            `;

            tbody.appendChild(newRow);
            addRowEventListeners(newRow);

            // Update row numbers
            updateRowNumbers();
        }
        calculateRowTotal(newRow);
        // Add event listeners to a table row
        function addRowEventListeners(row) {
            // Quantity change
            row.querySelector('.quantity').addEventListener('input', function() {
                calculateRowTotal(row);
            });
            
            // Unit price change
            row.querySelector('.unit-price').addEventListener('input', function() {
                calculateRowTotal(row);
            });
            
            // GST rate change
            row.querySelector('.gst-rate').addEventListener('change', function() {
                calculateRowTotal(row);
            });

            row.querySelector('.discount').addEventListener('input', function() {
            calculateRowTotal(row);
            });
            // Delete row
            row.querySelector('.delete-row').addEventListener('click', function() {
                if (document.querySelectorAll('#productTable tbody tr').length > 1) {
                    row.remove();
                    updateRowNumbers();
                    calculateGrandTotal();
                } else {
                    alert('You must have at least one product in your order.');
                }
            });
        }
        
        // Calculate total for a row
        function calculateRowTotal(row) {
    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
    const gstRate = parseFloat(row.querySelector('.gst-rate').value) || 0;
    const discount = parseFloat(row.querySelector('.discount').value) || 0;

    // Subtotal before discount
    const subtotal = quantity * unitPrice;

    // Apply discount to subtotal (not per unit)
    const discountedSubtotal = subtotal - discount;

    // GST on discounted amount
    const gstAmount = discountedSubtotal * (gstRate / 100);

    // Final total
    const total = discountedSubtotal + gstAmount;

    row.querySelector('.total').textContent = total.toFixed(2);
    calculateGrandTotal();
}

        
        // Calculate grand total for all products
        function calculateGrandTotal() {
            let grandTotal = 0;
            
            document.querySelectorAll('#productTable tbody tr').forEach(row => {
                const total = parseFloat(row.querySelector('.total').textContent) || 0;
                grandTotal += total;
            });
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            return grandTotal;
        }
        
        // Update row numbers in the table
        function updateRowNumbers() {
            document.querySelectorAll('#productTable tbody tr').forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
            });
        }
        
        // Reset product table to initial state
        function resetProductTable() {
            const tbody = document.querySelector('#productTable tbody');
            tbody.innerHTML = '';
            
            // Add initial row
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>1</td>
                <td><input type="text" class="form-control" name="partNo[]" placeholder="Part Number" required></td>
                <td><input type="text" class="form-control" name="description[]" placeholder="Product Description" required></td>
                <td><input type="text" class="form-control" name="hsn[]" placeholder="HSN Code"></td>
                <td><input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required></td>
                <td><input type="number" class="form-control unit-price" name="unitPrice[]" min="0" step="0.01" value="0" required></td>
                <td><input type="number" class="form-control gst-rate" name="gst[]" min="0" step="0.01" value="18" required></td>
                <td><input type='text' class="form-control unit" name="unit[]" placeholder='Unit' ></td>
                <td><input type="number" class="form-control discount" name="discount[]" min="0" step="1" value="0" required></td>
                <td class="total">0.00</td>
                <td class="actions">
                    <button type="button" class="action-btn delete-row"><i class="fas fa-trash"></i></button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            addRowEventListeners(newRow);
            calculateGrandTotal();
        }
        
        // Get product data from the table
        function getProductData() {
            const products = [];
            
            document.querySelectorAll('#productTable tbody tr').forEach(row => {
                const partNo = row.querySelector('td:nth-child(2) input').value;
                const description = row.querySelector('td:nth-child(3) input').value;
                const hsn = row.querySelector('td:nth-child(4) input').value;
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const gst = parseFloat(row.querySelector('.gst-rate').value) || 0;
                const unit = row.querySelector('td:nth-child(8) input').value; // Fixed: get value from select
                const discount = parseFloat(row.querySelector('.discount').value) || 0;
                const total = parseFloat(row.querySelector('.total').textContent) || 0;
                
                
                
                products.push({
                    partNo,
                    description,
                    hsn,
                    quantity,
                    unitPrice,
                    gst,
                    unit,
                    discount,
                    total,
                    grandTotal
                });
            });
            
            return products;
        }
        let selectedOrder = null;

        // Setup order tracking visualization
        function setupOrderTracking() {
            // Initialize with no order selected
            updateOrderTracking(null);
        }

        // Update order tracking visualization based on selected order
        function updateOrderTracking(order) {
            const stepMap = {
                pending: 1,
                purchase: 2,
                approved: 3,
                sent: 4,
                received: 5,
                paid:6,
                rejected: 7
            };

            const progressBar = document.getElementById('progressBar');
            const steps = document.querySelectorAll('.tracking-step .step-icon');
            const labels = document.querySelectorAll('.tracking-step .step-label');

            let currentStep = 0;
            if (order && order.status && stepMap[order.status.toLowerCase()]) {
                currentStep = stepMap[order.status.toLowerCase()];
            }

            // Update progress bar width
            const totalSteps = Object.keys(stepMap).length;
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressBar.style.width = progressPercent + '%';

            // Update step icons and labels
            steps.forEach((stepIcon, index) => {
                stepIcon.classList.remove('active', 'completed');
                labels[index].classList.remove('active', 'completed');

                if (index + 1 < currentStep) {
                    stepIcon.classList.add('completed');
                    labels[index].classList.add('completed');
                } else if (index + 1 === currentStep) {
                    stepIcon.classList.add('active');
                    labels[index].classList.add('active');
                }
            });
        }

        // Render status cards based on orders and filter
         function renderStatusCards(orders) {
             const container = document.getElementById('statustab');
             container.innerHTML = '';

             const filter = document.getElementById('statusFilter').value.toLowerCase();

             const filteredOrders = orders.filter(order => {
                 if (filter === 'all') return true;
                 return order.status.toLowerCase() === filter;
             });

             if (filteredOrders.length === 0) {
                 container.innerHTML = '<p>No orders found for the selected status.</p>';
                 return;
             }

             filteredOrders.forEach(order => {
                 const card = document.createElement('div');
                 console.log("Rendering order:", order);
                 card.className = 'status-card ' + order.status.toLowerCase();

                 card.innerHTML = `
                     <div class="status-header">
                         <h4>${order.purchaseOrderNumber}</h4>
                         <span class="status-badge badge-${order.status.toLowerCase()}">${order.status}</span>
                     </div>
                     <div class="status-body">
                        
                         <p><strong>Project:</strong> ${order.projectName}</p>
                         <p><strong>Supplier:</strong> ${order.supplierName}</p>
                         <p><strong>Amount:</strong> ${order.totalAmount}</p>
                        <button class="btn btn-secondary download-btn"
    ${["purchase","pending","rejected"].includes(order.status?.toLowerCase()) ? "disabled" : ""}
    onclick="downloadPO('${order.id}')">
    Download PO
</button>


                 `;

                 container.appendChild(card);
                 card.addEventListener("click", () => {
                 selectedOrder = order;
                 updateOrderTracking(order);

             // highlight selected card
                 document.querySelectorAll(".status-card").forEach(c => c.classList.remove("active"));
                 card.classList.add("active");

                 // Show order details section
                 showOrderDetails(order);
                 console.log("Order details should now be visible for:", order.purchaseOrderNumber);
         });

             });
         }
   async function downloadPO(orderId) {
    const loader = document.getElementById("loader");

  try {
    startLoader("Downloading P O");

    const response = await fetch(`/api/orders/${orderId}/pdf`);
    if (!response.ok) throw new Error("Download failed");

    const blob = await response.blob();

    // 1Ô∏è‚É£ Try to get filename from header
    let disposition =
      response.headers.get("Content-Disposition") ||
      response.headers.get("content-disposition");

    let filename = null;

    if (disposition && disposition.includes("filename=")) {
      filename = disposition.split("filename=")[1].replace(/"/g, "");
    }

    // 2Ô∏è‚É£ If STILL null ‚Äî generate fallback using PO number from URL/ID
    if (!filename) {
      filename = `PO_${orderId}.pdf`;
    }

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    stopLoader();
  } catch (error) {
    console.error("Error downloading PO:", error);
    alert("Failed to download PO. Please try again.");
  }
}



        // Render approved quotations based on filter
        function renderApprovedQuotations(filter = 'all') {
            const container = document.getElementById('approvedCardsContainer');
            container.innerHTML = '';

            let filteredQuotations = approvedQuotations;
            if (filter === 'mae') {
                // For MAE filter, the data is already fetched from MAE-specific endpoint
                filteredQuotations = approvedQuotations;
            } else if (filter === 'all') {
                // For all, we might need to fetch from general endpoint or combine
                // For now, keep as is since we fetch from general endpoint for 'all'
            }

            console.log("Rendering approved quotations for filter:", filter, "Data:", filteredQuotations);

            if (filteredQuotations.length === 0) {
                container.innerHTML = '<p>No approved quotations found.</p>';
                return;
            }
            

            approvedQuotations.forEach(quotation => {
                console.log("Rendering approved quotation:", quotation);
                const card = document.createElement('div');
                card.className = 'status-card approved';

                card.innerHTML = `
                    <div class="status-header">
                        <h4>${quotation.quotationnumber}</h4>
                        <span class="status-badge badge-approved">Approved</span>
                    </div>
                    <div class="status-body">
                        <p><strong>Client:</strong> ${quotation.clientname || 'N/A'}</p>
                        <p><strong>Company:</strong> ${quotation.companyname || 'N/A'}</p>
                        <p><strong>Date:</strong> ${quotation.quotationdate || 'N/A'}</p>
                        <p><strong>Valid Until:</strong> ${quotation.validuntil || 'N/A'}</p>
                        <p><strong>Currency:</strong> ${quotation.currency || 'N/A'}</p>
                        <p><strong>Payment  : </strong>  ${ quotation.paymentterms}</p>
                        <p><strong>Delivery Duration : </strong> ${ quotation.deliveryduration}</p>
                        <p><strong>Total:</strong> ${quotation.currency === 'INR' ? '‚Çπ' : '$'}${quotation.totalamount}</p>
                    </div>
                    <div class="status-footer">
                        <button class="btn btn-primary download-btn" data-id="${quotation.id}">Download PDF</button>
                    </div>
                `;

                container.appendChild(card);
                 if (filter === 'mae') {
                // For MAE filter, the data is already fetched from MAE-specific endpoint
               card.querySelector('.download-btn').addEventListener('click', function() {
                    downloadQuotationmae(quotation.id);
                // For now, keep as is since we fetch from general endpoint for 'all'
                 });
            } else if (filter === 'all') {
                // For all, we might need to fetch from general endpoint or combine
                card.querySelector('.download-btn').addEventListener('click', function() {
                    downloadQuotation(quotation.id);
                // For now, keep as is since we fetch from general endpoint for 'all'
                 });
            }

                // Add download functionality
                });
            
              }
            
            function closeIncompleteProjectsModal() {
            
              document.getElementById("incompleteProjectsModal").style.display = "none";
            
            }
            

        // Function to download quotation
        async function downloadQuotation(quotationId) {
            try {
                const response = await fetch(`/download-quotation/${quotationId}`);
                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                console.log('Downloading quotation with ID:', response);
                a.style.display = 'none';
                a.href = url;
                
                a.download = response.headers.get('file-Name');
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading quotation:', error);
                alert('Failed to download quotation. Please try again.');
            }
        }
        async function downloadQuotationmae(quotationId) {
            try {
                const response = await fetch(`/download-mae-quotation/${quotationId}`);
                if (!response.ok) throw new Error('Download failed');

                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                console.log('Downloading quotation with ID:', response);
                a.style.display = 'none';
                a.href = url;
                
               const disposition = response.headers.get('Content-Disposition');
                let filename = "quotation.pdf"; // fallback

                if (disposition && disposition.includes("filename=")) {
                    filename = disposition
                        .split("filename=")[1]
                        .replace(/"/g, "")
                        .trim();
                }

                a.download = filename;

                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading quotation:', error);
                alert('Failed to download quotation. Please try again.');
            }
        }


        // Load quotation uploads
        async function loadQuotationUploads() {
            try {
                const res = await fetch('/api/orders');
                if (!res.ok) throw new Error('Failed to fetch orders');

                const orders = await res.json();

                // Filter orders that have quotation files
                const ordersWithUploads = orders.filter(order =>
                    order.quotation_file &&
                    Array.isArray(order.quotation_file) &&
                    order.quotation_file.length > 0
                );

                // Collect all uploaded files
                const uploadedFiles = [];
                ordersWithUploads.forEach(order => {
                    order.quotation_file.forEach(file => {
                        uploadedFiles.push({
                            fileName: file,
                            orderId: order.id,
                            orderNumber: order.purchase_order_number || order.order_id,
                            project: order.project_name || order.project,
                            supplier: order.supplier_name || order.supplier,
                            uploadedDate: order.created_at || order.date_required,
                            fileType: getFileType(file)
                        });
                    });
                });

                renderUploadedFiles(uploadedFiles);
            } catch (error) {
                console.error('Error loading quotation uploads:', error);
                document.getElementById('uploadsCardsContainer').innerHTML = '<p>Failed to load uploaded files.</p>';
            }
        }

        // Get file type from filename
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'image';
            return 'other';
        }

        // Render uploaded files
        function renderUploadedFiles(files) {
            const container = document.getElementById('uploadsCardsContainer');
            const filter = document.getElementById('uploadsFilter').value;

            // Apply filter
            const filteredFiles = files.filter(file => {
                if (filter === 'all') return true;
                return file.fileType === filter;
            });

            container.innerHTML = '';

            if (filteredFiles.length === 0) {
                container.innerHTML = '<p>No files found for the selected filter.</p>';
                return;
            }

            filteredFiles.forEach(file => {
                const card = document.createElement('div');
                card.className = 'status-card';

                const fileIcon = getFileIcon(file.fileType);

                card.innerHTML = `
                    <div class="status-header">
                        <h4>${file.fileName}</h4>
                        <span class="status-badge badge-approved">${file.fileType.toUpperCase()}</span>
                    </div>
                    <div class="status-body">
                        <p><strong>Order ID:</strong> ${file.orderNumber}</p>
                        <p><strong>Project:</strong> ${file.project}</p>
                        <p><strong>Supplier:</strong> ${file.supplier}</p>
                        <p><strong>Uploaded Date:</strong> ${new Date(file.uploadedDate).toLocaleDateString()}</p>
                    </div>
                    <div class="status-footer">
                        <button class="btn btn-primary view-file-btn" data-file="${file.fileName}">
                            ${fileIcon} View File
                        </button>
                    </div>
                `;

                container.appendChild(card);

                // Add click event to view file button
                card.querySelector('.view-file-btn').addEventListener('click', function() {
                    viewUploadedFile(file.fileName);
                });
            });
        }

        // Get file icon based on type
        function getFileIcon(type) {
            switch (type) {
                case 'pdf': return '<i class="fas fa-file-pdf"></i>';
                case 'image': return '<i class="fas fa-file-image"></i>';
                default: return '<i class="fas fa-file"></i>';
            }
        }

        // View uploaded file
        function viewUploadedFile(filename) {
            window.open(`/uploads/${filename}`, '_blank');
        }

        // Add filter event listener for uploads
        document.getElementById('uploadsFilter').addEventListener('change', function() {
            loadQuotationUploads();
        });

    

        // Function to show order details
        function showOrderDetails(order) {
            const detailsSection = document.getElementById('orderDetailsSection');
            const detailsContent = document.getElementById('orderDetailsContent');
            const statusCardsContainer = document.getElementById('statusCardsContainer');

            console.log("Showing order details for:", order);

            detailsContent.innerHTML = `
                <div class="form-row">
                    <div class="form-col">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">Order Information</h4>
                        <p><strong>Order Number:</strong> ${order.purchaseOrderNumber}</p>
                        <p><strong>Project Name:</strong> ${order.projectName}</p>
                        <p><strong>Project Code:</strong> ${order.projectCodeNumber || 'N/A'}</p>
                        <p><strong>Supplier Name:</strong> ${order.supplierName}</p>
                        <p><strong>Supplier GST:</strong> ${order.supplierGst || 'N/A'}</p>
                        <p><strong>Supplier Address:</strong> ${order.supplierAddress || 'N/A'}</p>
                        <p><strong>Shipping Address:</strong> ${order.shippingAddress}</p>
                        <p><strong>Reference Number:</strong> ${order.reference_no || 'N/A'}</p>
                        <p><strong>Terms of Payment:</strong> ${order.termsOfPayment}</p>
                        <p><strong>Urgency:</strong> ${order.urgency}</p>
                        <p><strong>Date Required:</strong> ${new Date(order.dateRequired).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> <span class="status-badge badge-${order.status.toLowerCase()}">${order.status}</span></p>
                        <button id="backToStatus" class="btn btn-secondary" style="margin-top: 15px;">‚Üê Back to Status List</button>
                    </div>
                    <div class="form-col">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">Product Details</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${order.products && order.products.length > 0 ? order.products.map(product => `
                                <div style="border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 10px; border-radius: 8px;">
                                    <p><strong>Part No:</strong> ${product.partNo}</p>
                                    <p><strong>Description:</strong> ${product.description}</p>
                                    <p><strong>HSN Code:</strong> ${product.hsn}</p>
                                    <p><strong>Quantity:</strong> ${product.quantity} ${product.unit}</p>
                                    <p><strong>Unit Price:</strong> ‚Çπ${product.unitPrice}</p>
                                    <p><strong>GST:</strong> ${product.gst}%</p>
                                    <p><strong>Discount:</strong> ‚Çπ${product.discount}</p>
                                    <p><strong>Total:</strong> ‚Çπ${product.total}</p>
                                </div>
                            `).join('') : '<p>No product details available.</p>'}
                        </div>
                        ${order.products && order.products.length > 0 ? `
                            <p style="font-weight: bold; font-size: 16px; margin-top: 15px;">
                                Grand Total: ‚Çπ${order.products.reduce((sum, product) => sum + parseFloat(product.total), 0).toFixed(2)}
                            </p>
                        ` : ''}
                    </div>
                </div>
                ${order.notes ? `
                    <div style="margin-top: 20px;">
                        <h4 style="color: #1e293b; margin-bottom: 10px;">Additional Notes</h4>
                        <p>${order.notes}</p>
                    </div>
                ` : ''}
            `;

            // Hide status cards and show order details
            statusCardsContainer.style.display = 'none';
            detailsSection.style.display = 'block';

            // Add back button functionality
            document.getElementById('backToStatus').addEventListener('click', function() {
                hideOrderDetails();
            });

            console.log("Order details section display set to block, status cards hidden");
        }

        // Function to hide order details and show status cards
        function hideOrderDetails() {
            const detailsSection = document.getElementById('orderDetailsSection');
            const statusCardsContainer = document.getElementById('statusCardsContainer');

            detailsSection.style.display = 'none';
            statusCardsContainer.style.display = 'grid';

            // Remove active class from all cards
            document.querySelectorAll('.status-card').forEach(card => {
                card.classList.remove('active');
            });
        }

         // Select an order to update tracking visualization

         // Trade & Service Tab JavaScript
        
            // Generate Quotation Number
           

        // Add Attachment functionality
            const addAttachmentBtn = document.getElementById('addAttachment');
            const attachmentsContainer = document.getElementById('attachmentsContainer');

            addAttachmentBtn.addEventListener('click', function() {
                const newAttachmentRow = document.createElement('div');
                newAttachmentRow.className = 'attachment-row';
                newAttachmentRow.style = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                newAttachmentRow.innerHTML = `
                    <div class="form-group" style="flex: 1;">
                        <label>Upload File</label>
                        <input type="file" name="attachments[]" accept=".pdf,.doc,.docx,.jpg,.png,.txt">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Note</label>
                        <textarea name="attachmentNotes[]" rows="2" placeholder="Add a note for this attachment"></textarea>
                    </div>
                    <button type="button" class="btn btn-danger btn-small remove-attachment" style="margin-top: 25px;">Remove</button>
                `;
                attachmentsContainer.appendChild(newAttachmentRow);
            });

            // Remove Attachment functionality
            attachmentsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-attachment')) {
                    e.target.closest('.attachment-row').remove();
                }
            });
    

        

        // Send Approval Request button functionality
        const sendApprovalRequestBtn = document.getElementById('sendApprovalRequest');
        sendApprovalRequestBtn.addEventListener('click', async function() {
            const form = document.getElementById('TradeQuotationForm');
            const formData = new FormData(form);
            console.log("newy", formData);

            // Collect items data
            const items = [];
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const item = {
                    partNo: row.querySelector('input[name="itemPartNo[]"]').value,
                    description: row.querySelector('input[name="itemDescription[]"]').value,
                    hsn: row.querySelector('input[name="itemHSN[]"]').value,
                    gst: parseFloat(row.querySelector('input[name="itemGST[]"]').value) || 0,
                    quantity: parseFloat(row.querySelector('input[name="itemQuantity[]"]').value) || 0,
                    unit: row.querySelector('input[name="itemUnit[]"]').value,
                    unitPrice: parseFloat(row.querySelector('input[name="itemPrice[]"]').value) || 0,
                    discount: parseFloat(row.querySelector('input[name="itemDiscount[]"]').value) || 0,
                    total: parseFloat(row.querySelector('input[name="itemTotal[]"]').value) || 0
                };
                items.push(item);
            });

            formData.append('items', JSON.stringify(items));
            formData.append('status', 'pending');
            console.log("Sending approval request with dataaaaaaaaaa:", items);

            try {
                const response = await fetch('/api/send-quotation-approval', {
                    method: 'POST',
                    body: formData,
                    
                });
                console.log("Response:", response);

                if (response.ok) {
                    const result = await response.json();
                    alert('Approval request sent successfully! MD will review your quotation.');
                    // Reset form or redirect as needed
                } else {
                    const error = await response.json();
                    alert('Error sending approval request: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending approval request:', error);
                alert('Error sending approval request. Please try again.');
            }
        });

        // VK Send Approval Request button functionality
        const vkRaiseRequestBtn = document.getElementById('raiseRequest');
        vkRaiseRequestBtn.addEventListener('click', async function() {
            const form = document.getElementById('quotationForm');
            const formData = new FormData(form);

            // Collect VK specific data
            const pvAdaptors = [];
            document.querySelectorAll('#pvTableBody tr').forEach(row => {
                const adaptor = {
                    qty: parseFloat(row.querySelector('input[name="pvQty[]"]').value) || 0,
                    familyName: row.querySelector('textarea[name="pvFamilyName[]"]').value,
                    revNo: row.querySelector('input[name="pvRevNo[]"]').value,
                    coaxialPin: row.querySelector('input[name="pvCoaxialPin[]"]').value,
                    sokCard: row.querySelector('input[name="pvSokCard[]"]').value,
                    sokQty: parseFloat(row.querySelector('input[name="pvSokQty[]"]').value) || 0,
                    rate: parseFloat(row.querySelector('input[name="pvRate[]"]').value) || 0
                };
                pvAdaptors.push(adaptor);
            });

            const kietCosts = [];
                document.querySelectorAll('#vk .kiet-table tbody tr').forEach((row, index) => {
                    if (index < 4) { // First 4 rows are the main items
                        const description = row.querySelector('td:first-child').textContent.trim();
                        const cost = parseFloat(row.querySelector('input[name="priceInput[]"]').value) || 0;
                        const qty = parseFloat(row.querySelector('input[name="qtyInput[]"]').value) || 0;
                        const totalValue = cost * qty;

                        kietCosts.push({
                            description: description,
                            cost: cost,
                            qty: qty,
                            totalValue: totalValue
                        });
                    }
                });

            formData.append('pvAdaptors', JSON.stringify(pvAdaptors));
            formData.append('kietCosts', JSON.stringify(kietCosts));
            formData.append('status', 'pending');

            try {
                const response = await fetch('/api/send-vk-quotation-approval', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('VK quotation approval request sent successfully! MD will review your quotation.');
                    // Reset form or redirect as needed
                } else {
                    const error = await response.json();
                    alert('Error sending VK approval request: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending VK approval request:', error);
                alert('Error sending VK approval request. Please try again.');
            }
        });

        // Save Quotation button functionality
        const saveQuotationBtn = document.getElementById('saveQuotation');
        saveQuotationBtn.addEventListener('click', async function() {
            const form = document.getElementById('vkQuotationForm');
            const formData = new FormData(form);

            // Collect items data
            const items = [];
            document.querySelectorAll('#itemsTableBody tr').forEach(row => {
                const item = {
                    partNo: row.querySelector('input[name="itemPartNo[]"]').value,
                    description: row.querySelector('input[name="itemDescription[]"]').value,
                    hsn: row.querySelector('input[name="itemHSN[]"]').value,
                    gst: parseFloat(row.querySelector('input[name="itemGST[]"]').value) || 0,
                    quantity: parseFloat(row.querySelector('input[name="itemQuantity[]"]').value) || 0,
                    unit: row.querySelector('input[name="itemUnit[]"]').value,
                    unitPrice: parseFloat(row.querySelector('input[name="itemPrice[]"]').value) || 0,
                    discount: parseFloat(row.querySelector('input[name="itemDiscount[]"]').value) || 0,
                    total: parseFloat(row.querySelector('input[name="itemTotal[]"]').value) || 0
                };
                items.push(item);
            });

            formData.append('items', JSON.stringify(items));

            try {
                const response = await fetch('/api/save-quotation', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Quotation saved successfully! Quotation Number: ' + result.quotationNumber);
                    // Reset form or redirect as needed
                } else {
                    const error = await response.json();
                    alert('Error saving quotation: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving quotation:', error);
                alert('Error saving quotation. Please try again.');
            }
        });

        // Form submission with loading screen
        document.getElementById('vkQuotationForm').addEventListener('submit', function(e) {
            // Show loading screen
            document.getElementById('loadingOverlay').style.display = 'flex';
        });

        // MAE Form JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // MAE Quotation Number Generation
            const maeGenerateQuotationNumberBtn = document.getElementById('maeGenerateQuotationNumber');
            const maeQuotationNumberInput = document.getElementById('maeQuotationNumber');

            maeGenerateQuotationNumberBtn.addEventListener('click', function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}${month}${day}`;
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const quotationNumber = `MAE-${dateStr}-${randomNum}`;
                maeQuotationNumberInput.value = quotationNumber;
            });

            // MAE Reference Number Generation
            const maeGenerateReferenceNumberBtn = document.getElementById('maeGenerateReferenceNumber');
            const maeReferenceNoInput = document.getElementById('maeReferenceNo');

            maeGenerateReferenceNumberBtn.addEventListener('click', function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}${month}${day}`;
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const referenceNumber = `REF-MAE-${dateStr}-${randomNum}`;
                maeReferenceNoInput.value = referenceNumber;
            });

            // MAE Items Table Functionality
            const maeItemsTableBody = document.getElementById('maeItemsTableBody');
            const maeAddItemBtn = document.getElementById('maeAddItem');

            // Function to calculate item total
            function calculateMaeItemTotal(row) {
                const quantity = parseFloat(row.querySelector('input[name="itemQuantity[]"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="itemPrice[]"]').value) || 0;
                const gst = parseFloat(row.querySelector('input[name="itemGST[]"]').value) || 0;
                const discount = parseFloat(row.querySelector('input[name="itemDiscount[]"]').value) || 0;

                const subtotal = quantity * price;
                const discountAmount = subtotal * (discount / 100);
                const afterDiscount = subtotal - discountAmount;
                const gstAmount = afterDiscount * (gst / 100);
                const total = afterDiscount + gstAmount;

                row.querySelector('.item-total').textContent = total.toFixed(2);
                calculateMaeGrandTotal();
            }

            // Function to calculate grand total
            function calculateMaeGrandTotal() {
                let grandTotal = 0;
                document.querySelectorAll('#maeItemsTableBody .item-total').forEach(totalSpan => {
                    grandTotal += parseFloat(totalSpan.textContent) || 0;
                });
                document.getElementById('maeGrandTotal').textContent = grandTotal.toFixed(2);
            }

            // Function to attach calculation listeners to item row
            function attachMaeItemListeners(row) {
                const inputs = row.querySelectorAll('input[name="itemQuantity[]"], input[name="itemPrice[]"], input[name="itemGST[]"], input[name="itemDiscount[]"]');
                inputs.forEach(input => {
                    input.addEventListener('input', () => calculateMaeItemTotal(row));
                });
            }

            // Add new item row
            maeAddItemBtn.addEventListener('click', function() {
                const rowCount = maeItemsTableBody.querySelectorAll('tr').length + 1;
                const newRow = document.createElement('tr');
                newRow.className = 'mae-item-row';
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="text" name="itemPartNo[]" placeholder="Part No"></td>
                    <td><input type="text" class="item-description" name="itemDescription[]" placeholder="Item description" required></td>
                    <td><input type="text" name="itemHSN[]" placeholder="HSN Code"></td>
                    <td><input type="number" step="0.01" name="itemQuantity[]" placeholder="Qty" value="1" required></td>
                    <td><input type="text" name="itemUnit[]" placeholder="Unit" value="Nos"></td>
                    <td><input type="number" step="0.01" name="itemPrice[]" placeholder="Price" value="0" required></td>
                    <td><input type="number" step="0.01" name="itemGST[]" placeholder="GST %" value="18"></td>
                    <td><input type="number" step="0.01" name="itemDiscount[]" placeholder="Discount %" value="0"></td>
                    <td><span class="item-total">0.00</span></td>
                    <td><button type="button" class="btn btn-danger btn-small mae-remove-item">Remove</button></td>
                `;
                maeItemsTableBody.appendChild(newRow);
                attachMaeItemListeners(newRow);
                updateMaeRowNumbers();
            });

            // Remove item functionality
            maeItemsTableBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('mae-remove-item')) {
                    const row = e.target.closest('tr');
                    if (document.querySelectorAll('#maeItemsTableBody tr').length > 1) {
                        row.remove();
                        updateMaeRowNumbers();
                        calculateMaeGrandTotal();
                    } else {
                        alert('You must have at least one item in your quotation.');
                    }
                }
            });

            // Update row numbers
            function updateMaeRowNumbers() {
                document.querySelectorAll('#maeItemsTableBody tr').forEach((row, index) => {
                    row.querySelector('td:first-child').textContent = index + 1;
                });
            }

            // Attach listeners to existing rows
            document.querySelectorAll('.mae-item-row').forEach(attachMaeItemListeners);

            // MAE Attachments functionality
            const maeAttachmentsContainer = document.getElementById('maeAttachmentsContainer');
            const maeAddAttachmentBtn = document.getElementById('maeAddAttachment');

            maeAddAttachmentBtn.addEventListener('click', function() {
                const newAttachmentRow = document.createElement('div');
                newAttachmentRow.className = 'attachment-row';
                newAttachmentRow.style = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
                newAttachmentRow.innerHTML = `
                    <div class="form-group" style="flex: 1;">
                        <label>Upload File</label>
                        <input type="file" name="attachments[]" accept=".pdf,.doc,.docx,.jpg,.png,.txt,.dwg,.xls,.xlsx">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Note</label>
                        <textarea name="attachmentNotes[]" rows="2" placeholder="Description of the attachment"></textarea>
                    </div>
                    <button type="button" class="btn btn-danger btn-small mae-remove-attachment" style="margin-top: 25px;">Remove</button>
                `;
                maeAttachmentsContainer.appendChild(newAttachmentRow);
            });

            // Remove attachment functionality
            maeAttachmentsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('mae-remove-attachment')) {
                    e.target.closest('.attachment-row').remove();
                }
            });

            // MAE Form submission
            document.getElementById('maeQuotationForm').addEventListener('submit', function(e) {
                document.getElementById('loadingOverlay').style.display = 'flex';
            });

            // MAE Preview button
            document.getElementById('maePreviewQuotation').addEventListener('click', function() {
                const form = document.getElementById('maeQuotationForm');
                form.action = '/preview';
                form.enctype = '';
                form.submit();
            });

            // MAE Send Approval Request
           

            // MAE Save Quotation
            document.getElementById('maeSaveQuotation').addEventListener('click', async function() {
                const form = document.getElementById('maeQuotationForm');
                const formData = new FormData(form);

                const items = [];
                document.querySelectorAll('#maeItemsTableBody tr').forEach(row => {
                    const item = {
                        partNo: row.querySelector('input[name="itemPartNo[]"]').value,
                        description: row.querySelector('input[name="itemDescription[]"]').value,
                        hsn: row.querySelector('input[name="itemHSN[]"]').value,
                        quantity: parseFloat(row.querySelector('input[name="itemQuantity[]"]').value) || 0,
                        unit: row.querySelector('input[name="itemUnit[]"]').value,
                        unitPrice: parseFloat(row.querySelector('input[name="itemPrice[]"]').value) || 0,
                        gst: parseFloat(row.querySelector('input[name="itemGST[]"]').value) || 0,
                        discount: parseFloat(row.querySelector('input[name="itemDiscount[]"]').value) || 0,
                        total: parseFloat(row.querySelector('.item-total').textContent) || 0
                    };
                    items.push(item);
                });

                formData.append('items', JSON.stringify(items));

                try {
                    const response = await fetch('/api/save-quotation', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        alert('MAE Quotation saved successfully! Quotation Number: ' + result.quotationNumber);
                    } else {
                        const error = await response.json();
                        alert('Error saving quotation: ' + (error.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error saving quotation:', error);
                    alert('Error saving quotation. Please try again.');
                }
            });

            // PV Family Modal functionality
            const pvFamilyModal = document.getElementById('pvFamilyModal');
            const closeBtn = document.querySelector('.close');
            const savePvFamilyBtn = document.getElementById('savePvFamily');
            let currentFamilyInput = null;
    
            function openPvFamilyModal(familyInput) {
                currentFamilyInput = familyInput;
                pvFamilyModal.style.display = 'block';
                // Clear modal fields
                document.getElementById('modalFamilyName').value = '';
                document.getElementById('modalCode').value = '';
                document.getElementById('modalRevType').value = '';
                document.getElementById('modalConfig').value = '';
                document.getElementById('modalSokCard').value = '';
                document.getElementById('modalpart_no').value = '';
            }
    
            function closePvFamilyModal() {
                pvFamilyModal.style.display = 'none';
                currentFamilyInput = null;
            }
    
            function savePvFamily() {
                if (currentFamilyInput) {
                    const pins = document.querySelector('#vk .qty-input[data-index="1"]').value;
                    const familyName = document.getElementById('modalFamilyName').value;
                    const code = document.getElementById('modalCode').value;
                    const revType = document.getElementById('modalRevType').value;
                    const config = document.getElementById('modalConfig').value;
                    const sokCard = document.getElementById('modalSokCard').value;
                    const part_no = document.getElementById('modalpart_no').value;
    
                    const formattedFamilyName = ` Wiring according to ${familyName} Code: - ${code} Rev-Type- ${revType}Config- ${config} \n PART NO.- ${part_no}\n Inc \n    ‚Ä¢ Hypertak parts and pins\n    ‚Ä¢ Wires and Wirings\n    `;
                    const formattedValue = `${formattedFamilyName}‚Ä¢ SOK CARD -${sokCard} \n As price agreement_Wiring_Class_${document.querySelector('#vk .class-select[data-index="1"]').value} \n Total no of pins - ${pins} Nos`;
    
                    currentFamilyInput.value = formattedValue;
                }
                closePvFamilyModal();
            }
    
            // Event listeners for family name inputs within VK tab
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('pv-family-input') && e.target.closest('#vk')) {
                    openPvFamilyModal(e.target);
                }
            });
    
            if (closeBtn) closeBtn.addEventListener('click', closePvFamilyModal);
    
            window.addEventListener('click', function(e) {
                if (e.target === pvFamilyModal) {
                    closePvFamilyModal();
                }
            });
    
            if (savePvFamilyBtn) savePvFamilyBtn.addEventListener('click', savePvFamily);

        });

        // PV Family Modal functionality (global scope) - removed duplicate

        // VK Form JavaScript - Initialize when VK tab is activated
        function initializeVKForm() {
            let currencySymbol = '‚Çπ';

            const vkQtyInputs = document.querySelectorAll('#vk .qty-input');
            const vkValueDisplays = document.querySelectorAll('#vk .value-display');
            const vkTotalCostsDisplay = document.getElementById('vk-total-costs');
            const vkClassSelects = document.querySelectorAll('#vk .class-select');
            const vkPvQtyInputs = document.querySelectorAll('#vk .pv-qty-input');
            const vkPvRateInputs = document.querySelectorAll('#vk .pv-rate-input');
            const vkPvValueDisplays = document.querySelectorAll('#vk .pv-value-display');
            const vkPvAdaptorQtyInputs = document.querySelectorAll('#vk .pv-adaptor-qty-input');
            const vkAddPvRowBtn = document.getElementById('vkAddPvRow');
            const vkPvTableBody = document.getElementById('vkPvTableBody');

            // Add PV Family Modal functionality
            const pvFamilyModal = document.getElementById('pvFamilyModal');
            const closeBtn = document.querySelector('.close');
            const savePvFamilyBtn = document.getElementById('savePvFamily');
            let currentFamilyInput = null;

            function openPvFamilyModal(familyInput) {
                currentFamilyInput = familyInput;
                pvFamilyModal.style.display = 'block';
                // Clear modal fields
                document.getElementById('modalFamilyName').value = '';
                document.getElementById('modalCode').value = '';
                document.getElementById('modalRevType').value = '';
                document.getElementById('modalConfig').value = '';
                document.getElementById('modalSokCard').value = '';
                document.getElementById('modalpart_no').value = '';
            }

            function closePvFamilyModal() {
                pvFamilyModal.style.display = 'none';
                currentFamilyInput = null;
            }

            function savePvFamily() {
                if (currentFamilyInput) {
                    const pins = document.querySelector('#vk .qty-input[data-index="1"]').value;
                    const familyName = document.getElementById('modalFamilyName').value;
                    const code = document.getElementById('modalCode').value;
                    const revType = document.getElementById('modalRevType').value;
                    const config = document.getElementById('modalConfig').value;
                    const sokCard = document.getElementById('modalSokCard').value;
                    const part_no = document.getElementById('modalpart_no').value;

                    const formattedFamilyName = ` Wiring according to ${familyName} Code: - ${code} Rev-Type- ${revType}Config- ${config} \n PART NO.- ${part_no}\n Inc \n    ‚Ä¢ Hypertak parts and pins\n    ‚Ä¢ Wires and Wirings\n    `;
                    const formattedValue = `${formattedFamilyName}‚Ä¢ SOK CARD -${sokCard} \n As price agreement_Wiring_Class_${document.querySelector('#vk .class-select[data-index="1"]').value} \n Total no of pins - ${pins} Nos`;

                    currentFamilyInput.value = formattedValue;
                }
                closePvFamilyModal();
            }
            
            // Event listeners for family name inputs within VK tab
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('pv-family-input') && e.target.closest('#vk')) {
                    openPvFamilyModal(e.target);
                }
            });

            if (closeBtn) closeBtn.addEventListener('click', closePvFamilyModal);

            window.addEventListener('click', function(e) {
                if (e.target === pvFamilyModal) {
                    closePvFamilyModal();
                }
            });

            if (savePvFamilyBtn) savePvFamilyBtn.addEventListener('click', savePvFamily);

            // Class prices for different quantities
            const originalPrices = [
                { class: 1, cost: 280.11 },
                { class: 2, cost: 213.33 },
                { class: 3, cost: 199.02 },
                { class: 4, cost: 190.01 },
                { class: 5, cost: 181.53 },
                { class: 6, cost: 175.17 },
                { class: 7, cost: 164.57 },
                { class: 8, cost: 161.39 },
                { class: 9, cost: 157.15 },
                { class: 10, cost: 157.15 },
                { class: 11, cost: 155.03 },
                { class: 12, cost: 153.00 }
            ];

            const qty2Prices = [
                { class: 1, cost: 276.62 },
                { class: 2, cost: 211.14 },
                { class: 3, cost: 197.12 },
                { class: 4, cost: 188.28 },
                { class: 5, cost: 179.97 },
                { class: 6, cost: 173.73 },
                { class: 7, cost: 163.34 },
                { class: 8, cost: 160.22 },
                { class: 9, cost: 158.14 },
                { class: 10, cost: 156.06 },
                { class: 11, cost: 153.99 },
                { class: 12, cost: 152.00 }
            ];

            const qtyAbove2Prices = [
                { class: 1, cost: 274.92 },
                { class: 2, cost: 210.08 },
                { class: 3, cost: 196.18 },
                { class: 4, cost: 187.44 },
                { class: 5, cost: 179.21 },
                { class: 6, cost: 173.03 },
                { class: 7, cost: 162.74 },
                { class: 8, cost: 159.66 },
                { class: 9, cost: 157.60 },
                { class: 10, cost: 155.54 },
                { class: 11, cost: 153.48 },
                { class: 12, cost: 151.50 }
            ];

            function updateValue(input, valueDisplay) {
                const cost = parseFloat(input.getAttribute('data-cost'));
                const qty = parseFloat(input.value) || 0;
                const value = cost * qty;
                valueDisplay.textContent = value.toFixed(2);
                return value;
            }

            function updateTotalCosts() {
                const rows = document.querySelectorAll('#vk .kiet-table tbody tr');
                let total = 0;
                for (let i = 0; i < 4; i++) { // Sum only the first 4 rows (components)
                    const display = rows[i].querySelector('.value-display');
                    if (display) {
                        total += parseFloat(display.textContent) || 0;
                    }
                }
                vkTotalCostsDisplay.textContent = total.toFixed(2);
            }
            console.log('sdfghsdf',vkClassSelects);
            console.log(vkQtyInputs);

            function updateClassCost(select) {
                const selectedOption = select.options[select.selectedIndex];
                const newCost = parseFloat(selectedOption.getAttribute('data-cost'));
                const index = select.getAttribute('data-index');
                const qtyInput = document.querySelector(`#vk .qty-input[data-index="${index}"]`);
                const valueDisplay = vkValueDisplays[index];
                const priceInputHidden = document.querySelector(`#vk .price-input-hidden[data-index="${index}"]`);

                qtyInput.setAttribute('data-cost', newCost);
                if (priceInputHidden) {
                    priceInputHidden.value = newCost.toFixed(2);
                }
                updateValue(qtyInput, valueDisplay);
                updateTotalCosts();
            }

            function getClassFromQty(qty) {
                if (qty >= 1 && qty <= 300) return 1;
                if (qty >= 301 && qty <= 500) return 2;
                if (qty >= 501 && qty <= 600) return 3;
                if (qty >= 601 && qty <= 700) return 4;
                if (qty >= 701 && qty <= 800) return 5;
                if (qty >= 801 && qty <= 900) return 6;
                if (qty >= 901 && qty <= 1100) return 7;
                if (qty >= 1101 && qty <= 1200) return 8;
                if (qty >= 1201 && qty <= 1300) return 9;
                if (qty >= 1301 && qty <= 1400) return 10;
                if (qty >= 1401 && qty <= 1500) return 11;
                return 12; // default for > 1500
            }

            function updateClassOptions() {
                const classSelect = document.querySelector('#vk .class-select[data-index="1"]');
                if (!classSelect) return;

                // Calculate total PV quantity for pricing
                const pvQtyInputs = document.querySelectorAll('#vk .pv-adaptor-qty-input');
                let totalPvQty = 0;
                pvQtyInputs.forEach(input => {
                    totalPvQty += parseFloat(input.value) || 0;
                });

                console.log('Total PV Qty:', totalPvQty);

                let prices;
                if (totalPvQty > 2) {
                    prices = qtyAbove2Prices;
                    console.log('Using qtyAbove2Prices');
                } else if (totalPvQty == 2) {
                    prices = qty2Prices;
                    console.log('Using qty2Prices');
                } else {
                    prices = originalPrices;
                    console.log('Using originalPrices');
                }

                // Store current selected value
                const currentValue = classSelect.value;

                classSelect.innerHTML = '';

                prices.forEach(price => {
                    const option = document.createElement('option');
                    option.value = price.class;
                    option.setAttribute('data-cost', price.cost);
                    option.textContent = `Class ${price.class} - ${currencySymbol} ${price.cost.toFixed(2)}`;
                    classSelect.appendChild(option);
                });

                // Get Hypertek qty and select class based on it
                const hypertekQtyInput = document.querySelector('#vk .qty-input[data-index="1"]');
                const hypertekQty = parseFloat(hypertekQtyInput.value) || 0;
                const selectedClass = getClassFromQty(hypertekQty);

                // Set the selected class if it exists in options, otherwise default to 2
                if (prices.some(price => price.class == selectedClass)) {
                    classSelect.value = selectedClass;
                    console.log('Set class value based on Hypertek qty:', selectedClass, 'for qty:', hypertekQty);
                } else {
                    classSelect.value = '2';
                    console.log('Set default class value: 2 (class not available in current price set)');
                }

                // Update the cost after changing options
                updateClassCost(classSelect);
                updateHypertekDescription();
            }

            

            function updatePvValue(qtyInput, rateInput, valueDisplay) {
                const qty = parseFloat(qtyInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const value = qty * rate;
                valueDisplay.textContent = value.toFixed(2);
                updatePvTotal();
            }

           

            function addPvRow() {
                const rowCount = vkPvTableBody.querySelectorAll('.pv-row').length + 1;
                const newRow = document.createElement('tr');
                newRow.className = 'pv-row';
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="number" step="0.01" name="pvQty[]" placeholder="Qty" class="pv-adaptor-qty-input" value="1"></td>
                    <td><textarea name="pvFamilyName[]" placeholder="Family Name" class="pv-family-input" readonly rows="2"></textarea></td>
                    <td><input type="text" name="pvRevNo[]" placeholder="Rev NO."></td>
                    <td><input type="text" name="pvCoaxialPin[]" placeholder="Coaxial Pin"></td>
                    <td><input type="text" name="pvSokCard[]" placeholder="SOK Card" class="pv-sok-card-input"></td>
                    <td><input type="number" step="0.01" name="pvSokQty[]" placeholder="Qty" class="pv-qty-input" value="0"></td>
                    <td><div style="display: flex; align-items: center;"><span class="currency-symbol">‚Çπ</span> <input type="number" step="0.01" name="pvRate[]" placeholder="Rate" class="pv-rate-input" value="0" readonly></div></td>
                    <td><span class="currency-symbol">‚Çπ</span> <span class="pv-value-display">0.00</span></td>
                `;
                vkPvTableBody.appendChild(newRow);

                const newQtyInput = newRow.querySelector('.pv-qty-input');
                const newRateInput = newRow.querySelector('.pv-rate-input');
                const newValueDisplay = newRow.querySelector('.pv-value-display');
                const newPvAdaptorQtyInput = newRow.querySelector('.pv-adaptor-qty-input');

                newQtyInput.addEventListener('input', function() {
                    updatePvValue(newQtyInput, newRateInput, newValueDisplay);
                });

                newRateInput.addEventListener('input', function() {
                    updatePvValue(newQtyInput, newRateInput, newValueDisplay);
                });

                newPvAdaptorQtyInput.addEventListener('input', function() {
                    updateClassOptions();
                });

                updateClassOptions();
                updatePvRates();
            }

            vkQtyInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const valueDisplay = input.closest('tr').querySelector('.value-display');
                    updateValue(input, valueDisplay);
                    updateTotalCosts();
                });
            });

            // Add event listener to qty input (data-index="1") to detect change and update class options
            const hypertekQtyInput = document.querySelector('#vk .qty-input[data-index="1"]');
            hypertekQtyInput.addEventListener('input', function() {
                updateClassOptions();
            });

            // Update class options when PV qty changes
            // This is already handled above, remove duplicate

            vkClassSelects.forEach(select => {
                select.addEventListener('change', function() {
                    console.log('Class select changed to:', this.value);
                    updateClassCost(this);
                    updateHypertekDescription();
                    updatePvRates();
                });
            });

            vkPvAdaptorQtyInputs.forEach((input, index) => {
                const rateInput = vkPvRateInputs[index];
                const valueDisplay = vkPvValueDisplays[index];
                input.addEventListener('input', function() {
                    updatePvValue(input, rateInput, valueDisplay);
                });
            });

            vkPvRateInputs.forEach((input, index) => {
                const qtyInput = vkPvAdaptorQtyInputs[index];
                const valueDisplay = vkPvValueDisplays[index];
                input.addEventListener('input', function() {
                    updatePvValue(qtyInput, input, valueDisplay);
                });
            });

            vkAddPvRowBtn.addEventListener('click', addPvRow);

            vkPvAdaptorQtyInputs.forEach(input => {
                input.addEventListener('input', function() {
                    console.log('PV qty input changed, updating class options');
                    updateClassOptions();
                });
            });

            const exportPriceInput = document.querySelector('#vk .price-input[data-index="export"]');
            const exportValueDisplay = exportPriceInput.closest('tr').querySelector('.value-display');
            exportPriceInput.addEventListener('input', function() {
                const value = parseFloat(this.value) || 0;
                exportValueDisplay.textContent = value.toFixed(2);
                updatePvRates();
            });

            const boxPriceInput = document.querySelector('#vk .price-input[data-index="box"]');
            const boxValueDisplay = boxPriceInput.closest('tr').querySelector('.value-display');
            boxPriceInput.addEventListener('input', function() {
                const value = parseFloat(this.value) || 0;
                boxValueDisplay.textContent = value.toFixed(2);
                updatePvRates();
            });

            // Update value display for Standard Housing price input
            const standardHousingPriceInput = document.querySelector('#vk .price-input[data-index="0"]');
            if (standardHousingPriceInput) {
                standardHousingPriceInput.addEventListener('input', function() {
                    const cost = parseFloat(this.value) || 0;
                    const qtyInput = this.closest('tr').querySelector('.qty-input');
                    const qty = parseFloat(qtyInput.value) || 0;
                    const value = cost * qty;
                    const valueDisplay = this.closest('tr').querySelector('.value-display');
                    valueDisplay.textContent = value.toFixed(2);
                    updateTotalCosts();
                });
            }

            // Update value display for SOK 10150 and Koaxial-Stift-Radial price inputs
            const sokPriceInput = document.querySelector('#vk .price-input[data-index="2"]');
            if (sokPriceInput) {
                sokPriceInput.addEventListener('input', function() {
                    const cost = parseFloat(this.value) || 0;
                    const qty = 1;
                    const value = cost * qty;
                    const valueDisplay = this.closest('tr').querySelector('.value-display');
                    valueDisplay.textContent = value.toFixed(2);
                    updateTotalCosts();
                });
            }

            const coaxialPriceInput = document.querySelector('#vk .price-input[data-index="3"]');
            if (coaxialPriceInput) {
                coaxialPriceInput.addEventListener('input', function() {
                    const cost = parseFloat(this.value) || 0;
                    const qty = 1;
                    const value = cost * qty;
                    const valueDisplay = this.closest('tr').querySelector('.value-display');
                    valueDisplay.textContent = value.toFixed(2);
                    updateTotalCosts();
                });
            }

            function updateSokDescription() {
                const sokCardInputs = document.querySelectorAll('#vk .pv-sok-card-input');
                const sokDescriptionInput = document.getElementById('vk-sok-description-input');
                let sokValue = '';
                sokCardInputs.forEach(input => {
                    if (input.value.trim()) {
                        sokValue = input.value.trim();
                    }
                });
                if (sokValue) {
                    sokDescriptionInput.value = `SOK ${sokValue}`;
                } else {
                    sokDescriptionInput.value = 'SOK 10150';
                }
            }

            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('pv-sok-card-input') && e.target.closest('#vk')) {
                    updateSokDescription();
                }
            });

            function updateHypertekDescription() {
                const classSelect = document.querySelector('#vk .class-select[data-index="1"]');
                const hypertekDescriptionInput = document.getElementById('vk-hypertek-description-input');
                if (classSelect && hypertekDescriptionInput) {
                    const selectedClass = classSelect.value;
                    hypertekDescriptionInput.value = `Hypertek parts and pins (Wiring class-${selectedClass})`;
                    console.log('Updated Hypertek description to class:', selectedClass);
                }
            }

            updateSokDescription();
            updateHypertekDescription();

            // Generate Quotation Number for VK
            const vkGenerateQuotationNumberBtn = document.getElementById('vkGenerateQuotationNumber');
            const vkQuotationNumberInput = document.getElementById('vkQuotationNumber');

            if (vkGenerateQuotationNumberBtn && vkQuotationNumberInput) {
                vkGenerateQuotationNumberBtn.addEventListener('click', async()=> {
                    
                        try {
                            const response = await fetch('/api/generate-vk-quotation-number');
                            if (response.ok) {
                                const data = await response.json();

                                 const famN = prompt('Enter Family Name'); // browser prompt
                      if (famN) {
                        // Modify the quotation number string
                        data.quotationNumber = data.quotationNumber.replace("VK-", `VK-${famN}-`);
                      }
                    
                      // Set the modified number in your input field
                      vkQuotationNumberInput.value = data.quotationNumber;
                                    


                                // vkQuotationNumberInput.value = data.quotationNumber;
                            } else {
                                console.error('Error fetching VK quotation number');
                                alert('Error generating quotation number. Please try again.');
                            }
                        } catch (error) {
                            console.error('Error fetching VK quotation number:', error);
                            alert('Error generating quotation number. Please try again.');
                        }
                    }
                )
            };

            // Generate Reference Number for VK
            const vkGenerateReferenceNumberBtn = document.getElementById('vkGenerateReferenceNumber');
            const vkReferenceNoInput = document.getElementById('vkReferenceNo');

            if (vkGenerateReferenceNumberBtn && vkReferenceNoInput) {
                vkGenerateReferenceNumberBtn.addEventListener('click', function() {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    const referenceNumber = `REF-${dateStr}-${randomNum}`;
                    vkReferenceNoInput.value = referenceNumber;
                });
            }

            updateTotalCosts();
            updateClassOptions();
            updatePvRates();

            const vkCurrencySelect = document.getElementById('currency');
            vkCurrencySelect.addEventListener('change', function() {
                currencySymbol = getCurrencySymbol(this.value);
                document.querySelectorAll('#vk .currency-symbol').forEach(span => span.textContent = currencySymbol);
                updateHeaderCurrency();
                updateClassOptions();
                updateTotalRowCurrency();
            });

            function updateHeaderCurrency() {
                const header = document.getElementById('totalValueHeader');
                if (header) {
                    header.textContent = `Total Value in ${vkCurrencySelect.value}`;
                }
            }

            function updateTotalRowCurrency() {
                const totalRowLabel = document.querySelector('#vk .total-row td strong');
                if (totalRowLabel) {
                    totalRowLabel.textContent = `Total costs in ${vkCurrencySelect.value} (qty of 1 No.)`;
                }
            }

            // Remove duplicate getCurrencySymbol function

            function getCurrencySymbol(currency) {
                switch (currency) {
                    case 'INR': return '‚Çπ';
                    case 'USD': return '$';
                    case 'EUR': return '‚Ç¨';
                    default: return '‚Çπ';
                }
            }

            // VK Send Approval Request button functionality
            document.getElementById('vkSendApprovalRequest').addEventListener('click', async function() {
                const form = document.getElementById('vkQuotationForm');
                const formData = new FormData(form);

                // Collect PV adaptors data
                const pvAdaptors = [];
                document.querySelectorAll('#vkPvTableBody .pv-row').forEach(row => {
                    const adaptor = {
                        qty: row.querySelector('.pv-adaptor-qty-input').value,
                        familyName: row.querySelector('.pv-family-input').value,
                        revNo: row.querySelector('input[name="pvRevNo[]"]').value,
                        coaxialPin: row.querySelector('input[name="pvCoaxialPin[]"]').value,
                        sokCard: row.querySelector('.pv-sok-card-input').value,
                        sokQty: row.querySelector('.pv-qty-input').value,
                        rate: row.querySelector('.pv-rate-input').value
                    };
                    pvAdaptors.push(adaptor);
                });

                // Collect KIET costs data
                const kietCosts = [];
                document.querySelectorAll('#vk .kiet-table tbody tr').forEach(row => {
                    if (!row.classList.contains('total-row')) {
                        const descriptionCell = row.cells[0];
                        let description = descriptionCell.textContent.trim();
                        const input = descriptionCell.querySelector('input[name="itemDescription[]"]');
                        if (input) {
                            description = input.value;
                        }
                        let cost = '0';
                        const qtyInput = row.querySelector('.qty-input');
                        if (qtyInput) {
                            cost = qtyInput.getAttribute('data-cost') || '0';
                        } else {
                            const priceInput = row.querySelector('.price-input');
                            if (priceInput) {
                                cost = priceInput.value;
                            }
                        }
                        const costItem = {
                            description: description,
                            cost: cost,
                            qty: row.querySelector('.qty-input') ? row.querySelector('.qty-input').value : '1',
                            totalValue: row.querySelector('.value-display') ? row.querySelector('.value-display').textContent : '0'
                        };
                        kietCosts.push(costItem);
                    }
                });

                formData.append('pvAdaptors', JSON.stringify(pvAdaptors));
                formData.append('kietCosts', JSON.stringify(kietCosts));
                formData.append('status', 'pending_approval');

                try {
                    const response = await fetch('/api/send-vk-quotation-approval', {
                        method: 'POST',
                        body: formData
                    });
                    console.log('Response from approval request:', response);

                    if (response.ok) {
                        const result = await response.json();
                        alert('VK Quotation approval request sent successfully! MD will review your quotation.');
                        // Reset form or redirect as needed
                    } else {
                        const error = await response.json();
                        alert('Error sending approval request: ' + (error.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error sending approval request:', error);
                    alert('Error sending approval request. Please try again.');
                }
            });

            // VK Form submission
            document.getElementById('vkQuotationForm').addEventListener('submit', function(e) {
                // Show loading screen
                document.getElementById('loadingOverlay').style.display = 'flex';
            });

        }

        // Initialize VK form when VK tab becomes active
        function checkVKTabActivation() {
            const vkTab = document.getElementById('vk');
            if (vkTab && vkTab.classList.contains('active') && !vkTab.hasAttribute('data-initialized')) {
                initializeVKForm();
                vkTab.setAttribute('data-initialized', 'true');
            }
        }

        // VK KIET Table Dynamic Calculation Functions
        function updateValue(input, valueDisplay) {
            const cost = parseFloat(input.getAttribute('data-cost'));
            const qty = parseFloat(input.value) || 0;
            const value = cost * qty;
            valueDisplay.textContent = value.toFixed(2);
            return value;
        }

        function updateTotalCosts() {
            const rows = document.querySelectorAll('#vk .kiet-table tbody tr');
            let total = 0;
            for (let i = 0; i < 4; i++) { // Sum only the first 4 rows (components)
                const display = rows[i].querySelector('.value-display');
                if (display) {
                    total += parseFloat(display.textContent) || 0;
                }
            }
            const totalCostsDisplay = document.getElementById('vk-total-costs');
            if (totalCostsDisplay) {
                totalCostsDisplay.textContent = total.toFixed(2);
            }
        }

        function updateClassCost(select) {
            const selectedOption = select.options[select.selectedIndex];
            const newCost = parseFloat(selectedOption.getAttribute('data-cost'));
            const index = select.getAttribute('data-index');
            const qtyInput = document.querySelector(`#vk .qty-input[data-index="${index}"]`);
            const valueDisplay = document.querySelector(`#vk .value-display[data-index="${index}"]`);
            const priceInputHidden = document.querySelector(`#vk .price-input-hidden[data-index="${index}"]`);

            qtyInput.setAttribute('data-cost', newCost);
            if (priceInputHidden) {
                priceInputHidden.value = newCost.toFixed(2);
            }
            updateValue(qtyInput, valueDisplay);
            updateTotalCosts();
        }

        function getClassFromQty(qty) {
            if (qty >= 1 && qty <= 300) return 1;
            if (qty >= 301 && qty <= 500) return 2;
            if (qty >= 501 && qty <= 600) return 3;
            if (qty >= 601 && qty <= 700) return 4;
            if (qty >= 701 && qty <= 800) return 5;
            if (qty >= 801 && qty <= 900) return 6;
            if (qty >= 901 && qty <= 1100) return 7;
            if (qty >= 1101 && qty <= 1200) return 8;
            if (qty >= 1201 && qty <= 1300) return 9;
            if (qty >= 1301 && qty <= 1400) return 10;
            if (qty >= 1401 && qty <= 1500) return 11;
            return 12;
        }

        function updateClassOptions() {
            const classSelect = document.querySelector('#vk .class-select[data-index="1"]');
            if (!classSelect) return;

            const pvQtyInputs = document.querySelectorAll('#vk .pv-adaptor-qty-input');
            let totalPvQty = 0;
            pvQtyInputs.forEach(input => {
                totalPvQty += parseFloat(input.value) || 0;
            });

            let prices;
            if (totalPvQty > 2) {
                prices = qtyAbove2Prices;
            } else if (totalPvQty == 2) {
                prices = qty2Prices;
            } else {
                prices = originalPrices;
            }

            classSelect.innerHTML = '';

            prices.forEach(price => {
                const option = document.createElement('option');
                option.value = price.class;
                option.setAttribute('data-cost', price.cost);
                option.textContent = `Class ${price.class} - ${currencySymbol} ${price.cost.toFixed(2)}`;
                classSelect.appendChild(option);
            });

            const hypertekQtyInput = document.querySelector('#vk .qty-input[data-index="1"]');
            const hypertekQty = parseFloat(hypertekQtyInput.value) || 0;
            const selectedClass = getClassFromQty(hypertekQty);

            if (prices.some(price => price.class == selectedClass)) {
                classSelect.value = selectedClass;
            } else {
                classSelect.value = '2';
            }

            updateClassCost(classSelect);
            updateHypertekDescription();
        }

    function updatePvRates() {
    const totalCostsEl = document.querySelector('#vk-total-costs');
    const totalCosts = parseFloat(totalCostsEl?.textContent || '0') || 0;

    const exportInput = document.querySelector('.price-input[data-index="export"]');

    const boxInput = document.querySelector('.price-input[data-index="box"]');

    const exportValue = parseFloat(
        exportInput?.closest('tr')?.querySelector('.value-display')?.textContent || '0'
    ) || 0;

    const boxValue = parseFloat(
        boxInput?.closest('tr')?.querySelector('.value-display')?.textContent || '0'
    ) || 0;

    const totalRate = totalCosts + exportValue + boxValue;
// Calculate total PV qty
    const pvQtyInputs = document.querySelectorAll('.pv-adaptor-qty-input');
    let totalPvQty = 0;

    pvQtyInputs.forEach(input => {
        totalPvQty += parseFloat(input.value) || 0;
    });

    if (totalPvQty === 0) return;

    const unitRate = totalRate * totalPvQty;

    document.querySelectorAll('.pv-rate-input').forEach(input => {
        input.value = unitRate.toFixed(2);

        const row = input.closest('tr');
        if (!row) return;

        const qtyInput = row.querySelector('.pv-adaptor-qty-input');
        const valueDisplay = row.querySelector('.pv-value-display');

        if (qtyInput && valueDisplay) {
            updatePvValue(qtyInput, input, valueDisplay);
        }
    });
}


        function updatePvValue(qtyInput, rateInput, valueDisplay) {
            const qty = parseFloat(qtyInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            const value = qty * rate;
            valueDisplay.textContent = value.toFixed(2);
            console.log('Updated PV Value:', value.toFixed(2), 'for Qty:', qty, 'Rate:', rate);
            updatePvTotal();
            updatePvRates();
            

            

            
        }

        function updatePvTotal() {
            const pvValueDisplays = document.querySelectorAll('#vk .pv-value-display');
            let total = 0;
            pvValueDisplays.forEach(display => {
                total += parseFloat(display.textContent) || 0;
            });
            const pvTotalAmount = document.getElementById('vk-pv-total-amount');
            if (pvTotalAmount) {
                pvTotalAmount.textContent = total.toFixed(2);
            }
            updatePvRates()
        

        }

        function addPvRow() {
            const vkPvTableBody = document.getElementById('vkPvTableBody');
            if (!vkPvTableBody) return;

            const rowCount = vkPvTableBody.querySelectorAll('.pv-row').length + 1;
            const newRow = document.createElement('tr');
            newRow.className = 'pv-row';
            newRow.innerHTML = `
                <td>${rowCount}</td>
                <td><input type="number" step="0.01" name="pvQty[]" placeholder="Qty" class="pv-adaptor-qty-input" value="1"></td>
                <td><textarea name="pvFamilyName[]" placeholder="Family Name" class="pv-family-input" readonly rows="2"></textarea></td>
                <td><input type="text" name="pvRevNo[]" placeholder="Rev NO."></td>
                <td><input type="text" name="pvCoaxialPin[]" placeholder="Coaxial Pin"></td>
                <td><input type="text" name="pvSokCard[]" placeholder="SOK Card" class="pv-sok-card-input"></td>
                <td><input type="number" step="0.01" name="pvSokQty[]" placeholder="Qty" class="pv-qty-input" value="0"></td>
                <td><div style="display: flex; align-items: center;"><span class="currency-symbol">${currencySymbol}</span> <input type="number" step="0.01" name="pvRate[]" placeholder="Rate" class="pv-rate-input" value="0" readonly></div></td>
                <td><span class="currency-symbol">${currencySymbol}</span> <span class="pv-value-display">0.00</span></td>
            `;
            vkPvTableBody.appendChild(newRow);

            const newQtyInput = newRow.querySelector('.pv-qty-input');
            const newRateInput = newRow.querySelector('.pv-rate-input');
            const newValueDisplay = newRow.querySelector('.pv-value-display');
            const newPvAdaptorQtyInput = newRow.querySelector('.pv-adaptor-qty-input');

            newQtyInput.addEventListener('input', function() {
                updatePvValue(newQtyInput, newRateInput, newValueDisplay);
                updatePvRates();
            });
            

            newRateInput.addEventListener('input', function() {
                updatePvValue(newQtyInput, newRateInput, newValueDisplay);
            });

            newPvAdaptorQtyInput.addEventListener('input', function() {
                updateClassOptions();
                
            });

            updateClassOptions();
            updatePvRates();
        }

        function updateSokDescription() {
            const sokCardInputs = document.querySelectorAll('#vk .pv-sok-card-input');
            const sokDescriptionInput = document.getElementById('vk-sok-description-input');
            if (!sokDescriptionInput) return;

            let sokValue = '';
            sokCardInputs.forEach(input => {
                if (input.value.trim()) {
                    sokValue = input.value.trim();
                }
            });
            if (sokValue) {
                sokDescriptionInput.value = `SOK ${sokValue}`;
            } else {
                sokDescriptionInput.value = 'SOK 10150';
            }
        }

        function updateHypertekDescription() {
            const classSelect = document.querySelector('#vk .class-select[data-index="1"]');
            const hypertekDescriptionInput = document.getElementById('vk-hypertek-description-input');
            if (classSelect && hypertekDescriptionInput) {
                const selectedClass = classSelect.value;
                hypertekDescriptionInput.value = `Hypertek parts and pins (Wiring class-${selectedClass})`;
            }
        }

        // Check for VK tab activation on submenu clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('.submenu-item[data-tab="vk"]')) {
                // Use requestAnimationFrame to ensure DOM updates are complete
                requestAnimationFrame(checkVKTabActivation);
            }
        });

        // Also check when tab becomes visible (for direct navigation)
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const vkTab = document.getElementById('vk');
                    if (vkTab && vkTab.classList.contains('active') && !vkTab.hasAttribute('data-initialized')) {
                        setTimeout(initializeVKForm, 100);
                        vkTab.setAttribute('data-initialized', 'true');
                    }
                }
            });
        });

        // Observe the VK tab for class changes
        const vkTabElement = document.getElementById('vk');
        if (vkTabElement) {
            observer.observe(vkTabElement, { attributes: true, attributeFilter: ['class'] });
        }

        // Initialize VK form immediately if tab is already active
        checkVKTabActivation();

        // VK Add Attachment functionality
        const vkAddAttachmentBtn = document.getElementById('vkAddAttachment');
        const vkAttachmentsContainer = document.getElementById('vkAttachmentsContainer');

        vkAddAttachmentBtn.addEventListener('click', function() {
            const newAttachmentRow = document.createElement('div');
            newAttachmentRow.className = 'attachment-row';
            newAttachmentRow.style = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            newAttachmentRow.innerHTML = `
                <div class="form-group" style="flex: 1;">
                    <label>Upload File</label>
                    <input type="file" name="attachments[]" accept=".pdf,.doc,.docx,.jpg,.png,.txt,.dwg,.xls,.xlsx">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Note</label>
                    <textarea name="attachmentNotes[]" rows="2" placeholder="Description of the attachment"></textarea>
                </div>
                <button type="button" class="btn btn-danger btn-small vk-remove-attachment" style="margin-top: 25px;">Remove</button>
            `;
            vkAttachmentsContainer.appendChild(newAttachmentRow);
        });

        // VK Remove Attachment functionality
        vkAttachmentsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('vk-remove-attachment')) {
                e.target.closest('.attachment-row').remove();
            }
        });

        

    </script>

   

    <script>
        
document.addEventListener('DOMContentLoaded', function() {
            // Generate Quotation Number
            const generateQuotationNumberBtn = document.getElementById('generateQuotationNumber');
            const quotationNumberInput = document.getElementById('quotationNumber');

            generateQuotationNumberBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/generate-quotation-number');
                    if (response.ok) {
                        const data = await response.json();
                        quotationNumberInput.value = data.quotationNumber;
                    } else {
                        // Fallback to client-side generation
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        const dateStr = `${year}${month}${day}`;
                        const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                        const quotationNumber = `TRADE-${dateStr}-${randomNum}`;
                        quotationNumberInput.value = quotationNumber;
                    }
                } catch (error) {
                    console.error('Error generating quotation number:', error);
                    // Fallback to client-side generation
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    const quotationNumber = `TRADE-${dateStr}-${randomNum}`;
                    quotationNumberInput.value = quotationNumber;
                }
            });

            // Generate Reference Number
            const generateReferenceNumberBtn = document.getElementById('generateReferenceNumber');
            const referenceNoInput = document.getElementById('referenceNo');

            generateReferenceNumberBtn.addEventListener('click', function() {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}${month}${day}`;
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const referenceNumber = `REF-${dateStr}-${randomNum}`;
                referenceNoInput.value = referenceNumber;
            });
        

            // Add Item functionality
            const addItemBtn = document.getElementById('addItem');
            const itemsTableBody = document.getElementById('itemsTableBody');

            addItemBtn.addEventListener('click', function() {
                const newRow = document.createElement('tr');
                newRow.className = 'item-row';
                newRow.innerHTML = `
                    <td><input type="text" name="itemPartNo[]" placeholder="Part No"></td>
                    <td><input type="text" class="item-description" name="itemDescription[]" placeholder="Item or service description" required></td>
                    <td><input type="text" name="itemHSN[]" placeholder="HSN Code"></td>
                    <td><input type="number" step="0.01" name="itemQuantity[]" placeholder="Qty" required></td>
                    <td><input type="text" name="itemUnit[]" placeholder="Unit" value="Nos"></td>
                    <td><input type="number" step="0.01" name="itemPrice[]" placeholder="Price" required></td>
                    <td><input type="number" step="0.01" name="itemTotal[]" placeholder="Total" readonly style="background-color: #f0f0f0;"></td>
                    <td><button type="button" class="btn btn-danger btn-small remove-item">Remove</button></td>
                `;
                itemsTableBody.appendChild(newRow);
                attachCalculationListeners(newRow);
            });

            // Remove Item functionality
            itemsTableBody.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    e.target.closest('tr').remove();
                    calculateGrandTotal();
                }
            });

            // Function to attach calculation listeners to a row
            function attachCalculationListeners(row) {
                const quantityInput = row.querySelector('input[name="itemQuantity[]"]');
                const priceInput = row.querySelector('input[name="itemPrice[]"]');
                
                const totalInput = row.querySelector('input[name="itemTotal[]"]');

                function calculateRowTotal() {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                   

                    const subtotal = quantity * price;
                    
                    const total = subtotal;

                    totalInput.value = total.toFixed(2);
                    calculateGrandTotal();
                }

                quantityInput.addEventListener('input', calculateRowTotal);
                priceInput.addEventListener('input', calculateRowTotal);
                
            }

            // Attach listeners to existing rows
            document.querySelectorAll('.item-row').forEach(attachCalculationListeners);

            // Function to calculate grand total
            function calculateGrandTotal() {
                const totalInputs = document.querySelectorAll('input[name="itemTotal[]"]');
                let grandTotal = 0;
                totalInputs.forEach(input => {
                    grandTotal += parseFloat(input.value) || 0;
                });
                document.getElementById('tradeGrandTotal').value = grandTotal.toFixed(2);
            }
            let activeInput = null; // stores the input clicked

// When clicking the item description input = OPEN POPUP



// Open popup when clicking item description input
document.addEventListener("click", function(event) {
    if (event.target.classList.contains("item-descriptin")) {
        activeInput = event.target;
        openPopup();
    }
});

function openPopup() {
    document.getElementById("popupModal").style.display = "block";
    document.getElementById("mainHeading").value = "";
    document.getElementById("subpointsContainer").innerHTML = "";
}

// Close popup
document.querySelector(".closeBtn").onclick = () => {
    document.getElementById("popupModal").style.display = "none";
};

window.onclick = (e) => { 
    if (e.target === document.getElementById("popupModal")) {
        document.getElementById("popupModal").style.display = "none";
    }
};

// Add Subpoint
document.getElementById("addSubpointBtn").onclick = () => {
    const div = document.createElement("div");
    div.classList.add("subpointBox");

    div.innerHTML = `
        <label>Subpoint Title:</label>
        <input type="text" class="subTitle" placeholder="Enter subpoint">

        <div class="bulletsContainer"></div>
        <button type="button" class="addBulletBtn">+ Add Bullet</button>
    `;

    // Add Bullet event
    div.querySelector(".addBulletBtn").onclick = () => {
        const bullet = document.createElement("input");
        bullet.type = "text";
        bullet.placeholder = "Enter bullet";
        bullet.classList.add("bullet");
        div.querySelector(".bulletsContainer").appendChild(bullet);
    };

    document.getElementById("subpointsContainer").appendChild(div);
};

// SAVE
document.getElementById("saveBtn").onclick = () => {
    let text = "";
    const mainHeading = document.getElementById("mainHeading").value.trim();

    if (mainHeading) text += mainHeading + "\n";

    document.querySelectorAll(".subpointBox").forEach(sub => {
        const title = sub.querySelector(".subTitle").value.trim();

        if (title) text += "\t" + title + "\n";

        sub.querySelectorAll(".bullet").forEach(b => {
            const value = b.value.trim();
            if (value) text += "\t\t‚Ä¢ " + value + "\n";
        });

        text += "\n";
    });

    if (activeInput) activeInput.value = text.trim();

    document.getElementById("popupModal").style.display = "none";
};

           
        });
        async function generate_mae(){

            const num= await fetch("/generate_quotation_mae");
            if (!num.ok) throw new Error("Failed to fetch generate_quotation_mae");

            let generate_qt_num = await num.json();
            let prefix= prompt('Enter the project code to add prefix of quotation number');
            let final_qt=prefix+"-"+generate_qt_num.quotation_number;
            alert('generate quotation number is ' +final_qt );
            document.querySelector('#maeQuotationNumber').value=final_qt;
            
            
        }
async function previewmae() {
    const form = document.getElementById("maeQuotationForm");
    if (tinymce.get("editor")) {
        tinymce.triggerSave();
    }
    
    const formData = new FormData(form);
    console.log('oke dfs',formData)

    try {
        const response = await fetch("/preview", {
            method: "POST",
            body: formData
            
        });
        console.log('response',response);

        if (!response.ok) throw new Error("Preview failed");

        const blob = await response.blob();
        const pdfUrl = URL.createObjectURL(blob);

        // Load preview into iframe modal
        const iframe = document.getElementById("previewFrame");
        iframe.src = pdfUrl + "#toolbar=0&navpanes=0&scrollbar=0";

        document.getElementById("previewModal").style.display = "block";
    } catch (err) {
        console.error("Preview Error:", err);
    }
}
document.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && (e.key === "s" || e.key === "p")) {
        e.preventDefault();
    }
});


//submitting task
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    const email = document.getElementById("userEmail").value;
    const storageKey = `taskSubmitted_${email}`;

    // üëá Only show popup if NOT submitted today
    if (localStorage.getItem(storageKey) !== today) {
      document.getElementById("taskModal").style.display = "flex";
    }

    // Auto date
    document.getElementById("taskDate").value = today;
  });

  function submitTask() {
    const task = document.getElementById("taskDesc").value.trim();
    if (!task) {
      alert("Please enter your task");
      return;
    }

    const today = new Date().toISOString().split("T")[0];
    const email = document.getElementById("userEmail").value;
    const storageKey = `taskSubmitted_${email}`;

    // ‚ùå Already submitted today
    if (localStorage.getItem(storageKey) === today) {
      alert("Task already submitted today");
      return;
    }

    fetch("/api/work-log", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email,
        task_description: task,
       
        module: "procurement"
      })
    })
    .then(() => {
      // ‚úÖ Mark as submitted today
      localStorage.setItem(storageKey, today);
      document.getElementById("taskModal").style.display = "none";
    });
  }


    </script>
</body>
</html>

