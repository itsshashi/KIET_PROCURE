<!DOCTYPE html>
<html>
<head>
  <title>Face Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-100 p-6">

<div class="max-w-5xl mx-auto bg-white p-6 rounded shadow">

<h1 class="text-3xl font-bold text-center mb-6">ðŸ“· Face Attendance</h1>

<div class="grid grid-cols-2 gap-6">

<!-- REGISTER -->
<div class="text-center">
  <h2 class="font-semibold mb-2">Register Face</h2>
  <input id="empId" placeholder="Employee ID" class="border p-2 w-full mb-2">
  <input id="name" placeholder="Name" class="border p-2 w-full mb-2">
  <video id="v1" autoplay class="mx-auto border"></video>
<canvas id="c1" width="320" height="240" class="hidden"></canvas>


 <button
  type="button"
  onclick="register()"
  class="bg-green-600 text-white px-4 py-2 rounded">
  Register Attendance
</button>


</div>

<!-- SCAN -->
<div class="text-center">
  <h2 class="font-semibold mb-2">Scan Attendance</h2>
  <video id="v2" autoplay class="mx-auto border"></video>
  <canvas id="c2" width="320" height="240" class="hidden"></canvas>
  <button onclick="scan()" class="bg-green-600 text-white px-4 py-2 mt-2">
    Scan
  </button>
  <p id="status" class="mt-2"></p>
</div>

</div>

<hr class="my-6">

<table class="w-full text-center border">
  <thead class="bg-gray-200">
    <tr>
      <th>Emp ID</th><th>Date</th><th>Time</th><th>Status</th><th>location</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

</div>

<script>

const empId = document.getElementById("empId");
const nameInput = document.getElementById("name");
const status = document.getElementById("status");
const rows = document.getElementById("rows");

const v1 = document.getElementById("v1");
const v2 = document.getElementById("v2");

// Start camera
navigator.mediaDevices.getUserMedia({ video: true })
  .then(s => { v1.srcObject = s; v2.srcObject = s; });

// Helper: get current location
function getLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return resolve({ lat: null, lng: null });
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      err => resolve({ lat: null, lng: null })
    );
  });
}

// REGISTER FACE + LOCATION
async function register() {
  if (!empId.value || !nameInput.value) {
    alert("Enter Employee ID and Name");
    return;
  }

  const loc = await getLocation(); // get location

  const c = document.getElementById("c1");
  const ctx = c.getContext("2d");
  ctx.drawImage(v1, 0, 0, 320, 240);

  const res = await fetch("/api/register-face", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      empId: empId.value,
      name: nameInput.value,
      image: c.toDataURL("image/jpeg"),
      location: loc // send lat & lng
    })
  });

  const data = await res.json();
  alert(data.message);
}

// SCAN + LOCATION
async function scan() {
  const loc = await getLocation(); // get location

  const c = document.getElementById("c2");
  c.getContext("2d").drawImage(v2,0,0,320,240);

  const r = await fetch("/api/scan", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      image: c.toDataURL(),
      location: loc // send lat & lng
    })
  });

  const d = await r.json();
  status.innerText = d.success
    ? `âœ… ${d.empId} (${d.status}) at [${loc.lat?.toFixed(5)}, ${loc.lng?.toFixed(5)}]`
    : "âŒ Not recognized";

  load();
}

// LOAD ATTENDANCE HISTORY

async function load() {
  const r = await fetch("/api/history");
  const data = await r.json();

  rows.innerHTML = data.map(x =>
    `<tr class="border-t">
      <td>${x.emp_id}</td>
      <td>${x.date}</td>
      <td>${x.time_in}</td>
      <td>${x.status}</td>
      <td>${x.location || '-'}</td>
    </tr>`
  ).join("");
}

load();

</script>



</body>
</html>
